<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>主页面(old)</title>
	<!--基本样式-->
    <link href="{virtualPath}/css/common.css?ver=2.0.3" rel="stylesheet" />
    <!--加载dhx组件-->
    <link href="{virtualPath}/lib/ext-3.4/resources/css/ext-all.css?ver=2.0.3" rel="stylesheet" />
   
    <link href="{virtualPath}/design/css/icons.css?ver=2.0.3" rel="stylesheet" />

	<link href="{virtualPath}/lib/dhtmlx/dhtmlx.css?ver=2.0.3" rel="stylesheet" />
	  <!--样式快捷索引表-->
    <link href="{virtualPath}/css/shortcut.css?ver=2.0.3" rel="stylesheet" />
    
    <script src="{virtualPath}/lib/labjs/LAB.min.js?ver=2.0.3"></script>
    <script src="{virtualPath}/config.js?ver=2.0.3"></script>
    <script src="{virtualPath}/lib/ext-3.4/adapter/ext/ext-base-debug.js?ver=2.0.3"></script>
    <script src="{virtualPath}/lib/ext-3.4/adapter/ext/ext-base-lang.js?ver=2.0.3"></script>
    <script src="{virtualPath}/lib/ext-3.4/adapter/ext/ext-base-class.js?ver=2.0.3"></script>
    <script src="{virtualPath}/lib/ext-3.4/ext-all-debug.js?ver=2.0.3"></script>
    <script src="{virtualPath}/lib/ext-3.4/src/locale/ext-lang-zh_CN.js?ver=2.0.3"></script>
    <script src="{virtualPath}/js/util.js?ver=2.0.3"></script>
    <script src="{virtualPath}/lib/dhtmlx/dhtmlx.js?ver=2.0.3"></script>
	<script src="{virtualPath}/report/dhtmlx/dhtmlxCommon/codebase/dhtmlxcommon.js?ver=2.0.3"></script>
	<script src="{virtualPath}/report/dhtmlx/dhtmlxCommon/codebase/dhtmlxcore.js?ver=2.0.3"></script>
    <script src="{virtualPath}/report/dhtmlx/dhtmlxCommon/codebase/dhtmlxcontainer.js?ver=2.0.3"></script>
	<script src="{virtualPath}/report/FillReport2.0/js/dhtmlx/dhtmlXFileUploader.js?ver=2.0.3"></script>
    <script src="{virtualPath}/js/hwdas.js?ver=2.0.3"></script>
    <script src="{virtualPath}/js/vmdcore.js?ver=2.0.3"></script>
    <script src="{virtualPath}/js/vmdcomps.js?ver=2.0.3"></script>
    <script src="{virtualPath}/js/publicMethods.js?ver=2.0.3"></script>
    <script src="{virtualPath}/js/vmdreport.js?ver=2.0.3"></script>
    {workspacePath}

    <script src="{virtualPath}/lib/ace/ace.js"></script>
    <script src="{virtualPath}/lib/ace/mode-base.js" type="text/javascript"></script>
    <script src="{virtualPath}/lib/ace/theme-xcode.js" type="text/javascript" ></script>
    <script src="{virtualPath}/lib/ace/ext-language_tools.js"></script>
    

    <style>

    </style>
    <style type="text/css" id="vmdcss">
        
    </style>
    <script>
        vmd.virtualPath = '{virtualPath}';
        
        Ext.define("vmd.module.MyViewport" ,{
	extend:"vmd.comp.viewport",
	requires:vmd.getCmpDeps([]),
	xtype:"vmd.module.MyViewport",
	layout:"border",
	afterrender:"MyViewport_afterrender",
	beforerender:"MyViewport_beforerender",
	listeners:{
		vmdafterrender:function(){
	this.MyViewport_afterrender(this)
},
		beforerender:function(){
	this.MyViewport_beforerender(this)
}
	},
	initComponent: function(){
		//上次点击的节点
var bselNodeId = "";
//获取传递的设计模式
var allowedDesigner = false;

//进度提示
var myMask = new Ext.LoadMask(Ext.getBody(), {
    msg: "数据加载中,请稍后...",
    msgCls: 'z-index:10000;'
});

//初始化数据
function hwTree_afterrender(sender) {
    myMask = new Ext.LoadMask(Ext.getCmp("hwTree").el, {
        msg: "数据加载中,请稍后...",
        msgCls: 'z-index:10000;'
    });
    myMask.show();
    var mytree = hwTree;
    var firstNode = "";
    mytree.deleteChildItems(0);
    mytree.loadJSONObject({
        id: 0,
        text: "我的项目",
        item: []
    });
    mytree.itemObj = {};
    mytree.newnode = false;
    hwDas.ajax({
        das: {
            idedas: true
        },
        url: "CDEServcie/project/info",
        type: 'get',
        timeout: 50000,
        params: {},
        success: function(result) {
            var datajson = result.data[0].datas;
            var treeDataJson = [];
            for(var i = 0; i < datajson.length; i++) {
                //通过vmddesigner来判断当前登录用户是否有操作系统办公的权限
                if(!allowedDesigner && datajson[i].id == "eQ9ULgcVb1") {
                    continue
                } else {
                    mytree.insertNewChild(0, datajson[i].id, datajson[i].name);
                    mytree.setItemImage2(datajson[i].id, "tree/projectclose.png", "tree/projectopen.png", "tree/projectclose.png");
                    mytree.insertNewChild(datajson[i].id, datajson[i].id + "-0", "");
                    mytree.closeItem(datajson[i].id);
                    var treenode = mytree.item(datajson[i].id);
                    treenode.path = "/" + datajson[i].id;
                    if(treenode) {
                        treenode.isProject = true;
                        treenode.createuser = datajson[i].row_created_by;
                        treenode.createtime = datajson[i].row_created_date;
                        treenode.changetime = datajson[i].row_changed_date;
                        treenode.changeuser = datajson[i].row_changed_by;
                        treenode.code = datajson[i].code;
                        treenode.loadChild = false;
                    }
                    mytree.itemObj[datajson[i].id] = treenode;
                    if(firstNode == "")
                        firstNode = datajson[i].id;
                }
            }
            //默认选中首项 
            if(firstNode != "")
                mytree.selectItem(firstNode);

            myMask.hide();
        },
        error: function(msg) {
            myMask.hide();
            Ext.Msg.alert("提示", "获取模块信息失败", function() {})
        }
    })




    //绑定右键菜单
    var menu = new dhtmlXMenuObject();
    menu.renderAsContextMenu();
    menu.attachEvent("onClick", onMenuClick);
    menu.addNewChild(menu.topId, 0, "newPro", "新建项目", false);
    menu.addNewChild(menu.topId, 1, "newFord", "新建分类", false);
    menu.addNewChild(menu.topId, 2, "newMode", "新建模块", false);
    menu.addNewChild(menu.topId, 3, "copy", "复制", false);
    menu.addNewChild(menu.topId, 4, "cut", "剪切", false);
    menu.addNewChild(menu.topId, 5, "paste", "粘帖", false);
    menu.addNewChild(menu.topId, 6, "delete", "删除", false);
    mytree.enableDragAndDrop("temporary_disabled");
    mytree.enableContextMenu(menu);

    mytree.attachEvent("onBeforeContextMenu", function(itemId) {
        
        var mytree = hwTree;
        var selId = mytree.getSelectedItemId();
        var selnode = mytree.itemObj[selId];
        if(selnode.isProject) {
            menu.showItem('newPro');
            menu.showItem('newFord');
            menu.showItem('newMode');
            menu.hideItem('copy');
            menu.hideItem('cut');
            menu.showItem('paste');
            menu.showItem('delete');
        } else if(selnode.isFord) {
            menu.hideItem('newPro');
            menu.showItem('newFord');
            menu.showItem('newMode');
            menu.hideItem('copy');
            menu.hideItem('cut');
            menu.showItem('paste');
            menu.showItem('delete');
        } else if(selnode.isModel) {
            menu.hideItem('newPro');
            menu.hideItem('newFord');
            menu.hideItem('newMode');
            menu.showItem('copy');
            menu.showItem('cut');
            menu.hideItem('paste');
            menu.showItem('delete');
        }
        return true
    })

    //绑定右键事件 设置右键选中节点
    mytree.attachEvent('onRightClick', function(id) {
        mytree.selectItem(id);
    })
}

function hwTree_onOpenEnd(sender, id) {
    myMask.show();
    var proId = id;
    var mytree = hwTree;
    mytree.newnode = false;
    var hasChild = mytree.hasChildren(proId);
    var selnode = mytree.itemObj[proId];
    var selnodepath = selnode.path;
    var projectId = "";
    var childParentId = "0";
    if(selnode.isProject) {
        projectId = proId;
        childParentId = "0";
    } else {
        projectId = selnode.projectId;
        childParentId = proId
    }
    if(!selnode.loadChild && !selnode.isModel) {
        hwDas.ajax({
            das: {
                idedas: true
            },
            url: "CDEServcie/module/category",
            type: 'get',
            timeout: 50000,
            params: {
                project_id: projectId,
                parent_id: childParentId
            },
            success: function(result) {
                var datajson = result.data[0].datas;
                var treeDataJson = [];
                for(var i = 0; i < datajson.length; i++) {
                    mytree.insertNewChild(proId, datajson[i].id, datajson[i].name);
                    mytree.setItemImage2(datajson[i].id, "tree/folderClosed.gif", "tree/folderOpen.gif", "tree/folderClosed.gif")
                    mytree.insertNewChild(datajson[i].id, datajson[i].id + "-0", "");
                    mytree.closeItem(datajson[i].id);
                    var treenode = mytree.item(datajson[i].id);
                    treenode.path = selnodepath + "/" + datajson[i].id;
                    treenode.projectId = projectId;
                    if(treenode) {
                        treenode.isFord = true;
                        treenode.loadChild = false;
                    }
                    mytree.itemObj[datajson[i].id] = treenode;
                }
                myMask.hide();
            },
            error: function(msg) {
                myMask.hide();
                Ext.Msg.alert("提示", "获取模块信息失败", function() {})
            }
        })
        if(!selnode.loadChild) {
            mytree.deleteItem(id + "-0", false);
        }
        selnode.loadChild = true;
        // if(selnode.isFord) {
        hwDas.ajax({
                das: {
                    idedas: true
                },
                url: "CDEServcie/module/info",
                type: 'get',
                timeout: 50000,
                params: {
                    category_id: childParentId,
                    project_id: projectId
                },
                success: function(result) {
                    var datajson = result.data[0].datas;
                    var treeDataJson = [];
                    for(var i = 0; i < datajson.length; i++) {
                        mytree.insertNewChild(proId, datajson[i].id, datajson[i].name);
                        mytree.setItemImage2(datajson[i].id, "tree/model.png", "tree/model.png", "tree/model.png")
                        var treenode = mytree.item(datajson[i].id);
                        treenode.path = selnodepath + "/" + datajson[i].id;
                        treenode.projectId = projectId;
                        if(treenode) {
                            treenode.isModel = true;
                            treenode.createuser = datajson[i].row_created_by;
                            treenode.createtime = datajson[i].row_created_date;
                            treenode.changetime = datajson[i].row_changed_date;
                            treenode.changeuser = datajson[i].row_changed_by;
                            treenode.remark = datajson[i].remark;
                            treenode.code = datajson[i].code;
                        }
                        mytree.itemObj[datajson[i].id] = treenode;
                    }
                    //数据操作  
                    myMask.hide();
                },
                error: function(msg) {
                    myMask.hide();
                    Ext.Msg.alert("提示", "获取模块信息失败")
                }
            })
            //}
    } else {
        myMask.hide();
    }
}
//点击树节点操作
function hwTree_nodeClick(sender, id) {
    myMask.show();
    var proId = id;
    var mytree = hwTree;
    mytree.newnode = false;
    var hasChild = mytree.hasChildren(proId);
    var selnode = mytree.itemObj[proId];
    var selnodepath = selnode.path;
    var projectId = "";
    var childParentId = "0";
    if(bselNodeId != id) {
        if(selnode.isModel) {
            document.getElementById("iframe_page").src = '/modules/eQ9ULgcVb1/eQ9ULgcVb5/hwa99a3307.html';
            //MyP_jcxx.body.update("<" + "iframe " + " src='/modules/eQ9ULgcVb1/eQ9ULgcVb5/hwa99a3307.html' " + " width=100% height=100% frameborder=0  " + ">" + "sdsds" + "<" + "/" + "iframe" + ">");
        } else if(selnode.isProject) {
            projectId = proId;
            childParentId = "0";
            document.getElementById("iframe_page").src = '/modules/eQ9ULgcVb1/eQ9ULgcVb5/hwc6d63bc6.html';
            //MyP_jcxx.body.update("<" + "iframe " + " src='/modules/eQ9ULgcVb1/eQ9ULgcVb5/hwc6d63bc6.html' " + " width=100% height=100% frameborder=0  " + ">" + "sdsds" + "<" + "/" + "iframe" + ">");
        } else {
            document.getElementById("iframe_page").src = '/modules/eQ9ULgcVb1/eQ9ULgcVb5/hw03cb4931.html';
            //MyP_jcxx.body.update("<" + "iframe " + " src='/modules/eQ9ULgcVb1/eQ9ULgcVb5/hw03cb4931.html' " + " width=100% height=100% frameborder=0  " + ">" + "sdsds" + "<" + "/" + "iframe" + ">");
            projectId = selnode.projectId;
            childParentId = proId
        }
    }
    bselNodeId = id;
    myMask.hide();
}
//创建分类按钮操作
function creatFord() {
    var addford = function(fordname) {
        var mytree = hwTree;
        var selId = mytree.getSelectedItemId();
        var selnode = mytree.itemObj[selId];
        var selnodepath = selnode.path;
        var parentId;
        var projectId;
        var nodename = fordname;
        var newnodeid = newGuid(10);
        var newcode = newGuid(10);
        var xh = 10;
        if(selnode.isProject) {
            parentId = "0";
            projectId = selId;
        } else
        if(selnode.isModel) {
            return;
        } else if(selnode.isFord) {
            parentId = selId;
            projectId = selnode.projectId;
        }
        hwDas.ajax({
            das: {
                idedas: true
            },
            url: "CDEServcie/module/category",
            type: 'post',
            timeout: 50000,
            params: {
                parent_id: parentId,
                name: nodename,
                code: newcode,
                project_id: projectId,
                id: newnodeid,
                xh: xh
            },
            data: [{
                parent_id: parentId,
                name: nodename,
                code: newcode,
                project_id: projectId,
                id: newnodeid,
                xh: xh
            }],
            success: function(result) {
                mytree.insertNewChild(selId, newnodeid, nodename);
                mytree.setItemImage2(newnodeid, "tree/folderClosed.gif", "tree/folderOpen.gif", "tree/folderClosed.gif")
                var treenode = mytree.item(newnodeid);
                treenode.path = selnodepath + "/" + newnodeid;
                treenode.projectId = projectId;
                if(treenode) {
                    treenode.isFord = true;
                }
                mytree.itemObj[newnodeid] = treenode;
            },
            error: function(msg) {
                Ext.Msg.alert("提示", "新建目录失败")
            }
        })
    }
    var fordname = new Ext.MyFordWin(addford);
    fordname.show();
}

//删除目录 模块信息
function button1_click(sender) {
    var mytree = hwTree;
    var selId = mytree.getSelectedItemId();
    var selnode = mytree.itemObj[selId];
    var haschild = mytree.hasChildren(selId);

    if(selId == "5b8e5abdec" || selId == "eQ9ULgcVc5" || selId == "eQ9ULgcVb5" || selId == "hwa99a3307" || selId == "hwc6d63bc6") {
        Ext.Msg.alert("提示", "该模块禁止删除！")
        return
    }

    if(mytree.itemObj[selId].projectId == "eQ9ULgcVb1") {
        Ext.Msg.confirm("提示", "删除的模块或项目为协同办公，请谨慎操作", function(type) {
            if(type == "yes") {
                deleteNode();
            } else
                return;
        })
        return;
    }
    deleteNode();
}

function deleteNode() {
    var mytree = hwTree;
    var selId = mytree.getSelectedItemId();
    var selnode = mytree.itemObj[selId];
    var haschild = mytree.hasChildren(selId);

    //删除文件夹
    if(selnode.isProject) {
        if(haschild > 0) {
            Ext.Msg.alert("提示", "存在子目录或模块，请删除子目录或子模块后再删除该项目！")
            return
        }
        Ext.Msg.confirm("提示", "删除项目后，项目下的所有文件都将删除。确认要删除该项目！", function(type) {
            if(type == "yes") {
                hwDas.ajax({
                    das: {
                        idedas: true
                    },
                    url: "CDEServcie/project/info",
                    type: 'delete',
                    timeout: 50000,
                    params: {
                        id: selId
                    },
                    success: function(result) {
                        mytree.deleteItem(selId, true);
                    },
                    error: function(msg) {
                        Ext.Msg.alert("提示", "删除项目失败")
                    }
                })
            }
        })
        return;
    }
    //删除文件夹
    if(selnode.isFord) {
        if(haschild > 0) {
            Ext.Msg.alert("提示", "存在子目录或模块，请删除子目录或子模块后再删除该目录")
            return
        }
        Ext.Msg.confirm("提示", "确认要删除该目录！", function(type) {
            if(type == "yes") {
                hwDas.ajax({
                    das: {
                        idedas: true
                    },
                    url: "CDEServcie/module/category",
                    type: 'delete',
                    timeout: 50000,
                    params: {
                        id: selId
                    },
                    success: function(result) {
                        mytree.deleteItem(selId, true);
                    },
                    error: function(msg) {
                        Ext.Msg.alert("提示", "删除目录失败")
                    }
                })
            }
        })
        return;
    }
    //删除模块
    if(selnode.isModel) {
        Ext.Msg.confirm("提示", "确认要删除该模块？", function(type) {
            if(type == "yes") {
                //先删除模块信息
                var runtype = [];
                myMask.show();
                hwDas.ajax({
                        das: {
                            idedas: true
                        },
                        url: "CDEServcie/module/info",
                        type: 'delete',
                        timeout: 50000,
                        params: {
                            id: selId
                        },
                        success: function(result) {
                            mytree.deleteItem(selId); //, true);
                            runtype.push(true)
                            if(runtype.length >= 4)
                                myMask.hide()
                        },
                        error: function(msg) {
                            runtype.push(false)
                            if(runtype.length >= 4)
                                myMask.hide()
                            Ext.Msg.alert("提示", "删除模块信息失败")
                            return
                        }
                    })
                    //删除模块文件对应关系
                hwDas.ajax({
                        das: {
                            idedas: true
                        },
                        url: "CDEServcie/module/file",
                        type: 'delete',
                        timeout: 50000,
                        params: {
                            module_id: selId
                        },
                        success: function(result) {
                            runtype.push(true)
                            if(runtype.length >= 4)
                                myMask.hide()
                        },
                        error: function(msg) {
                            runtype.push(false)
                            if(runtype.length >= 4)
                                myMask.hide()
                            Ext.Msg.alert("提示", "删除模块文件信息失败")
                        }
                    })
                    //删除vmd文件
                hwDas.ajax({
                        das: {
                            idedas: false
                        },
                        url: 'FileService',
                        type: 'delete',
                        timeout: 50000,
                        params: {
                            FileName: 'modules' + selnode.path + '.vmd'
                        },
                        success: function(result) {
                            runtype.push(true)
                            if(runtype.length >= 4)
                                myMask.hide()
                        },
                        error: function(msg) {
                            runtype.push(false)
                            if(runtype.length >= 4)
                                myMask.hide()
                            Ext.Msg.alert("提示", "删除vmd模块文件失败")
                        }
                    }) //删除html文件
                hwDas.ajax({
                    das: {
                        idedas: false
                    },
                    url: 'FileService',
                    type: 'delete',
                    timeout: 50000,
                    params: {
                        FileName: 'modules' + selnode.path + '.html'
                    },
                    success: function(result) {
                        runtype.push(true)
                    },
                    error: function(msg) {
                        runtype.push(false)
                        Ext.Msg.alert("提示", "删除html模块文件失败")
                    }
                })
            }

        })
        return;
    }
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//自定义自定义方法

function newGuid(len) {
    var length = 32;
    if(len)
        length = len - 2
    var guid = "";
    for(var i = 1; i <= length; i++) {
        var n = Math.floor(Math.random() * 16.0).toString(16);
        guid += n;
    }
    return "hw" + guid;
}

//文件夹名称录入框
Ext.MyFordWin = Ext.extend(Ext.Window, {
        xtype: "window",
        title: "文件夹对话框",
        width: 300,
        height: 130,
        layout: "form",
        bodyStyle: 'padding:15px',
        labelAlign: "left",
        labelWidth: 40,
        constructor: function(callback) {
            this.callback = callback;
            this.callParent();
        },
        initComponent: function() {
            var me = this;
            this.fbar = [{
                text: "确定",
                handler: function() {
                    me.callback(Ext.getCmp('filename').getValue())
                    me.close()
                }
            }, {
                text: "取消",
                handler: function() {
                    me.close()
                }
            }];

            this.items = [{
                id: 'filename',
                xtype: "textfield",
                fieldLabel: "名称",
                anchor: "100%"
            }]
            Ext.MyFordWin.superclass.initComponent.call(this);
        }
    })
    //右键菜单事件
function onMenuClick(menuitemId) {
    if(menuitemId == "newFord") {
        creatFord();
    } else if(menuitemId == "newMode") {
        hwTree.newnode = true;
        document.getElementById("iframe_page").src = '/modules/eQ9ULgcVb1/eQ9ULgcVb5/hwa99a3307.html';
    } else if(menuitemId == "delete") {
        button1_click();
    } else if(menuitemId == "newPro") {
        hwTree.newnode = true;
        document.getElementById("iframe_page").src = '/modules/eQ9ULgcVb1/eQ9ULgcVb5/hwc6d63bc6.html';
    } else if(menuitemId == "copy") {
        // nodeCopy();
    } else if(menuitemId == "cut") {
        // nodeCut();
    } else if(menuitemId == "paste") {
        // nodePaste();
    }
}


///记录赋值或剪切的节点id
var copyNodeId = "";
var cutNodeId = "";
///复制节点
function nodeCopy() {
    var mytree = hwTree;
    var selId = mytree.getSelectedItemId();
    copyNodeId = selId;
    cutNodeId = "";
}

///剪切节点
function nodeCut() {
    var mytree = hwTree;
    var selId = mytree.getSelectedItemId();
    cutNodeId = selId;
    copyNodeId = "";
}

//粘帖节点
function nodePaste() {
    if(copyNodeId == "" && cutNodeId == "") {
        //extends.msg.alert("无可粘贴的数据");
        return;
    }
    var mytree = hwTree;
    var selId = mytree.getSelectedItemId();
    var selnode = mytree.itemObj[selId];
    var selnodepath = selnode.path;
    var category_id;
    var projectId;
    var remark = selnode.remark;
    if(selnode.isProject) {
        projectId = selId;
        category_id = "0";
    }
    if(selnode.isFord) {
        projectId = selnode.projectId;
        category_id = selId;
    }
    if(copyNodeId != "") {

        var copyNode = mytree.itemObj[copyNodeId];
        var copyFilePath = copyNode.path;
        var ModeName = copyNode.text;
        var id = newGuid(10);
        var newcode = copyNode.code;
        var row_created_by = Ext.util.Cookies.get('userName');
        var row_created_date = Ext.Date.dateFormat(new Date(), 'Y-m-d H:i:s');
        var row_changed_by = Ext.util.Cookies.get('userName');
        var row_changed_date = Ext.Date.dateFormat(new Date(), 'Y-m-d H:i:s');
        //保存模块基础信息
        hwDas.ajax({
            das: {
                idedas: true
            },
            url: "CDEServcie/module/info",
            type: 'post',
            timeout: 50000,
            params: {},
            data: [{
                id: id,
                code: newcode,
                type: "0",
                name: ModeName,
                remark: remark,
                category_id: category_id,
                project_id: projectId,
                row_created_by: row_created_by,
                row_created_date: row_created_date,
                row_changed_by: row_changed_by,
                row_changed_date: row_changed_date
            }],
            success: function(result) {
                mytree.insertNewChild(selId, id, ModeName);
                mytree.setItemImage2(id, "tree/model.png", "tree/model.png", "tree/model.png")
                var treenode = mytree.item(id);
                treenode.path = selnodepath + "/" + id;
                treenode.projectId = Project_id;
                if(treenode) {
                    treenode.isModel = true;
                    treenode.text = ModeName;
                    treenode.createuser = row_created_by;
                    treenode.createtime = row_created_date;
                    treenode.changetime = row_changed_date;
                    treenode.changeuser = row_changed_by;
                    treenode.remark = remark;
                    treenode.code = newcode
                    treenode.newnode = false;
                }
                mytree.itemObj[id] = treenode;
                mytree.selectItem(id, false, false);
                mytree.newnode = false;
                //保存模块路径版本信息
                hwDas.ajax({
                        das: {
                            idedas: true
                        },
                        url: "CDEServcie/module/file",
                        type: 'post',
                        timeout: 50000,
                        params: {},
                        data: [{
                            filepath: selnodepath + "/" + id,
                            version: 1,
                            module_id: id
                        }],
                        success: function(result) {
                            // Ext.Msg.alert("提示", "保存成功！")
                        },
                        error: function(msg) {
                            Ext.Msg.alert("提示", "保存模块版本信息失败")
                            return;
                        }
                    })
                    ////拷贝文件
                    //copyFilePath到treenode.path

            },
            error: function(msg) {
                Ext.Msg.alert("提示", "复制失败")
                return;
            }
        })
    } else if(cutNodeId != "") {
        var cutNode = mytree.itemObj[copyNodeId];
        var cutFilePath = copyNode.path;
        var ModeName = copyNode.text;
        var remark = cutNode.remark;
        var code = cutNode.code;
        var id = cutNodeId;
        var row_created_by = Ext.util.Cookies.get('userName');
        var row_created_date = Ext.Date.dateFormat(new Date(), 'Y-m-d H:i:s');
        var row_changed_by = Ext.util.Cookies.get('userName');
        var row_changed_date = Ext.Date.dateFormat(new Date(), 'Y-m-d H:i:s');
        //保存模块基础信息
        hwDas.ajax({
            das: {
                idedas: true
            },
            url: "CDEServcie/module/info",
            type: 'put',
            timeout: 50000,
            params: {},
            data: [{
                id: id,
                category_id: category_id,
                project_id: projectId,
                row_created_by: row_created_by,
                row_created_date: row_created_date,
                row_changed_by: row_changed_by,
                row_changed_date: row_changed_date
            }],
            success: function(result) {
                //将节点移除，再添加
                mytree.deleteItem(id);
                mytree.insertNewChild(selId, id, ModeName);
                mytree.setItemImage2(id, "tree/model.png", "tree/model.png", "tree/model.png")

                cutNode.path = selnodepath + "/" + id;
                cutNode.projectId = Project_id;
                cutNode.createuser = row_created_by;
                cutNode.createtime = row_created_date;
                cutNode.changetime = row_changed_date;
                cutNode.changeuser = row_changed_by;
                treenode.newnode = false;

                mytree.selectItem(id, false, false);
                mytree.newnode = false;
                //保存模块路径版本信息
                hwDas.ajax({
                        das: {
                            idedas: true
                        },
                        url: "CDEServcie/module/file",
                        type: 'put',
                        timeout: 50000,
                        params: {},
                        data: [{
                            filepath: selnodepath + "/" + id,
                            version: 1,
                            module_id: id
                        }],
                        success: function(result) {
                            // Ext.Msg.alert("提示", "保存成功！")
                        },
                        error: function(msg) {
                            Ext.Msg.alert("提示", "保存模块版本信息失败")
                            return;
                        }
                    })
                    ////移动文件
                    //cutFilePath到cutNode.path
            },
            error: function(msg) {
                Ext.Msg.alert("提示", "复制失败")
                return;
            }
        })
    }





    copyCutNodeId = "";
}



//页面加载完后事件
function MyViewport_afterrender(sender) {
    MyP_jcxx.body.update("<iframe  id='iframe_page' src='/modules/eQ9ULgcVb1/eQ9ULgcVb5/hw03cb4931.html' width=100% height=100% frameborder=0  ></iframe>");
    if(!allowedDesigner) {
        MyC_tc.hide();
        button.hide();
    }

}
//退出图标的点击事件
function MyC_tc_afterrender(sender) {
    sender.el.on('click', function() {
        outvmd();
    })
}
//退出按钮操作
function button_click(sender) {
    outvmd();
}
//登出vmd2.0
function outvmd() {
    var aa = Ext.Msg.confirm("提示", "确定要退出vmd2.0吗？", function(type) {
        {
            if(type == "yes") {
                Ext.util.Cookies.clear("login")
                self.location = window.location.protocol + "//" + window.location.host;
            }
        }
    })
}

//页面初始化前方法 控制权限 记录编辑权限
function MyViewport_beforerender(sender) {
    //模拟平台5的token传参登陆,默认设置cookie 为dbadmin 管理员
    var urlToken = getUrlParam("token");
    if(urlToken != null && urlToken != "") {
        Ext.util.Cookies.set('userName', "管理员");
        Ext.util.Cookies.set('login', "dbadmin");
        return
    }
    var userType = Ext.util.Cookies.get("userType");
    allowedDesigner = userType == "vmdDesigner" ? true : false;
    var login = Ext.util.Cookies.get("login");
    if(!login) {
        self.location = window.location.protocol + "//" + window.location.host;
    }
}


var selModeWin;
window["selModeWin"] = selModeWin;

//新建模块时 打开模版选择页面 关闭时调用该方法，由子页面调用或该页面调用
function closeSelMode(create) {
    if(create) {
        var mytree = hwTree;
        var selId = mytree.getSelectedItemId();
        var selnode = mytree.itemObj[selId];
        selnode.newnode = false;
        mytree.newnode = false;
    }

    selModeWin.close();
}
window["closeSelMode"] = closeSelMode;


//新建模块时 打开模版选择页面，由子页面调用或该页面调用
function openSelMode(id, name, pdth) {
    selModeWin = new vmdDesigner({
        title: name + " 页面模版选择",
        params: {
            id: id,
            name: escape(name),
            path: pdth
        },
        width: document.body.clientWidth - 200,
        height: document.body.clientHeight - 100,
        url: '/modules/eQ9ULgcVb1/eQ9ULgcVb5/hw3b9ae460.html'
    });
    selModeWin.show();
}
//将选择模版方法放入window中
window["openSelMode"] = openSelMode;

function MyP_jcxx_beforerender(sender) {

}


function openWin(obj, html) {
    var openWin = new parent.Ext.Window(obj || {
        renderTo: parent.Ext.getBody(),
        title: "节点绑定表单",
        modal: true,
        maximized: false,
        height: 600,
        width: 800,
        maximizable: true,
        resizable: true,
        bodyStyle: "background-color:#fff",
        closeAction: 'close'

    })
    Ext.defer(function() {

        openWin.html = html; //"<iframe src='/modules/eQ9ULgcVb1/hw4acf2f8b/hw3b434d49.html?r=" + new Date().getTime() + "' frameborder=0 scrolling=no style='height:100%;width:100%'></iframe>";
        openWin.show()
    }, 50)
    return openWin;
}

function MyP_Htool_afterrender(sender) {
    
}

function MyC_zy_afterrender(sender){
var win=
}
			this.MyViewport_afterrender=MyViewport_afterrender;
		this.MyViewport_beforerender=MyViewport_beforerender;



		this.items=[
			{
				xtype:"panel",
				id:"MyPanel_head",
				title:"Panel",
				header:false,
				border:true,
				height:60,
				x:0,
				y:0,
				layout:"border",
				bodyStyle:"background-color:skyblue;",
				region:"north",
				items:[
					{
						xtype:"panel",
						id:"MyPanel_logo",
						title:"Panel",
						header:false,
						border:false,
						height:100,
						region:"west",
						layout:"border",
						width:500,
						maskDisabled:true,
						bodyStyle:"background-color:#1e7fff;",
						items:[
							{
								xtype:"vmd.div",
								id:"MyC_Logoimg",
								autoEl:"div",
								border:true,
								backgroundRepeat:"no-repeat",
								backgroundPosition:"top left",
								width:58,
								height:30,
								style:"background: url('/system/img/main/logo1.png')no-repeat center;    margin-left: 20px;",
								x:0,
								y:0,
								region:"west"
							},
							{
								xtype:"label",
								id:"MyLb_name",
								text:"VMD2.0可视化定制工具",
								x:70,
								y:10,
								style:"font-size: 26px;    color: #ffffff;    margin-left: 35px;    margin-top: 4px;",
								region:"center",
								split:false,
								cls:"lineHeight200"
							}
						]
					},
					{
						xtype:"panel",
						id:"MyP_Htool",
						title:"Panel",
						header:false,
						border:false,
						height:100,
						region:"east",
						width:420,
						layout:"absolute",
						style:"background-color:skyblue;",
						bodyStyle:"background-color:#1e7fff;",
						afterrender:"MyP_Htool_afterrender",
						listeners:{
							vmdafterrender:MyP_Htool_afterrender
						},
						items:[
							{
								xtype:"vmd.div",
								id:"MyC_zy",
								autoEl:"div",
								border:true,
								backgroundRepeat:"no-repeat",
								backgroundPosition:"top left",
								width:20,
								height:20,
								x:30,
								y:25,
								style:"background-image: url(/system/img/main/zy.png);",
								pageX:"",
								pageY:"",
								afterrender:"MyC_zy_afterrender",
								listeners:{
									vmdafterrender:MyC_zy_afterrender
								}
							},
							{
								xtype:"vmd.div",
								id:"MyC_hjbl",
								autoEl:"div",
								border:true,
								backgroundRepeat:"no-repeat",
								backgroundPosition:"top left",
								width:20,
								height:20,
								x:120,
								y:25,
								style:"background-image: url(/system/img/main/hjbl.png);"
							},
							{
								xtype:"vmd.div",
								id:"MyC_grxx",
								autoEl:"div",
								border:true,
								backgroundRepeat:"no-repeat",
								backgroundPosition:"top left",
								width:20,
								height:20,
								x:230,
								y:25,
								style:"background-image: url(/system/img/main/grxx.png);"
							},
							{
								xtype:"vmd.div",
								id:"MyC_tc",
								autoEl:"div",
								border:true,
								backgroundRepeat:"no-repeat",
								backgroundPosition:"top left",
								width:20,
								height:20,
								x:335,
								y:25,
								style:"background-image: url(/system/img/main/tc.png);",
								afterrender:"MyC_tc_afterrender",
								listeners:{
									vmdafterrender:MyC_tc_afterrender
								}
							},
							{
								xtype:"label",
								id:"MyLb_zy",
								text:"资源",
								x:60,
								y:27,
								style:"color: white;    font-size: 12px;    color: #ffffff;"
							},
							{
								xtype:"label",
								id:"MyLb_hjbl",
								text:"环境变量",
								x:150,
								y:27,
								style:"color: white;    font-size: 12px;    color: #ffffff;"
							},
							{
								xtype:"label",
								id:"MyLb_grxx",
								text:"个人信息",
								x:260,
								y:27,
								style:"color: white;    font-size: 12px;    color: #ffffff;",
								width:60
							},
							{
								xtype:"vmd.button",
								id:"button",
								text:"退出",
								type:"text",
								size:"small",
								x:345,
								y:22,
								width:60,
								style:"font-size: 12px;    color: #ffffff;",
								click:"button_click",
								listeners:{
									click:button_click
								}
							}
						]
					},
					{
						xtype:"panel",
						id:"MyPanel7",
						title:"Panel",
						header:false,
						border:false,
						height:100,
						region:"center",
						style:"background-color: #1e7fff;",
						bodyStyle:"background-color:#1e7fff;"
					}
				]
			},
			{
				xtype:"panel",
				id:"MyP_info",
				title:"Panel",
				header:false,
				border:true,
				height:640,
				x:0,
				y:60,
				layout:"border",
				region:"center",
				items:[
					{
						xtype:"panel",
						id:"MyP_ModelTree",
						title:"Panel",
						header:false,
						border:true,
						height:639,
						width:220,
						layout:"border",
						x:0,
						y:0,
						region:"west",
						style:"background-color: white;",
						bodyStyle:" background-color: white;",
						split:true,
						floatable:false,
						collapseMode:"mini",
						collapsible:true,
						items:[
							{
								xtype:"panel",
								id:"MyPanel",
								title:"Panel",
								header:false,
								border:false,
								height:22,
								x:60,
								y:110,
								layout:"border",
								width:220,
								region:"north",
								style:"margin-left: 5px;    margin-top: 5px;    padding-right: 10px;",
								items:[
									{
										xtype:"textfield",
										id:"MyF_searchtext",
										allowBlank:true,
										x:0,
										y:0,
										width:200,
										region:"center"
									},
									{
										xtype:"vmd.button",
										id:"btn_search",
										type:"(none)",
										size:"mini",
										x:190,
										y:0,
										icon:"search",
										width:30,
										region:"east",
										margins:""
									}
								]
							},
							{
								xtype:"panel",
								id:"MyPanel1",
								title:"Panel",
								header:false,
								border:false,
								height:300,
								x:70,
								y:130,
								region:"center",
								layout:"fit",
								style:"margin-left: 5px;    margin-top: 10px;    padding-right: 5px;    padding-bottom:  10px;",
								items:[
									{
										xtype:"vmd.tree",
										id:"hwTree",
										skin:"material",
										width:220,
										height:580,
										isdesign:false,
										x:0,
										y:0,
										afterrender:"hwTree_afterrender",
										onOpenEnd:"hwTree_onOpenEnd",
										nodeClick:"hwTree_nodeClick",
										region:"center",
										onOpenStart:"hwTree_onOpenStart",
										onDblClick:"hwTree_onDblClick",
										listeners:{
											vmdafterrender:hwTree_afterrender,
											onOpenEnd:hwTree_onOpenEnd,
											nodeClick:hwTree_nodeClick
										}
									}
								]
							}
						]
					},
					{
						xtype:"panel",
						id:"MyP_jcxx",
						title:"Panel",
						header:false,
						border:true,
						height:640,
						width:900,
						x:220,
						y:0,
						layout:"absolute",
						region:"center",
						beforerender:"MyP_jcxx_beforerender",
						listeners:{
							beforerender:MyP_jcxx_beforerender
						}
					}
				]
			}
		]
		this.callParent();
		var me = this;vmd.core.moduleInit(this.items, this);
	}
})
        Ext.onReady(function () {
            Ext.create('vmd.module.MyViewport', {
                renderTo: document.body
            })


        })

      </script>
</head>
<body>
</body>
</html>
