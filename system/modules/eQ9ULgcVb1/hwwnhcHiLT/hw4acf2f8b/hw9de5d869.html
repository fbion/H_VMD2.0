<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>（不用）节点变量绑定表单变量</title>
    
    <!--基本样式-->
    <link href="/css/common.css" rel="stylesheet" />

    <!--加载dhx组件-->
    
    <link href="/lib/ext-3.4/resources/css/ext-all.css" rel="stylesheet" />
     <!--样式快捷索引表-->
    <link href="/css/shortcut.css" rel="stylesheet" />
    <link href="/lib/dhtmlx/dhtmlx.css" rel="stylesheet" />

    <script src="/lib/labjs/LAB.min.js"></script>
    <script src="/config.js"></script>
    <script src="/lib/ext-3.4/adapter/ext/ext-base-debug.js"></script>
    <script src="/lib/ext-3.4/adapter/ext/ext-base-lang.js"></script>
    <script src="/lib/ext-3.4/adapter/ext/ext-base-class.js"></script>
    <script src="/lib/ext-3.4/ext-all-debug.js"></script>
    <script src="/lib/ext-3.4/src/locale/ext-lang-zh_CN.js"></script>

    <script src="/lib/dhtmlx/dhtmlx.js"></script>
	<script src="/report/dhtmlx/dhtmlxCommon/codebase/dhtmlxcommon.js"></script>
	 <script src="/report/dhtmlx/dhtmlxCommon/codebase/dhtmlxcore.js"></script>
   <script src="/report/dhtmlx/dhtmlxCommon/codebase/dhtmlxcontainer.js"></script>
	 <script src="/report/FillReport2.0/js/dhtmlx/dhtmlXFileUploader.js"></script>
    <script src="/js/hwdas.js"></script>
    <script src="/js/vmdcore.js"></script>
    <script src="/js/vmdcomps.js"></script>
     <script src="/js/vmdreport.js"></script>
	 
    <script src="/lib/ace/ace.js"></script>
    <script src="/lib/ace/mode-base.js" type="text/javascript"></script>
    <script src="/lib/ace/theme-xcode.js" type="text/javascript" ></script>
    <script src="/lib/ace/ext-language_tools.js"></script>


    <style>
       /*.x-viewport, .x-viewport body {
            overflow:auto !important
        }*/
    </style>
    <style type="text/css" id="vmdcss">
        
    </style>
    <script>

        Ext.define("vmd.module.MyViewport" ,{
	extend:"vmd.comp.viewport",
	xtype:"vmd.module.MyViewport",
	layout:"anchor",
	initComponent: function(){



		this.items=[
			{
				xtype:"panel",
				id:"panel",
				title:"Panel",
				header:false,
				border:false,
				height:100,
				anchor:"100% -50",
				layout:"border",
				items:[
					{
						xtype:"panel",
						id:"panel2",
						title:"Panel",
						header:false,
						border:true,
						height:599,
						width:176,
						region:"center",
						layout:"anchor",
						style:"background-color: #fff",
						bodyStyle:"background-color: #fff",
						items:[
							{
								xtype:"panel",
								id:"panel6",
								title:"Panel",
								header:false,
								border:false,
								height:100,
								region:"north",
								anchor:"100% 50%",
								layout:"anchor",
								items:[
									{
										xtype:"container",
										id:"div4",
										autoEl:"div",
										width:400,
										height:40,
										anchor:"100% ",
										layout:"absolute",
										items:[
											{
												xtype:"label",
												id:"label",
												text:"全局变量",
												x:10,
												y:10
											}
										]
									},
									{
										xtype:"vmd.grid",
										id:"hwGrid",
										skin:"material",
										width:300,
										height:200,
										isdesign:true,
										anchor:"100% -40",
										beforerender:"hwGrid_beforerender",
										afterrender:"hwGrid_afterrender",
										fillReport:true,
										listeners:{
											beforerender:hwGrid_beforerender,
											afterrender:hwGrid_afterrender
										}
									}
								]
							},
							{
								xtype:"panel",
								id:"panel7",
								title:"Panel",
								header:false,
								border:false,
								height:100,
								region:"center",
								anchor:"100% 50%",
								layout:"anchor",
								bodyStyle:"border-top: 1px  solid lightblue",
								items:[
									{
										xtype:"container",
										id:"div5",
										autoEl:"div",
										width:400,
										height:40,
										anchor:"100%",
										layout:"absolute",
										items:[
											{
												xtype:"label",
												id:"label1",
												text:"节点变量",
												x:10,
												y:10
											}
										]
									},
									{
										xtype:"vmd.grid",
										id:"hwGrid1",
										skin:"material",
										width:300,
										height:200,
										isdesign:true,
										anchor:"100% -40",
										beforerender:"hwGrid1_beforerender",
										afterrender:"hwGrid1_afterrender",
										fillReport:true,
										listeners:{
											beforerender:hwGrid1_beforerender,
											afterrender:hwGrid1_afterrender
										}
									}
								]
							}
						]
					},
					{
						xtype:"panel",
						id:"panel3",
						title:"Panel",
						header:false,
						border:true,
						height:100,
						region:"west",
						width:229,
						layout:"anchor",
						collapseMode:"mini",
						split:true,
						items:[
							{
								xtype:"panel",
								id:"panel4",
								title:"Panel",
								header:false,
								border:false,
								height:40,
								layout:"fit",
								items:[
									{
										xtype:"container",
										id:"div",
										autoEl:"div",
										width:400,
										height:50,
										style:"padding-top: 8px;    padding-left: 5px;",
										layout:"hbox",
										items:[
											{
												xtype:"textfield",
												id:"MyField",
												fieldLabel:"Form Fields",
												width:194,
												columnWidth:0.99
											},
											{
												xtype:"vmd.button",
												id:"button",
												type:"(none)",
												size:"mini",
												icon:"search",
												height:22,
												width:22
											}
										]
									}
								]
							},
							{
								xtype:"panel",
								id:"panel5",
								title:"Panel",
								header:false,
								border:false,
								height:100,
								anchor:"100% -40",
								layout:"fit",
								style:"padding-left: 5px;    padding-right: 5px",
								items:[
									{
										xtype:"vmd.tree",
										id:"hwTree",
										skin:"material",
										width:300,
										height:200,
										isdesign:false,
										afterrender:"hwTree_afterrender",
										onOpenEnd:"hwTree_onOpenEnd",
										nodeClick:"hwTree_nodeClick",
										Check:"hwTree_Check",
										listeners:{
											afterrender:hwTree_afterrender,
											onOpenEnd:hwTree_onOpenEnd,
											nodeClick:hwTree_nodeClick,
											Check:hwTree_Check
										}
									}
								]
							}
						]
					}
				]
			},
			{
				xtype:"panel",
				id:"panel1",
				title:"Panel",
				header:false,
				border:false,
				height:50,
				anchor:"",
				layout:"column",
				items:[
					{
						xtype:"container",
						id:"div1",
						autoEl:"div",
						width:400,
						height:50,
						columnWidth:0.5
					},
					{
						xtype:"container",
						id:"div2",
						autoEl:"div",
						width:200,
						height:50,
						layout:"absolute",
						items:[
							{
								xtype:"vmd.button",
								id:"button1",
								text:"确定",
								type:"primary",
								size:"small",
								x:10,
								y:10,
								click:"button1_click",
								listeners:{
									click:button1_click
								}
							},
							{
								xtype:"vmd.button",
								id:"button2",
								text:"取消",
								type:"(none)",
								size:"small",
								x:110,
								y:10,
								click:"button2_click",
								listeners:{
									click:button2_click
								}
							}
						]
					},
					{
						xtype:"container",
						id:"div3",
						autoEl:"div",
						width:400,
						height:50,
						columnWidth:0.5
					}
				]
			}
		]
		this.callParent();
		vmd.core.moduleInit(this.items, this);
			var nodeInfo = {
    modelId: '2501',
    variantProcess: {
        processKey: 'forLeave1',
        taskNodeid: 'startevent1',
        taskNodeName: 'Start',
        formProperties: [{
            id: "startDate",
            name: "请假开始日期",
            type: "date",
            expression: null,
            variable: null,
            datePattern: "yyyy-MM-dd",
            required: true,
            readable: true,
            writable: true
        }, {
            id: "endDate",
            name: "请假结束日期",
            type: "date",
            expression: null,
            variable: null,
            datePattern: "yyyy-MM-dd",
            required: true,
            readable: true,
            writable: true
        }, {
            id: "reason",
            name: "请假原因",
            type: "string",
            expression: null,
            variable: null,
            required: true,
            readable: true,
            writable: true
        }]
    },
    variantNode: {
        processKey: 'forLeave1',
        taskNodeid: 'deptLeaderAudit',
        taskNodeName: '部门领导审批',
        formProperties: [{
            id: "startDate",
            name: "请假开始日期",
            type: "date",
            expression: null,
            variable: null,
            datePattern: "yyyy-MM-dd",
            required: false,
            readable: true,
            writable: false
        }, {
            id: "endDate",
            name: "请假结束时间",
            type: "date",
            expression: null,
            variable: null,
            datePattern: "yyyy-MM-dd",
            required: false,
            readable: true,
            writable: false
        }, {
            id: "deptLeaderApproved",
            name: "审批意见",
            type: "enum",
            expression: null,
            variable: null,
            enumValues: [{
                name: "同意",
                id: "1"
            }, {
                name: "不同意",
                id: "2"
            }],
            required: true,
            readable: true,
            writable: true
        }]
    }
}
if(parent.nodeInfo)
    nodeInfo = parent.nodeInfo;


//进度提示
var myMask = new Ext.LoadMask(Ext.getBody(), {
    msg: "数据加载中,请稍后...",
    msgCls: 'z-index:10000;'
});

//初始化数据
function hwTree_afterrender(sender) {
    myMask = new Ext.LoadMask(Ext.getCmp("hwTree").el, {
        msg: "数据加载中,请稍后...",
        msgCls: 'z-index:10000;'
    });
    myMask.show();
    var mytree = hwTree;
    var firstNode = "";
    mytree.deleteChildItems(0);
    mytree.loadJSONObject({
        id: 0,
        text: "我的项目",
        item: []
    });
    mytree.enableRadioButtons(true)
    mytree.enableSingleRadioMode(true)
    mytree.itemObj = {};
    mytree.newnode = false;
    hwDas.ajax({
        das: {
            idedas: true
        },
        url: "CDEServcie/project/info",
        type: 'get',
        timeout: 50000,
        params: {},
        success: function(result) {
            var datajson = result.data[0].datas;
            var treeDataJson = [];
            for(var i = 0; i < datajson.length; i++) {
                if(datajson[i].id == "eQ9ULgcVb1") {
                    continue
                } else {
                    mytree.insertNewChild(0, datajson[i].id, datajson[i].name);
                    mytree.setItemImage2(datajson[i].id, "tree/projectclose.png", "tree/projectopen.png", "tree/projectclose.png");
                    mytree.showItemCheckbox(datajson[i].id,false)
                    mytree.insertNewChild(datajson[i].id, datajson[i].id + "-0", "");
                    mytree.closeItem(datajson[i].id);
                    var treenode = mytree.item(datajson[i].id);
                    treenode.path = "/" + datajson[i].id;
                    if(treenode) {
                        treenode.isProject = true;
                        treenode.createuser = datajson[i].row_created_by;
                        treenode.createtime = datajson[i].row_created_date;
                        treenode.changetime = datajson[i].row_changed_date;
                        treenode.changeuser = datajson[i].row_changed_by;
                        treenode.code = datajson[i].code;
                        treenode.loadChild = false;
                    }
                    mytree.itemObj[datajson[i].id] = treenode;
                    if(firstNode == "")
                        firstNode = datajson[i].id;
                }
            }
            //默认选中首项 
            if(firstNode != "")
                mytree.selectItem(firstNode);

            myMask.hide();
        },
        error: function(msg) {
            myMask.hide();
            Ext.Msg.alert("提示", "获取模块信息失败", function() {})
        }
    })
}

function hwTree_onOpenEnd(sender, id, state) {
    myMask.show();
    var proId = id;
    var mytree = hwTree;
    mytree.newnode = false;
    var hasChild = mytree.hasChildren(proId);
    var selnode = mytree.itemObj[proId];
    var selnodepath = selnode.path;
    var projectId = "";
    var childParentId = "0";
    if(selnode.isProject) {
        projectId = proId;
        childParentId = "0";
    } else {
        projectId = selnode.projectId;
        childParentId = proId
    }
    if(!selnode.loadChild && !selnode.isModel) {
        hwDas.ajax({
            das: {
                idedas: true
            },
            url: "CDEServcie/module/category",
            type: 'get',
            timeout: 50000,
            params: {
                project_id: projectId,
                parent_id: childParentId
            },
            success: function(result) {
                var datajson = result.data[0].datas;
                var treeDataJson = [];
                for(var i = 0; i < datajson.length; i++) {
                    mytree.insertNewChild(proId, datajson[i].id, datajson[i].name);
                    mytree.setItemImage2(datajson[i].id, "tree/folderClosed.gif", "tree/folderOpen.gif", "tree/folderClosed.gif")
                    mytree.showItemCheckbox(datajson[i].id,false)
                    mytree.insertNewChild(datajson[i].id, datajson[i].id + "-0", "");
                    mytree.closeItem(datajson[i].id);
                    var treenode = mytree.item(datajson[i].id);
                    treenode.path = selnodepath + "/" + datajson[i].id;
                    treenode.projectId = projectId;
                    if(treenode) {
                        treenode.isFord = true;
                        treenode.loadChild = false;
                    }
                    mytree.itemObj[datajson[i].id] = treenode;
                }
                myMask.hide();
            },
            error: function(msg) {
                myMask.hide();
                Ext.Msg.alert("提示", "获取模块信息失败", function() {})
            }
        })
        if(!selnode.loadChild) {
            mytree.deleteItem(id + "-0", false);
        }
        selnode.loadChild = true;
        hwDas.ajax({
            das: {
                idedas: true
            },
            url: "CDEServcie/module/info",
            type: 'get',
            timeout: 50000,
            params: {
                category_id: childParentId,
                project_id: projectId
            },
            success: function(result) {
                var datajson = result.data[0].datas;
                var treeDataJson = [];
                for(var i = 0; i < datajson.length; i++) {
                    mytree.insertNewChild(proId, datajson[i].id, datajson[i].name);
                    mytree.setItemImage2(datajson[i].id, "tree/model.png", "tree/model.png", "tree/model.png")
                   // mytree.showItemCheckbox(datajson[i].id);
                    var treenode = mytree.item(datajson[i].id);
                    treenode.path = selnodepath + "/" + datajson[i].id;
                    treenode.projectId = projectId;
                    if(treenode) {
                        treenode.isModel = true;
                        treenode.createuser = datajson[i].row_created_by;
                        treenode.createtime = datajson[i].row_created_date;
                        treenode.changetime = datajson[i].row_changed_date;
                        treenode.changeuser = datajson[i].row_changed_by;
                        treenode.remark = datajson[i].remark;
                        treenode.code = datajson[i].code;
                    }
                    mytree.itemObj[datajson[i].id] = treenode;
                }
                //数据操作  
                myMask.hide();
            },
            error: function(msg) {
                myMask.hide();
                Ext.Msg.alert("提示", "获取模块信息失败")
            }
        })
    } else {
        myMask.hide();
    }
}

function hwGrid_beforerender(sender) {
    initgrid(hwGrid)
}

function hwGrid1_beforerender(sender) {
    initgrid(hwGrid1)
}

function initgrid(sender) {
    sender.headstr = "序号,变量编码,变量名称,类型,表单变量";
    sender.colType = "ro,ro,ro,ed,ed";
    //sender.colSorting = "int,str,str,str,str";
    var headerWidth = "50,100,100,100,120"
    var colId = "xh,id,name,type,value";
    sender.headerWidth = headerWidth;
    sender.colId = colId;
}


function hwGrid1_afterrender(sender) {
    hwGrid1.clearAll();
    var dsdata = nodeInfo.variantProcess.formProperties || [];
    var dsdata1 = [];
    for(var i = 0; i < dsdata.length; i++) {
        var datarow = {};
        datarow.xh = i + 1;
        datarow.id = dsdata[i].id;
        datarow.name = dsdata[i].name;
        datarow.type = dsdata[i].type;
        datarow.value = dsdata[i].value;
        dsdata1.push(datarow);
    }
    //绑定节点变量
    var ds1 = new dhtmlXDataStore({
        data: dsdata1,
        datatype: "json"
    });
    hwGrid1.sync(ds1);
}

function hwGrid_afterrender(sender) {
    hwGrid.clearAll();
    var dsdata = nodeInfo.variantNode.formProperties || [];
    var dsdata2 = [];
    for(var i = 0; i < dsdata.length; i++) {
        var datarow = {};
        datarow.xh = i + 1;
        datarow.id = dsdata[i].id;
        datarow.name = dsdata[i].name;
        datarow.type = dsdata[i].type;
        datarow.value = dsdata[i].value;
        dsdata2.push(datarow);
    }
    //绑定节点变量
    var ds2 = new dhtmlXDataStore({
        data: dsdata2,
        datatype: "json"
    });
    hwGrid.sync(ds2);
}

function button2_click(sender) {
    parent.openWinFrom.hide();
}

function button1_click(sender) {

    var nodeBindInfo = {};
    var variantNode = [];
    hwGrid.editStop(true);
    for(var i = 0; i < hwGrid.getRowsNum(); i++) {
        variantNode.push({
            nodeVar: hwGrid.cells2(i, 1).getValue(),
            modelVar: hwGrid.cells2(i, 4).getValue()
        });
    }

    var variantProcess = [];
    hwGrid1.editStop(true);
    for(var i = 0; i < hwGrid1.getRowsNum(); i++) {
        variantProcess.push({
            nodeVar: hwGrid1.cells2(i, 1).getValue(),
            modelVar: hwGrid1.cells2(i, 4).getValue()
        });
    }
    nodeBindInfo.modelId = nodeInfo.modelId;
    nodeBindInfo.nodeId = nodeInfo.variantNode.taskNodeid;
    nodeBindInfo.nodeName = nodeInfo.variantNode.taskNodeName;
    nodeBindInfo.variantNode = variantNode;
    nodeBindInfo.variantProcess = variantProcess;
    nodeBindInfo.formId = hwTree.getSelectedItemId();

    return nodeBindInfo;



    // loadVmdFile("modules/hw38ca28ed/hw35989c15/hw2e8bdc0a.vmd");


}

var vmdPro = {};

function loadVmdFile(path) {

    if(!vmd.vmdUploadPath) {
        Ext.Msg.alert('出错', '请检查服务配置config.js')
        return
    }
    //默认加载登录测试页面
    var filename = path;
    var myMask = new Ext.LoadMask(Ext.getBody(), {
        msg: "模块加载中,请稍后...",
        msgCls: 'z-index:10000;'
    });
    var url = vmd.vmdUploadPath + 'FileService?FileName=' + filename;
    if(!filename) url = "templete/module.html";

    myMask.show();
    Ext.Ajax.request({
        url: url,
        timeout: 50000,
        success: function(result) {
            var res;
            try {
                res = Ext.util.JSON.decode(result.responseText);
                if(res.errMsg) {
                    Ext.Msg.alert('错误', res.errMsg);
                    return
                }
            } catch(ex) {
                res = {};
            }
            var vmd;
            try {
                vmd = Ext.util.JSON.decode(res.data);
                //事件
                vmdPro.events = vmd.vmdevents;
                //样式
                vmdPro.css = vmd.vmdcss;
                //特殊属性
                vmdPro.props = Ext.decode(vmd.vmdprops);
                vmdPro.vmdWorkFlow = Ext.decode(vmd.vmdWorkFlow);
            } catch(ex) {
                Ext.Msg.alert('反序列化失败', ex.message)
            }
            //结构
            var layout = {
                "components": [{
                    "cid": "viewport",
                    "name": "MyViewport",
                    "layoutConfig": {},
                    "userConfig": {
                        "layout": "absolute"
                    }
                }]
            }

            layout = {
                "components": [{
                    "cid": "viewport",
                    "name": "MyViewport",
                    "layoutConfig": {},
                    "userConfig": {
                        "layout": "absolute"
                    }
                }, {
                    "cid": "vmddataset"
                }, {
                    "cid": "vmdvariable"
                }]
            }
            if(vmd && vmd.vmdlayout) {
                // xds.vmd.layoutStr = vmd.vmdlayout;
                layout = Ext.util.JSON.decode(vmd.vmdlayout);
                //数据集
                if(!layout.components[1]) {
                    layout.components.push({
                        cid: 'vmddataset'
                    })
                }
                //变量
                if(!layout.components[2]) {
                    layout.components.push({
                        cid: 'vmdvariable'
                    })
                }
                vmdPro.layoutStr = Ext.encode(layout);
            }
            myMask.hide()
        },
        failure: function(result) {
            myMask.hide()
            Ext.Msg.alert('加载失败', '错误' + result.status + '：' + result.statusText)

        }

    })
}

function saveVmdFile(path, bodyStr, callback) {
    var myMask = new Ext.LoadMask(Ext.getBody(), {
        msg: "正在保存中,请稍后...",
        msgCls: 'z-index:10000;'
    });
    myMask.show();
    //默认保存登录测试页面
    var filename = path;
    var tastList = {
        vmdState: false,
        htmlState: false
    };
    var saveVmd = function(filename, bodyStr, taskName) {
        Ext.Ajax.request({
            url: vmd.vmdUploadPath + 'FileService',
            // defaultPostHeader: 'text/plain',
            timeout: 50000,
            success: function(result) {
                var res = Ext.util.JSON.decode(result.responseText);
                if(res.errMsg) {
                    //vmdstate = true;
                    tastList[taskName] = true;
                    Ext.Msg.alert('错误', res.errMsg);
                    return;
                }
                //Ext.Msg.alert('提示', '保存成功！');
                //vmdstate = true;
                tastList[taskName] = true;
                myMask.hide()
            },
            failure: function(result) {
                //vmdstate = true;
                tastList[taskName] = true;
                Ext.Msg.alert('错误', '网络超时，保存失败！')
                myMask.hide()

            },
            headers: {
                token: '',
                FileName: filename
            },
            params: {
                body: bodyStr
            }

        });
    }

    //module.html

    var readModuleTemplete = function(filename, codeStr, cls) {
        hwDas.ajax({
            das: false,
            url: xds.vmd.getReleasePath(),
            type: 'get',
            dataType: 'html',
            success: function(data) {
                //解析vmd为html文件
                var title = unescape(xds.vmd.params.name() || '')
                var html = String.format(data, codeStr, cls, title, xds.vmd.css || '');
                saveVmd(filename, html, "htmlState");
            },
            error: function(data) {
                Ext.Msg.alert('提示', '加载模块模版文件出错！');
            }
        })
    }

    saveVmd(filename, bodyStr, "vmdState")

    var page = xds.project.getJson()[0];
    var codeStr = SourceX.JonsScript(page);

    var cls = page.name;
    var htmlfile = filename.replace('.vmd', '.html');
    readModuleTemplete(htmlfile, codeStr, cls)


    var runner = new Ext.util.TaskRunner();
    var taskRun = function() {
        //vmd文件和html文件保存成功后才提示
        if(tastList.vmdState && tastList.htmlState) {
            Ext.Msg.alert('提示', '保存成功！', function() {
                if(callback) {
                    window.close()
                }
            });
            runner.stop(task); //停止 任务
            if(callback) callback();
        }
    }
    var task = {
        run: taskRun,
        interval: 100,
        duration: 5000
    }

    runner.start(task);



}

function hwTree_nodeClick(sender,id){
    var mytree=hwTree;
    var selnode = mytree.itemObj[id];
    if(selnode.isModel&&!mytree.isItemChecked(id))
    {
       mytree.setSubChecked(id,true)
    }
}

function hwTree_Check(sender,id,state){
     var mytree=hwTree;
   mytree.selectItem( id,true );
mytree.setSubChecked(id,true)
}
	}
})
        Ext.onReady(function () {
            Ext.create('vmd.module.MyViewport', {
                renderTo: document.body
            })


        })

      </script>
</head>
<body>
</body>
</html>
