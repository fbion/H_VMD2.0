<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>复合组件方法设置</title>
    <!--基本样式-->
    <link href="/css/common.css?ver=vmd2.0.5.191016" rel="stylesheet" />
    <!--加载dhx组件-->
    <link href="/lib/ext-3.4/resources/css/ext-all.css?ver=vmd2.0.5.191016" rel="stylesheet" />
    <link href="/design/css/icons.css?ver=vmd2.0.5.191016" rel="stylesheet" />
    <link href="/lib/dhtmlx/skins/material/dhtmlx.css?ver=vmd2.0.5.191016" rel="stylesheet" />
    <!--样式快捷索引表-->
    <link href="/css/shortcut.css?ver=vmd2.0.5.191016" rel="stylesheet" />
    <script src="/lib/labjs/LAB.min.js?ver=vmd2.0.5.191016"></script>
    <script src="/config.js?ver=vmd2.0.5.191016"></script>
    <script src="/lib/ext-3.4/adapter/ext/ext-base-debug.js?ver=vmd2.0.5.191016"></script>
    <script src="/lib/ext-3.4/adapter/ext/ext-base-lang.js?ver=vmd2.0.5.191016"></script>
    <script src="/lib/ext-3.4/adapter/ext/ext-base-class.js?ver=vmd2.0.5.191016"></script>
    <script src="/lib/ext-3.4/ext-all-debug.js?ver=vmd2.0.5.191016"></script>
    <script src="/lib/ext-3.4/src/locale/ext-lang-zh_CN.js?ver=vmd2.0.5.191016"></script>
    <script src="/js/util.js?ver=vmd2.0.5.191016"></script>
    <script src="/lib/dhtmlx/codebase/dhtmlx.js?ver=vmd2.0.5.191016"></script>
    <script src="/report/dhtmlx/dhtmlxCommon/codebase/dhtmlxcommon.js?ver=vmd2.0.5.191016"></script>
    <script src="/report/dhtmlx/dhtmlxCommon/codebase/dhtmlxcore.js?ver=vmd2.0.5.191016"></script>
    <script src="/report/dhtmlx/dhtmlxCommon/codebase/dhtmlxcontainer.js?ver=vmd2.0.5.191016"></script>
    <script src="/report/FillReport2.0/js/dhtmlx/dhtmlXFileUploader.js?ver=vmd2.0.5.191016"></script>
    <script src="/js/hwdas.js?ver=vmd2.0.5.191016"></script>
    <script src="/js/vmdcore.js?ver=vmd2.0.5.191016"></script>
    <script src="/js/vmdcomps.js?ver=vmd2.0.5.191016"></script>
    <script src="/js/publicMethods.js?ver=vmd2.0.5.191016"></script>
    <script src="/js/vmdreport.js?ver=vmd2.0.5.191016"></script>
    <script src="/system/modules/eQ9ULgcVb1/project.config.js"></script>
    <script src="/lib/ace/ace.js?ver=vmd2.0.5.191016"></script>
    <script src="/lib/ace/mode-base.js?ver=vmd2.0.5.191016"></script>
    <script src="/lib/ace/theme-xcode.js?ver=vmd2.0.5.191016"></script>
    <script src="/lib/ace/ext-language_tools.js?ver=vmd2.0.5.191016"></script>
    <script src="/lib/ace/ace.js?ver=vmd2.0.5.191016"></script>
    <script src="/lib/ace/mode-base.js?ver=vmd2.0.5.191016"></script>
    <script src="/lib/ace/theme-xcode.js?ver=vmd2.0.5.191016"></script>
    <script src="/lib/ace/ext-language_tools.js?ver=vmd2.0.5.191016"></script>
    <style> </style>
    <style type="text/css" id="vmdcss">
        li.info h4 {
            cursor: pointer
        }

        .code {
            font: 14px/normal 'Consolas'
        }

        .ace_code {

            border: 1px solid #dfdfdf;
        }

        .vmd-dataview ul {}

        .vmd-dataview ul li.info-hover {
            background-color: #CEEBFE;

        }

        .vmd-dataview ul li.x-view-selected {
            background-color: #20a0ff;
            color: #fff;
        }

        .maxdiv {
            position: relative !important;
            left: 0px !important;
            right: 0;
            float: right;
            border: 0px;
            color: #20a0ff;
            cursor: pointer;
            font-size: 18px !important;
            z-index: 99;

        }
    </style>
    <script>
        vmd.previewMode = true;
        vmd.virtualPath = '';
        vmd.workspace = {
            "workspaceid": "806246d0-e945-4c4d-b651-778f576723c9",
            "workflowIp": "",
            "dataServiceIp": "",
            "msgIp": "",
            "projectid": "eQ9ULgcVb1"
        }
        vmd.resourceSettings = {
            "资源中心&&资源中心服务器": "http://www.hanweikeji.com:10050/resource"
        }
        vmd.projectInfo = {
            "projectId": "eQ9ULgcVb1",
            "workflowIp": "",
            "dataServiceIp": "",
            "msgIp": "",
            "todoIp": "",
            "authIp": "",
            "docIp": "",
            "reoprtIp": "",
            "logIp": ""
        }
        Ext.define("vmd.module.MyViewport", {
            extend: "vmd.comp.viewport",
            requires: vmd.getCmpDeps([]),
            xtype: "vmd.module.MyViewport",
            layout: "fit",
            afterrender: "MyViewport_afterrender",
            initComponent: function() {
                //扩展校验类型
                Ext.apply(Ext.form.VTypes, {
                    definevar: function(val, field) {
                        return /^[a-z_A-Z]\w+$/.test(val);
                    },
                    //输出错误的提示信息
                    definevarText: '输入字符须字母、数字、下划线,以字母开头',
                    definevarMask: /[\w]/i
                });
                //默认追加状态
                var editorStatus = 'new';
                //ace 代码自动识别
                if (parent.init_def_platformControlData) {
                    parent.init_def_platformControlData();
                    def_platformControl = parent.def_platformControl
                }
                var propStore = new Ext.data.JsonStore({
                    proxy: new Ext.data.MemoryProxy(),
                    fields: ['id', 'zhname', 'bindCmp', 'bindValue', 'isPublic', 'desc', 'uxcid', 'params', 'code', 'returnType']
                });
                var cmpStore = new Ext.data.JsonStore({
                    proxy: new Ext.data.MemoryProxy(),
                    fields: ['cmpId']
                });
                var cmpPropStore = new Ext.data.JsonStore({
                    proxy: new Ext.data.MemoryProxy(),
                    fields: ['name']
                });
                var reqPropId = getUrlParam('id');
                //获取属性节点的数据
                if (parent.xds) {
                    var data = parent.xds.vmd.getMethodsData();
                    propStore.loadData(data);
                }
                //获取组件树
                var nodeList = [];
                var getAllCmpsByNode = function(node, nodeList) {
                    Ext.each(node.childNodes, function(item) {
                        var obj = {
                            cmpId: item.id
                        };
                        nodeList.push(obj);
                        getAllCmpsByNode(item, nodeList);
                    })
                }
                if (parent.xds) {
                    var viewRoot = parent.xds.inspector.root.childNodes[0];
                    getAllCmpsByNode(viewRoot, nodeList)
                }
                //cmpStore.loadData(nodeList);
                var refreshPropNode = function() {
                    var data = Ext.pluck(propStore.data.items, 'data');
                    parent.xds.vmd.addMethodNodes(data);
                }

                function button1_click(sender) {
                    parent.propWin.close()
                }

                function hwDataView_afterrender(sender) {
                    //属性列表加载
                    sender.setStore(propStore)
                    //选中传来的属性
                    if (reqPropId) {
                        var num = propStore.find('id', reqPropId)
                        if (num != -1) {
                            // sender.select(num)
                            var node = this.getNode(num);
                            Ext.defer(function() {
                                node.click()
                            }, 50)
                        }
                    }
                }

                function button2_click(sender) {
                    //新建
                    editorStatus = 'new';
                    hwDataView.clearSelections()
                    var rec = new propStore.recordType({
                        id: '',
                        zhname: '',
                        bindCmp: '',
                        bindValue: '',
                        desc: '',
                        code: '//直接填写方法内容',
                        params: '',
                        isPublic: true,
                        returnType: ''
                    });
                    MyForm.form.loadRecord(rec);
                }

                function button3_click(sender) {
                    //删除
                    var selectData = hwDataView.getSelectedRecords();
                    if (selectData.length == 0) {
                        Ext.Msg.alert('提示', '请选择要删除的方法！')
                        return
                    }
                    var selectindex = hwDataView.getSelectedIndexes()[0];
                    if (selectindex > 0) selectindex = selectindex - 1;
                    else selectindex = 0;
                    Ext.Msg.confirm('提示', '你确定要删除该方法吗?', function(type) {
                        if (type == 'yes') {
                            propStore.remove(selectData)
                            refreshPropNode()
                            //选择节点
                            var selectnode = hwDataView.getNode(selectindex);
                            selectnode.click()
                            vmd.alert('提示', '删除成功！');
                        }
                    })
                }

                function MyViewport_afterrender(sender) {
                    //数据加载完成？
                    parent.propWin && parent.propWin.loading.hide();
                }

                function button_click(sender) {
                    //保存
                    var form = MyForm.getForm();
                    var values = form.getValues();
                    var id = values.id;
                    var num;
                    var getCmpCid = function(cmpId) {
                        var cid = "";
                        var cmp = parent.xds.inspector.nodeHash[cmpId];
                        if (cmp) {
                            cid = cmp.component.cid;
                        }
                        return cid;
                    }
                    if (form.isValid()) {
                        values.code = Ext.getCmp('code').getValue();
                        values.returnType = Ext.getCmp('returnType').getValue();
                        // values.bindValue = Ext.getCmp('bindValue').getValue();
                        // values.uxcid = getCmpCid(values.bindCmp);
                        // delete values.dhxcombo
                        // delete values.dhxcombo_new_value
                        if (editorStatus == 'new') {
                            num = propStore.find('id', id)
                            var rec = new propStore.recordType(values);
                            if (num != -1) {
                                Ext.Msg.alert('提示', '名称为' + id + '的方法已存在，请修改方法名称！');
                                return;
                            }
                            propStore.add(rec);
                            //选中最后一条
                            var index = propStore.indexOf(rec);
                            var node = hwDataView.getNode(index);
                            node.click();
                            //vmd.alert('提示', '添加成功！');
                        } else {
                            //编辑状态
                            num = propStore.find('id', hwDataView.activeId)
                            // rec.store=propStore;
                            var rec = propStore.getAt(num);
                            propStore.reader.update(rec, values)
                            //propStore.commitChanges()
                            // vmd.alert('提示', '修改成功！');
                            //propStore.commitChanges()
                        }
                        refreshPropNode();
                        var myMask = new Ext.LoadMask(Ext.getBody(), {
                            msg: "正在保存中,请稍后...",
                            msgCls: 'z-index:70000;'
                        });
                        myMask.show();
                        parent.xds && parent.xds.project.save(function() {
                            myMask.hide();
                        });
                    } else {
                        Ext.Msg.alert('提示', '请检查必填项！')
                    }
                }

                function hwDataView_click(sender, index, node, e) {
                    editorStatus = 'edit';
                    var data = sender.getRecord(node).data;
                    var rec = new propStore.recordType(data);
                    sender.activeId = data.id;
                    MyForm.form.loadRecord(rec);
                }

                function bindCmp_change(sender) {
                    //绑定组件的属性
                    var val = sender.getValue();
                    var cmp = parent.xds.inspector.nodeHash[val];
                    if (!cmp) return;
                    var configs = cmp.component.configs.items;
                    //过滤事件
                    var propArr = [];
                    Ext.each(configs, function(item) {
                        if (item.group != '事件') {
                            var obj = {
                                name: item.name
                            }
                            propArr.push(obj);
                        }
                    })
                    cmpPropStore.loadData(propArr);
                }

                function maxdiv_click(sender, e) {
                    subView.show();
                    MyAce.setValue(code.getValue());
                }

                function subView_hide(sender) {
                    code.setValue(MyAce.getValue())
                }
                this.MyViewport_afterrender = MyViewport_afterrender;
                var subView = new vmd.comp.SubView({
                    view: {
                        xtype: "vmd.subview",
                        id: "subView",
                        width: 609,
                        height: 411,
                        layout: "fit",
                        closable: true,
                        draggable: false,
                        maximizable: true,
                        modal: true,
                        resizable: true,
                        autoScroll: false,
                        closeAction: "hide",
                        header: false,
                        title: "方法定义",
                        autoAdjust: true,
                        hide: "subView_hide",
                        listeners: {
                            hide: subView_hide
                        },
                        items: [{
                            xtype: "vmd.ace",
                            id: "MyAce",
                            height: 300,
                            width: 600,
                            language: "javascript"
                        }]
                    },
                    rootScope: this,
                    isModule: true
                })
                this.items = [{
                    xtype: "panel",
                    id: "panel",
                    title: "属性设置",
                    header: false,
                    border: false,
                    height: 410,
                    x: 0,
                    y: 0,
                    width: 760,
                    layout: "border",
                    unstyled: false,
                    items: [{
                            xtype: "panel",
                            id: "panel1",
                            title: "Panel",
                            header: false,
                            border: true,
                            height: 283,
                            region: "center",
                            layout: "fit",
                            cmargins: "",
                            padding: "10",
                            unstyled: false,
                            labelAlign: "left",
                            labelWidth: 60,
                            items: [{
                                xtype: "form",
                                id: "MyForm",
                                title: "Form Panel",
                                labelWidth: 70,
                                labelAlign: "left",
                                layout: "form",
                                header: false,
                                border: false,
                                items: [{
                                        xtype: "textfield",
                                        id: "id",
                                        allowBlank: false,
                                        enableKeyEvents: true,
                                        anchor: "100%",
                                        fieldLabel: "方法名称",
                                        emptyText: "请输入方法名称，须英文",
                                        cls: "code",
                                        vtype: "definevar"
                                    },
                                    {
                                        xtype: "textfield",
                                        id: "params",
                                        allowBlank: true,
                                        enableKeyEvents: true,
                                        anchor: "100%",
                                        fieldLabel: "方法参数",
                                        emptyText: "填写多个参数用逗号分开，如果param1,param2",
                                        cls: "code"
                                    },
                                    {
                                        xtype: "textarea",
                                        id: "desc",
                                        allowBlank: true,
                                        anchor: "100%",
                                        fieldLabel: "方法描述",
                                        emptyText: "请输入方法描述，便于代码编辑自动提示用",
                                        cls: "code"
                                    },
                                    {
                                        xtype: "checkboxstoregroup",
                                        id: "returnType",
                                        width: 400,
                                        height: 40,
                                        labelField: "label",
                                        valueField: "value",
                                        checkedField: "checked",
                                        boxFieldName: "mycheckbox",
                                        fieldLabel: "返回值类型",
                                        anchor: "",
                                        hidden: true,
                                        items: [{
                                                xtype: "checkbox",
                                                id: "hwCheckbox",
                                                boxLabel: "Void",
                                                checked: false,
                                                cls: "code",
                                                inputValue: "无"
                                            },
                                            {
                                                xtype: "checkbox",
                                                id: "hwCheckbox1",
                                                boxLabel: "String",
                                                inputValue: "字符串"
                                            },
                                            {
                                                xtype: "checkbox",
                                                id: "hwCheckbox2",
                                                boxLabel: "Number",
                                                inputValue: "数字"
                                            },
                                            {
                                                xtype: "checkbox",
                                                id: "hwCheckbox3",
                                                boxLabel: "Object",
                                                inputValue: "对象"
                                            }
                                        ]
                                    },
                                    {
                                        xtype: "vmd.div",
                                        id: "maxdiv",
                                        autoEl: "div",
                                        border: true,
                                        backgroundRepeat: "no-repeat",
                                        backgroundPosition: "top left",
                                        width: 18,
                                        height: 1,
                                        backgroundImage: "icon-resize-full",
                                        cls: "maxdiv",
                                        click: "maxdiv_click",
                                        listeners: {
                                            click: maxdiv_click
                                        }
                                    },
                                    {
                                        xtype: "vmd.ace",
                                        id: "code",
                                        height: 300,
                                        width: 600,
                                        language: "javascript",
                                        anchor: "100%",
                                        fieldLabel: "方法定义",
                                        value: "//直接填写方法内容",
                                        cls: "code ace_code"
                                    },
                                    {
                                        xtype: "checkbox",
                                        id: "isPublic",
                                        fieldLabel: "公共方法",
                                        anchor: "100%",
                                        checked: true,
                                        hidden: true
                                    }
                                ]
                            }]
                        },
                        {
                            xtype: "panel",
                            id: "panel2",
                            title: "Panel",
                            header: false,
                            border: true,
                            height: 100,
                            region: "west",
                            width: 179,
                            split: true,
                            animFloat: false,
                            collapsible: false,
                            frame: false,
                            hideCollapseTool: false,
                            floatable: true,
                            collapseMode: "mini",
                            hidden: false,
                            cmargins: "",
                            layout: "border",
                            items: [{
                                    xtype: "panel",
                                    id: "panel4",
                                    title: "Panel",
                                    header: false,
                                    border: false,
                                    height: 100,
                                    region: "center",
                                    layout: "fit",
                                    items: [{
                                        xtype: "vmd.dataview",
                                        id: "hwDataView",
                                        height: 270,
                                        itemSelector: "li.info",
                                        overClass: "info-hover",
                                        selectedClass: "x-view-selected",
                                        singleSelect: true,
                                        multiSelect: true,
                                        autoScroll: true,
                                        tpl: "<ul>    <tpl for=\".\">        <li class=\"info\" style=\"line-height:30px;padding-left:5px\">            <h4>{id}{[values.params?('('+values.params+')'):'']}</h4>        </li>    </tpl></ul>",
                                        data: "var data = [{    \"id\": 'getKsrq',    \"desc\": \"开始日期\",}, {    \"id\": 'getJsrq',    \"desc\": \"结束日期\"}];return data;",
                                        afterrender: "hwDataView_afterrender",
                                        click: "hwDataView_click",
                                        cls: "code",
                                        autoHeight: false,
                                        listeners: {
                                            vmdafterrender: hwDataView_afterrender,
                                            click: hwDataView_click
                                        }
                                    }]
                                },
                                {
                                    xtype: "panel",
                                    id: "panel5",
                                    layoutConfig: {
                                        align: "middle",
                                        pack: "center"
                                    },
                                    title: "Panel",
                                    header: false,
                                    border: false,
                                    height: 43,
                                    region: "north",
                                    unstyled: false,
                                    frame: false,
                                    layout: "hbox",
                                    bodyStyle: "border-bottom: 1px solid #99bbe8",
                                    items: [{
                                            xtype: "vmd.button",
                                            id: "button2",
                                            text: "新建",
                                            type: "(none)",
                                            size: "small",
                                            margins: "0 10",
                                            icon: "edit-outline",
                                            click: "button2_click",
                                            listeners: {
                                                click: button2_click
                                            }
                                        },
                                        {
                                            xtype: "vmd.button",
                                            id: "button3",
                                            text: "删除",
                                            type: "(none)",
                                            size: "small",
                                            icon: "delete",
                                            click: "button3_click",
                                            listeners: {
                                                click: button3_click
                                            }
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            xtype: "panel",
                            id: "panel3",
                            layoutConfig: {
                                align: "middle",
                                pack: "center"
                            },
                            title: "Panel",
                            header: false,
                            border: false,
                            height: 40,
                            region: "south",
                            layout: "hbox",
                            collapseMode: "standard",
                            frame: false,
                            items: [{
                                    xtype: "vmd.button",
                                    id: "button",
                                    text: "保存",
                                    type: "primary",
                                    size: "small",
                                    margins: "0 20",
                                    width: 80,
                                    click: "button_click",
                                    listeners: {
                                        click: button_click
                                    }
                                },
                                {
                                    xtype: "vmd.button",
                                    id: "button1",
                                    text: "关闭",
                                    type: "(none)",
                                    size: "small",
                                    width: 80,
                                    click: "button1_click",
                                    listeners: {
                                        click: button1_click
                                    }
                                }
                            ]
                        }
                    ]
                }]
                this.callParent();
                var me = this;
                vmd.core.moduleInit(this.items, this);
                me.on('afterrender', function() {
                    MyViewport_afterrender.call(me, me)
                })
            }
        })
        Ext.onReady(function() {
            Ext.create('vmd.module.MyViewport', {
                renderTo: document.body
            })
        })
    </script>
</head>

<body> </body>

</html>