<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>项目环境变量</title>
	<!--基本样式-->
    <link href="{vmdvirtualPath}/css/common.css?ver=vmd2.0.5.200306" rel="stylesheet" />
    <!--加载dhx组件-->
    <link href="{vmdvirtualPath}/lib/ext-3.4/resources/css/ext-all.css?ver=vmd2.0.5.200306" rel="stylesheet" />
   

	<link href="{vmdvirtualPath}/lib/dhtmlx/skins/material/dhtmlx.css?ver=vmd2.0.5.200306" rel="stylesheet" />
	  <!--样式快捷索引表-->
    <link href="{vmdvirtualPath}/css/shortcut.css?ver=vmd2.0.5.200306" rel="stylesheet" />
    
	{vmdprojectcssfiles}
    
    <script src="{vmdvirtualPath}/lib/labjs/LAB.min.js?ver=vmd2.0.5.200306"></script>
    <script src="{vmdvirtualPath}/config.js?ver=vmd2.0.5.200306"></script>
    <script src="{vmdvirtualPath}/lib/ext-3.4/adapter/ext/ext-base-debug.js?ver=vmd2.0.5.200306"></script>
    <script src="{vmdvirtualPath}/lib/ext-3.4/adapter/ext/ext-base-lang.js?ver=vmd2.0.5.200306"></script>
    <script src="{vmdvirtualPath}/lib/ext-3.4/adapter/ext/ext-base-class.js?ver=vmd2.0.5.200306"></script>
    <script src="{vmdvirtualPath}/lib/ext-3.4/ext-all-debug.js?ver=vmd2.0.5.200306"></script>
    <script src="{vmdvirtualPath}/lib/ext-3.4/src/locale/ext-lang-zh_CN.js?ver=vmd2.0.5.200306"></script>
    <script src="{vmdvirtualPath}/js/util.js?ver=vmd2.0.5.200306"></script>
    <script src="{vmdvirtualPath}/lib/dhtmlx/codebase/dhtmlx.js?ver=vmd2.0.5.200306"></script>
	
    <script src="{vmdvirtualPath}/js/hwdas.js?ver=vmd2.0.5.200306"></script>
    <script src="{vmdvirtualPath}/js/vmdcore.js?ver=vmd2.0.5.200306"></script>
    <script src="{vmdvirtualPath}/js/vmdcomps.js?ver=vmd2.0.5.200306"></script>
    <script src="{vmdvirtualPath}/js/publicMethods.js?ver=vmd2.0.5.200306"></script>
   
    
    {vmdworkspacePath}
	{vmdprojectconfigjs}
	
	{vmdprojectjsfiles}
    
    <style>

    </style>
    <style type="text/css" id="vmdcss">
        .x-grid3-row td {
    font-size: 14px;
}

.x-grid3-hd-row td {
    font-size: 14px;
}
    </style>
    <script>
	    
        vmd.virtualPath = '{vmdvirtualPath}';
        
        Ext.define("vmd.module.MainViewport" ,{
	extend:"vmd.comp.viewport",
	requires:vmd.getCmpDeps(["vmd.ux.Evars$1.0$Evars"]),
	xtype:"vmd.module.MainViewport",
	layout:"border",
	beforerender:"MainViewport_beforerender",
	initComponent: function(){
		var objInfoId = getUrlParam("id");

function Evars_beforerender(sender) {
    Evars.setProject_id(objInfoId)
    Evars.setParamvarStore(store1)
    Evars.setSysVarStore(store)
}

function store_load(sender, records, options) {
    var defaultSysVars = [{
        id: vmd.getGuid(),
        project_id: objInfoId,
        login: vmd.getUserId(),
        varname: "username",
        varvalue: "",
        remark: "用户名信息",
        type: "0"
    }, {
        id: vmd.getGuid(),
        project_id: objInfoId,
        login: vmd.getUserId(),
        varname: "userid",
        varvalue: "",
        remark: "用户id信息",
        type: "0"
    }, {
        id: vmd.getGuid(),
        project_id: objInfoId,
        login: vmd.getUserId(),
        varname: "ip",
        varvalue: "",
        remark: "ip地址信息",
        type: "0"
    }, {
        id: vmd.getGuid(),
        project_id: objInfoId,
        login: vmd.getUserId(),
        varname: "sysdate",
        varvalue: "",
        remark: "系统日期",
        type: "0"
    }];
    Ext.each(defaultSysVars, function(defaultvar) {
        var hasvarname = false;
        Ext.each(records, function(record) {
            if(defaultvar.varname == record.data.varname)
                hasvarname = true;
        })
        if(!hasvarname) {
            // 创建record行记录。 
            var record = vmd.data.Record.create(defaultvar);
            store.add(record)
        }
    })

    //添加系统变量，不能修改

    // var record1 = vmd.data.Record.create({
    //     id: vmd.getGuid(),
    //     project_id: objInfoId,
    //     login: vmd.getUserId(),
    //     varname: "isIE",
    //     varvalue: vmd.isIE,
    //     remark: "是否是IE",
    //     type: "3"
    // });
    // store.add(record1)

    // var record2 = vmd.data.Record.create({
    //     id: vmd.getGuid(),
    //     project_id: objInfoId,
    //     login: vmd.getUserId(),
    //     varname: "ieVersion",
    //     varvalue: vmd.ieVersion,
    //     remark: "IE版本",
    //     type: "3"
    // });
    // store.add(record2)

    // var record3 = vmd.data.Record.create({
    //     id: vmd.getGuid(),
    //     project_id: objInfoId,
    //     login: vmd.getUserId(),
    //     varname: "isChrome",
    //     varvalue: vmd.isChrome,
    //     remark: "是否为谷歌浏览器",
    //     type: "3"
    // });
    // store.add(record3)
    // var record4 = vmd.data.Record.create({
    //     id: vmd.getGuid(),
    //     project_id: objInfoId,
    //     login: vmd.getUserId(),
    //     varname: "isWebKit",
    //     varvalue: vmd.isWebKit,
    //     remark: "是否为webkit内核浏览器",
    //     type: "3"
    // });
    // store.add(record4)

    // var record5 = vmd.data.Record.create({
    //     id: vmd.getGuid(),
    //     project_id: objInfoId,
    //     login: vmd.getUserId(),
    //     varname: "vmdDasServer",
    //     varvalue: vmdSettings.dataServiceIp,
    //     remark: "vmd2.0数据服务地址",
    //     type: "3"
    // });
    // store.add(record5)
}

function MainViewport_beforerender(sender) {

}

function store1_load(sender, records, options) {}

function button_click(sender, e) {
    var successCount = 0;
    //处理系统变量
    var sysJson = [];
    var storejson = store.getJson()
    for(var i = 0; i < storejson.length; i++) {
        if(storejson[i].type == "0") {
            sysJson.push(storejson[i])
        }
    }
      var s = new vmd.proxy.Log();
        s.save("项目环境变量", objInfoId, Ext.util.Cookies.get('userName') + "在" + Ext.Date.dateFormat(new Date(), 'Y-m-d H:i:s') + "修改了" +  parent.btnProjectName.getText() + "项目的环境变量信息", "项目", function() {
            // alert("保存成功了！")
        }, function() {
            console.log("日志报存失败了！");
        })
    //批量保存系统变量
    hwDas.save("CDEServcie/var/hjbl", {}, {}, sysJson, function() {
        successCount += 1
        if(successCount >= 3) {
            Tips.tips("保存成功！", "success");
            if(parent)
                parent.reLoadEnvar()
        }
    }, function() {})
    //批量保存参数变量
    hwDas.save("CDEServcie/var/hjbl", {}, {}, store1.getJson(), function() {
        successCount += 1
        if(successCount >= 3) {
            Tips.tips("保存成功！", "success");
            if(parent)
                parent.reLoadEnvar()
        }
    }, function() {})
    //设置变量参数
    var runModelJson = [{
        id: vmd.getGuid(),
        project_id: objInfoId,
        login: vmd.getUserId(),
        varname: "runMode",
        varvalue: hwCheckbox.checked == true ? "test" : "normal",
        remark: "是否为webkit内核浏览器",
        type: "2"
    }, {
        id: vmd.getGuid(),
        project_id: objInfoId,
        login: vmd.getUserId(),
        varname: "debugStatus",
        varvalue: hwCheckbox1.checked == true ? "open" : "close",
        remark: "是否为webkit内核浏览器",
        type: "2"
    }];
    hwDas.save("CDEServcie/var/hjbl", {}, {}, runModelJson, function() {
        successCount += 1
        if(successCount >= 3) {
            Tips.tips("保存成功！", "success");
            if(parent)
                parent.reLoadEnvar()
        }
    }, function() {})
}

function store2_load(sender, records, options) {
    if(records.length > 0) {
        for(var i = 0; i < records.length; i++) {
            if(records[i].data.varname == "runMode" && records[i].data.varvalue == "test") {
                hwCheckbox.setValue(true)
                hwCheckbox1.setValue(true)
            }
            // if(records[i].data.varname == "debugStatus" && records[i].data.varvalue == "open") {
            //     hwCheckbox1.setValue(true)
            // }
        }
    }
}

function hwCheckbox_check(sender, checked) {
    hwCheckbox1.setValue(checked)
}

function button1_click(sender, e) {
    if(parent.formVarInfo)
        parent.formVarInfo.close()
}
			this.MainViewport_beforerender=MainViewport_beforerender;

		store=new vmd.store.jsonStore({listeners:{load:function(){store_load.apply(this,arguments);}},"xtype":"vmd.jsonStore","id":"store","xcls":"vmd.store.jsonStore","autoLoad":true,"cid":"vmdJsonStore","storeConfig":"{\"id\":\"mab92yXYIf\",\"callcode\":\"vmdCode\",\"url\":\"CDEServcie/var/hjbl\",\"host\":\"\",\"isHwRest\":true,\"name\":\"环境变量\",\"getMethods\":[{\"id\":\"type\",\"value1\":\"return \\\"0\\\"\",\"value2\":\"\"},{\"id\":\"login\",\"value1\":\"\",\"value2\":\"\"},{\"id\":\"project_id\",\"value1\":\"return getUrlParam(\\\"id\\\");\",\"value2\":\"\"}],\"postMethods\":[],\"putMethods\":[],\"deleteMethods\":[],\"saveMethods\":[],\"fields\":[{\"name\":\"id\",\"type\":\"string\"},{\"name\":\"project_id\",\"type\":\"string\"},{\"name\":\"login\",\"type\":\"string\"},{\"name\":\"varname\",\"type\":\"string\"},{\"name\":\"varvalue\",\"type\":\"string\"},{\"name\":\"type\",\"type\":\"string\"},{\"name\":\"ppdm_guid\",\"type\":\"string\"},{\"name\":\"remark\",\"type\":\"string\"},{\"name\":\"source\",\"type\":\"string\"},{\"name\":\"row_changed_by\",\"type\":\"string\"},{\"name\":\"row_changed_date\",\"type\":\"datetime\"},{\"name\":\"row_created_by\",\"type\":\"string\"},{\"name\":\"row_created_date\",\"type\":\"datetime\"},{\"name\":\"row_effective_date\",\"type\":\"datetime\"},{\"name\":\"row_expiry_date\",\"type\":\"datetime\"},{\"name\":\"row_quality\",\"type\":\"string\"}]}","load":"store_load"});
		store1=new vmd.store.jsonStore({listeners:{load:function(){store1_load.apply(this,arguments);}},"xtype":"vmd.jsonStore","id":"store1","xcls":"vmd.store.jsonStore","autoLoad":true,"cid":"vmdJsonStore","storeConfig":"{\"id\":\"mab92yXYIf\",\"callcode\":\"vmdCode\",\"url\":\"CDEServcie/var/hjbl\",\"host\":\"\",\"isHwRest\":true,\"name\":\"环境变量\",\"getMethods\":[{\"id\":\"type\",\"value1\":\"return \\\"1\\\"\",\"value2\":\"\"},{\"id\":\"login\",\"value1\":\"\",\"value2\":\"\"},{\"id\":\"project_id\",\"value1\":\"return getUrlParam(\\\"id\\\");\",\"value2\":\"\"}],\"postMethods\":[],\"putMethods\":[],\"deleteMethods\":[],\"saveMethods\":[],\"fields\":[{\"name\":\"id\",\"type\":\"string\"},{\"name\":\"project_id\",\"type\":\"string\"},{\"name\":\"login\",\"type\":\"string\"},{\"name\":\"varname\",\"type\":\"string\"},{\"name\":\"varvalue\",\"type\":\"string\"},{\"name\":\"type\",\"type\":\"string\"},{\"name\":\"ppdm_guid\",\"type\":\"string\"},{\"name\":\"remark\",\"type\":\"string\"},{\"name\":\"source\",\"type\":\"string\"},{\"name\":\"row_changed_by\",\"type\":\"string\"},{\"name\":\"row_changed_date\",\"type\":\"datetime\"},{\"name\":\"row_created_by\",\"type\":\"string\"},{\"name\":\"row_created_date\",\"type\":\"datetime\"},{\"name\":\"row_effective_date\",\"type\":\"datetime\"},{\"name\":\"row_expiry_date\",\"type\":\"datetime\"},{\"name\":\"row_quality\",\"type\":\"string\"}]}","load":"store1_load"});
		store2=new vmd.store.jsonStore({listeners:{load:function(){store2_load.apply(this,arguments);}},"xtype":"vmd.jsonStore","id":"store2","xcls":"vmd.store.jsonStore","autoLoad":true,"cid":"vmdJsonStore","storeConfig":"{\"id\":\"mab92yXYIf\",\"callcode\":\"vmdCode\",\"url\":\"CDEServcie/var/hjbl\",\"host\":\"\",\"isHwRest\":true,\"name\":\"环境变量\",\"getMethods\":[{\"id\":\"type\",\"value1\":\"return \\\"2\\\"\",\"value2\":\"\"},{\"id\":\"login\",\"value1\":\"\",\"value2\":\"\"},{\"id\":\"project_id\",\"value1\":\"return getUrlParam(\\\"id\\\");\",\"value2\":\"\"},{\"id\":\"module_id\",\"value1\":\"\",\"value2\":\"\"}],\"postMethods\":[],\"putMethods\":[],\"deleteMethods\":[],\"saveMethods\":[],\"fields\":[{\"name\":\"id\",\"type\":\"string\"},{\"name\":\"project_id\",\"type\":\"string\"},{\"name\":\"login\",\"type\":\"string\"},{\"name\":\"varname\",\"type\":\"string\"},{\"name\":\"varvalue\",\"type\":\"string\"},{\"name\":\"type\",\"type\":\"string\"},{\"name\":\"ppdm_guid\",\"type\":\"string\"},{\"name\":\"remark\",\"type\":\"string\"},{\"name\":\"source\",\"type\":\"string\"},{\"name\":\"row_changed_by\",\"type\":\"string\"},{\"name\":\"row_changed_date\",\"type\":\"datetime\"},{\"name\":\"row_created_by\",\"type\":\"string\"},{\"name\":\"row_created_date\",\"type\":\"datetime\"},{\"name\":\"row_effective_date\",\"type\":\"datetime\"},{\"name\":\"row_expiry_date\",\"type\":\"datetime\"},{\"name\":\"row_quality\",\"type\":\"string\"}]}","load":"store2_load"});


		this.items=[
			{
				xtype:"vmd.div",
				id:"div",
				autoEl:"div",
				border:false,
				backgroundRepeat:"no-repeat",
				backgroundPosition:"top left",
				width:400,
				height:50,
				region:"center",
				layout:"fit",
				items:[
					{
						xtype:"vmd.ux.Evars",
						id:"Evars",
						layout:"fit",
						beforerender:"Evars_beforerender",
						listeners:{
							beforerender:Evars_beforerender
						}
					}
				]
			},
			{
				xtype:"vmd.div",
				id:"div1",
				autoEl:"div",
				border:false,
				backgroundRepeat:"no-repeat",
				backgroundPosition:"top left",
				width:400,
				height:50,
				region:"south",
				layout:"border",
				items:[
					{
						xtype:"vmd.div",
						id:"div2",
						layoutConfig:{
							align:"middle",
							pack:"start"
						},
						autoEl:"div",
						border:false,
						backgroundRepeat:"no-repeat",
						backgroundPosition:"top left",
						width:400,
						height:50,
						region:"center",
						layout:"hbox",
						style:"color: #5f5f5f;    font-size: 14px",
						items:[
							{
								xtype:"checkbox",
								id:"hwCheckbox",
								fieldLabel:"Checkbox",
								boxLabel:"启用调试",
								margins:"0 0 0 20",
								style:"color:#5f5f5f;",
								hidden:false,
								check:"hwCheckbox_check",
								listeners:{
									check:hwCheckbox_check
								}
							},
							{
								xtype:"checkbox",
								id:"hwCheckbox1",
								fieldLabel:"Checkbox",
								boxLabel:"调试状态",
								margins:"0 0 0 20 ",
								hidden:true
							}
						]
					},
					{
						xtype:"vmd.div",
						id:"div3",
						layoutConfig:{
							align:"middle",
							pack:"end"
						},
						autoEl:"div",
						border:false,
						backgroundRepeat:"no-repeat",
						backgroundPosition:"top left",
						width:224,
						height:50,
						layout:"hbox",
						region:"east",
						items:[
							{
								xtype:"vmd.button",
								id:"button",
								text:"确定",
								type:"primary",
								size:"small",
								click:"button_click",
								width:70,
								style:"font-size: 14px",
								listeners:{
									click:button_click
								}
							},
							{
								xtype:"vmd.button",
								id:"button1",
								text:"关闭",
								type:"primary",
								size:"small",
								margins:"0 50 0 20",
								width:70,
								style:"font-size: 14px",
								click:"button1_click",
								listeners:{
									click:button1_click
								}
							}
						]
					}
				]
			}
		]
		this.callParent();
		var me = this;vmd.core.moduleInit(this.items, this);
			me.on('beforerender',function(){ MainViewport_beforerender.call(me,me)})
}
})
        Ext.onReady(function () {
            Ext.create('vmd.module.MainViewport', {
                renderTo: document.body
            })


        })

      </script>
</head>
<body>
</body>
</html>
