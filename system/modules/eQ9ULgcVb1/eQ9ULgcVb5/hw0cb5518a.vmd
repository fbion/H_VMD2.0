{"vmdversion":"vmd2.0.5.191228","vmdlayout":"{\"components\":[{\"cid\":\"viewport\",\"id\":\"MainViewport\",\"layoutConfig\":{},\"userConfig\":{\"layout\":\"border\",\"afterrender\":\"MainViewport_afterrender\"},\"cn\":[{\"cid\":\"container\",\"id\":\"div\",\"layoutConfig\":{},\"userConfig\":{\"x\":180,\"y\":70,\"region\":\"center\",\"layout\":\"border\",\"border\":false},\"cn\":[{\"cid\":\"container\",\"id\":\"div3\",\"layoutConfig\":{},\"userConfig\":{\"layout\":\"fit\",\"region\":\"center\",\"border\":false},\"cn\":[{\"cid\":\"vmdTreeEx\",\"id\":\"tree\",\"layoutConfig\":{},\"userConfig\":{\"parentField\":\"parentid\",\"valueField\":\"subsysid\",\"textField\":\"subsysname\",\"loadType\":\"全部加载\",\"rootText\":\"子系统\",\"rootValue\":\"0\",\"beforerender\":\"tree_beforerender\",\"hideRoot\":true,\"folderImg\":\"/system/modules/eQ9ULgcVb1/img/folderClosed.gif\",\"leafImg\":\"/system/modules/eQ9ULgcVb1/img/folderClosed.gif\"}}]},{\"cid\":\"container\",\"id\":\"div4\",\"layoutConfig\":{\"align\":\"middle\"},\"userConfig\":{\"region\":\"south\",\"layout\":\"hbox\"},\"cn\":[{\"cid\":\"label\",\"id\":\"label1\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"虚拟目录：\",\"margins\":\"0 5 0 20\",\"style\":\"font-size:14px;\"}},{\"cid\":\"textfield\",\"id\":\"hwText\",\"layoutConfig\":{},\"userConfig\":{\"width\":346,\"style\":\"font-size:14px;\"}}]}]},{\"cid\":\"container\",\"id\":\"div1\",\"layoutConfig\":{\"align\":\"middle\"},\"userConfig\":{\"x\":150,\"y\":150,\"region\":\"north\",\"layout\":\"hbox\"},\"cn\":[{\"cid\":\"label\",\"id\":\"label\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"发布服务选择：\",\"margins\":\"0 5 0 20\",\"style\":\"font-size:14px;\"}},{\"cid\":\"vmdCombo\",\"id\":\"combo\",\"layoutConfig\":{},\"userConfig\":{\"width\":363,\"store\":\"store\",\"valueField\":\"config_id\",\"displayField\":\"name\",\"change\":\"combo_change\",\"firstSelected\":true}}]},{\"cid\":\"container\",\"id\":\"div2\",\"layoutConfig\":{\"align\":\"middle\",\"pack\":\"end\"},\"userConfig\":{\"x\":300,\"y\":340,\"region\":\"south\",\"layout\":\"hbox\",\"border\":false},\"cn\":[{\"cid\":\"vmdButton\",\"id\":\"button\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"注册\",\"click\":\"button_click\",\"type\":\"primary\",\"margins\":\"0 30 0 0\"}}]}]},{\"cid\":\"vmddataset\",\"id\":\"数据\",\"layoutConfig\":{},\"userConfig\":{},\"cn\":[{\"cid\":\"vmdJsonStore\",\"id\":\"store\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"vmdJsonStore\",\"storeConfig\":\"{\\\"id\\\":\\\"mpXawNBWE3\\\",\\\"callcode\\\":\\\"vmdCode\\\",\\\"url\\\":\\\"CDEServcie/project/projectconfig/getpubresourcebymoduleid\\\",\\\"host\\\":\\\"\\\",\\\"isHwRest\\\":true,\\\"name\\\":\\\"通过模块id获取发布环境服务\\\",\\\"getMethods\\\":[{\\\"id\\\":\\\"id\\\",\\\"value1\\\":\\\"//返回值 \\\\nif(parent.hwTree) {\\\\n    var selPId = parent.hwTree.getSelectedItemId();\\\\n\\\\n    return selPId\\\\n} else\\\\n    return \\\\\\\"hw15de1381\\\\\\\"\\\",\\\"value2\\\":\\\"\\\",\\\"defaultvalue\\\":\\\"\\\"}],\\\"postMethods\\\":[],\\\"putMethods\\\":[],\\\"deleteMethods\\\":[],\\\"saveMethods\\\":[],\\\"fields\\\":[{\\\"name\\\":\\\"config_id\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"project_id\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"type\\\",\\\"type\\\":\\\"int32\\\"},{\\\"name\\\":\\\"name\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"ptservice\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"subsysid\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"virtualdir\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"dasserver\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"wfserver\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"msgserver\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"todoserver\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"authserver\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"docserver\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"reportserver\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"logserver\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"resourceserver\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"ppdm_guid\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"remark\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"source\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"row_changed_by\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"row_changed_date\\\",\\\"type\\\":\\\"datetime\\\"},{\\\"name\\\":\\\"row_created_by\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"row_created_date\\\",\\\"type\\\":\\\"datetime\\\"},{\\\"name\\\":\\\"row_effective_date\\\",\\\"type\\\":\\\"datetime\\\"},{\\\"name\\\":\\\"row_expiry_date\\\",\\\"type\\\":\\\"datetime\\\"},{\\\"name\\\":\\\"row_quality\\\",\\\"type\\\":\\\"string\\\"}]}\"},\"cn\":[{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"config_id\"},\"name\":\"config_id\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"project_id\"},\"name\":\"project_id\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"type\"},\"name\":\"type\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"name\"},\"name\":\"name\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"ptservice\"},\"name\":\"ptservice\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"subsysid\"},\"name\":\"subsysid\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"virtualdir\"},\"name\":\"virtualdir\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"dasserver\"},\"name\":\"dasserver\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"wfserver\"},\"name\":\"wfserver\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"msgserver\"},\"name\":\"msgserver\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"todoserver\"},\"name\":\"todoserver\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"authserver\"},\"name\":\"authserver\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"docserver\"},\"name\":\"docserver\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"reportserver\"},\"name\":\"reportserver\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"logserver\"},\"name\":\"logserver\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"resourceserver\"},\"name\":\"resourceserver\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"ppdm_guid\"},\"name\":\"ppdm_guid\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"remark\"},\"name\":\"remark\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"source\"},\"name\":\"source\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"row_changed_by\"},\"name\":\"row_changed_by\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"row_changed_date\"},\"name\":\"row_changed_date\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"row_created_by\"},\"name\":\"row_created_by\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"row_created_date\"},\"name\":\"row_created_date\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"row_effective_date\"},\"name\":\"row_effective_date\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"row_expiry_date\"},\"name\":\"row_expiry_date\"},{\"cid\":\"datafield\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"datafield\",\"name\":\"row_quality\"},\"name\":\"row_quality\"}]}]},{\"cid\":\"vmdvariable\",\"id\":\"变量\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdsubviewport\",\"id\":\"SubView_Window\",\"layoutConfig\":{},\"userConfig\":{}}]}","vmdevents":"var selrec;\n\nfunction combo_change(sender, value, text) {\n    var aa = store.query(\"config_id\", value)\n    var rec;\n    if (aa)\n        rec = aa.items[0]\n    selrec = aa.items[0]\n    bindtree(rec)\n    hwText.setValue(rec.data.virtualdir)\n}\nvar comData = [{\n    subsysname: \"\",\n    subsysid: \"\",\n    parentid: \"0\"\n}]\nvar substore = new vmd.data.Store({\n    data: comData,\n    fields: ['subsysname', 'subsysid', 'parentid']\n})\n\nfunction tree_beforerender(sender) {\n    tree.store = substore\n}\n\nfunction bindtree(rec) {\n    if (rec.data.ptservice) {\n        hwDas.get(rec.data.ptservice + \"/getsubsystem\", {}, {}, function(result) {\n            substore.loadData(result.data[0].datas);\n            if (rec.data.subsysid) {\n                var node = tree.getNodeById(rec.data.subsysid)\n                if (node) node.select()\n            }\n        }, function(msg) {\n            console.log(msg)\n        })\n    } else\n        vmd.alert(\"\", \"未配置平台服务。\")\n}\n\nfunction button_click(sender, e) {\n    var myPtree = parent.hwTree;\n    var selPId = parent.hwTree.getSelectedItemId();\n    var selNode = myPtree.itemObj[selPId];\n    var proId = selNode.projectId;\n     //虚拟目录获取\n    var virtualPath = \"\";\n    if (hwText.getValue() != \"\")\n        virtualPath = \"/\" + hwText.getValue();\n    \n    var resourceserver;\n    resourceserver = Ext.decode(selrec.data.resourceserver);\n    //记录模块中引用资源的替换信息\n    var objlistResourceNameIP = {};\n    for (var j = 0; j < defaultResource.length; j++) {\n        var tpath = defaultResource[j].ip;\n        for (var i = 0; i < resourceserver.length; i++) {\n            if (defaultResource[j].name == resourceserver[i].name)\n                tpath = (resourceserver[i].newip || selrec.data.dasserver || resourceserver[i].oldip);\n        }\n        objlistResourceNameIP[defaultResource[j].name] = \"http://\" + tpath + \"/\" + (vmdSettings.resourceCode || \"resource\");\n    }\n\n    //记录项目中的引用资源信息，包括脚本，样式\n    var projectRefJs = \"\";\n    var projectRefCss = \"\";\n    var userProjectConfigJs='<script src=\"'+ virtualPath +\"/release/\" + proId + '/project.config.js\"><\\/script>\\n';\n  \n    for (var i = 0; i < projectResourceInfo.length; i++) {\n        if (objlistResourceNameIP[projectResourceInfo[i].servName]) {\n            if (projectResourceInfo[i].ext == \"js\") {\n                projectRefJs += '<script src=\"' + objlistResourceNameIP[projectResourceInfo[i].servName] + '/' + projectResourceInfo[i].path + '\"><\\/script>\\n'\n            }\n            if (projectResourceInfo[i].ext == \"css\") {\n                projectRefCss += '<link href=\"' + objlistResourceNameIP[projectResourceInfo[i].servName] + '/' + projectResourceInfo[i].path + '\"/>\\n'\n            }\n        } else {\n            if (projectResourceInfo[i].ext == \"js\") {\n                projectRefJs += '<script src=\"' + projectResourceInfo[i].absolutePath + '\"><\\/script>\\n'\n            }\n            if (projectResourceInfo[i].ext == \"css\") {\n                projectRefCss += '<link href=\"' + projectResourceInfo[i].absolutePath + '\"/>\\n'\n            }\n        }\n    }\n    //将节点信息传递到设计页面\n    var selId = tree.getSelNodeId(); //mytree.getSelectedItemId();\n    if (!selId) {\n        Ext.Msg.alert(\"提示\", \"请选择模块要注册到的子系统！\", function() {})\n        return;\n    }\n    \n    var data = [{\n        subsysid: selId,\n        moduleguid: selNode.id,\n        modulename: selNode.text,\n        moudelinfo: selNode.remark,\n        moduletype: 1,\n        startname: \"/release\" + selNode.path + \".html\",\n        enable: 1,\n        args: \"\"\n    }];\n    var zcurl = selrec.data.ptservice + \"/regmodule\";\n   \n    //注册模块成功之后的逻辑处理 \n    var regSuccFun = function(result) {\n        var path = \"/modules\" + selNode.path + \"_r.html\";\n        var releasePath = \"release\" + selNode.path + \".html\";\n        createReleaseFun(path, releasePath, selNode.id, projectRefJs, projectRefCss,userProjectConfigJs)\n        var fileSetverConfig={host:vmdSettings.vmdFileServiceIp||vmdSettings.dataServiceIp,mark:\"vmd\"}\n        hwDas.copy(fileSetverConfig, \"modules/\" + proId + \"/img\", \"release/\" + proId + \"/img\", function() {}, function(msg) {\n            console.log(msg)\n        });\n        hwDas.copy(fileSetverConfig, \"modules/\" + proId + \"/css\", \"release/\" + proId + \"/css\", function() {}, function(msg) {\n            console.log(msg)\n        });\n        hwDas.copy(fileSetverConfig, \"modules/\" + proId + \"/js\", \"release/\" + proId + \"/js\", function() {}, function(msg) {\n            console.log(msg)\n        }); \n        hwDas.copy(fileSetverConfig, \"modules/\" + proId + \"/project.config.js\", \"release/\" + proId + \"/project.config.js\", function() {}, function(msg) {\n            console.log(msg)\n        });\n    }\n    //处理模块信息的递归处理\n    var createReleaseFun = function(path, releasePath, moduleid, projectRefJs, projectRefCss,userProjectConfigJs) {\n        vmd.core.createReleaseHtml(path, releasePath, virtualPath, function() { //调用服务获取当前模块是否存在子页面  通过moduleid进行服务处理\n            hwDas.get(\"CDEServcie/module/getchildmodule\", {}, {\n                mainmoduleid: moduleid\n            }, function(result) {\n                if (result.data.length > 0 && result.data[0].size > 0) {\n                    var count = 0,\n                        length = result.data[0].size;\n                    for (var i = 0; i < result.data[0].size; i++) {\n                        var r_path = result.data[0].datas[i].filepath;\n                        var r_moduleid = result.data[0].datas[i].id;\n                        vmd.core.createReleaseHtml(\"/modules\" + r_path + \"_r.html\", \"release\" + r_path + \".html\", virtualPath, function() {\n                            count++\n                            if (count == length)\n                                vmd.tip('注册模块成功！', 'success');\n                        }, objlistResourceNameIP, selNode.projectId, projectRefJs, projectRefCss,userProjectConfigJs)\n                    }\n                } else {\n                    vmd.tip('注册模块成功！', 'success');\n                }\n            }, function(msg) {\n                console.log(msg)\n            })\n        }, objlistResourceNameIP, selNode.projectId, projectRefJs, projectRefCss,userProjectConfigJs);\n    }\n    //调用服务进行平台模块注册\n    hwDas.ajax({\n        das: {\n            idedas: true\n        },\n        url: zcurl,\n        type: \"save\",\n        timeout: 5000,\n        data: data,\n        success: function(result) {\n            regSuccFun(result)\n        },\n        error: function(msg) {\n            Ext.Msg.alert(\"提示\", \"注册模块信息失败\", function() {})\n            parent.openWinFrom.hide();\n        }\n    })\n    // 保存配置信息\n    var saveVmdConfig = function(filename, bodyStr) {\n        Ext.Ajax.request({\n            url: vmd.vmdUploadPath + 'FileService',\n            timeout: 5000,\n            success: function(result) {},\n            failure: function(result) {\n                Ext.Msg.alert('错误', '网络超时，保存项目配置信息失败！')\n            },\n            headers: {\n                FileName: 'release/' + selNode.projectId + \"/\" + filename,\n            },\n            params: {\n                body: bodyStr\n            }\n        })\n    }\n    var bodyStr = 'vmd.workspace={\\n';\n    bodyStr += \"dataServiceIp: \\\"\" + selrec.data.dasserver + \"\\\",\\n\";\n    bodyStr += \"workflowIp: \\\"\" + selrec.data.wfserver + \"\\\",\\n\";\n    bodyStr += \"msgIp: \\\"\" + selrec.data.msgserver + \"\\\"\\n\";\n    bodyStr += '}' + \"\\n\";\n    bodyStr += 'vmd.projectInfo={\\n';\n    bodyStr += \"projectId: \\\"\" + selNode.projectId + \"\\\",\\n\";\n    bodyStr += \"dataServiceIp: \\\"\" + selrec.data.dasserver + \"\\\",\\n\";\n    bodyStr += \"workflowIp: \\\"\" + selrec.data.wfserver + \"\\\",\\n\";\n    bodyStr += \"msgIp: \\\"\" + selrec.data.msgserver + \"\\\",\\n\";\n    bodyStr += \"todoIp: \\\"\" + selrec.data.todoserver + \"\\\",\\n\";\n    bodyStr += \"authIp: \\\"\" + selrec.data.authserver + \"\\\",\\n\";\n    bodyStr += \"docIp: \\\"\" + selrec.data.docserver + \"\\\",\\n\";\n    bodyStr += \"reportIp: \\\"\" + selrec.data.reportserver + \"\\\",\\n\";\n    bodyStr += \"logIp: \\\"\" + selrec.data.logserver + \"\\\"\\n\";\n    bodyStr += '}' + \"\\n\";\n    //objlistResourceNameIP\n    bodyStr += 'vmd.resourceSettings={\\n';\n    for (g in objlistResourceNameIP) {\n        bodyStr += \"\\\"\" + g + \"\\\":\\\"\" + objlistResourceNameIP[g] + \"\\\",\\n\";\n    }\n    bodyStr += '}' + \"\\n\";\n    if (selrec.data.msgserver != \"\") {\n        bodyStr += \"if(typeof hwMSC!='undefined')\\n\";\n        bodyStr += \"    hwMSC.host=\\\"\" + selrec.data.msgserver + \"\\\"\\n\";\n    }\n    if (selrec.data.msgserver != \"\") {\n        bodyStr += \"hwDas.hosts=[\\\"\" + selrec.data.dasserver + \"\\\"]\\n\";\n    }\n    //处理项目的配置文件\n    saveVmdConfig(\"config.js\", bodyStr);\n}\nvar defaultResource = [];\n\nfunction MainViewport_afterrender(sender) {\n    //页面初始化完成之后，获取项目需要引用的资源\n    var myPartree = parent.hwTree;\n    var moduleId = parent.hwTree.getSelectedItemId();\n    //vmd.core.getProjectRefResource(moduleId, false, null, null)\n    vmd.core.getModuleResourceServices(moduleId, function(data) {\n        data.forEach(function(item, index) {\n            var resname = item.name\n            var serverInfo = item.children;\n            if (serverInfo) {\n                serverInfo.forEach(function(_item) {\n                    var obj = {\n                        name: resname + \"&&\" + _item.name,\n                        ip: _item.address\n                    }\n                    defaultResource.push(obj);\n                })\n            }\n        })\n    }, function() {}, false)\n}","vmdcss":"","vmdprops":"\"\"","type":"module","vmdresource":"{\"components\":[{\"cid\":\"vmdrescsss\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdresjss\",\"layoutConfig\":{},\"userConfig\":{},\"cn\":[{\"cid\":\"resjs\",\"id\":\"project.config.js\",\"layoutConfig\":{},\"userConfig\":{}}]},{\"cid\":\"vmdresimgs\",\"layoutConfig\":{},\"userConfig\":{}}]}"}