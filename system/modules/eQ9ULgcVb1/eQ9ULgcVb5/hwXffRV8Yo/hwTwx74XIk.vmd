{"vmdversion":"vmd2.0.5.200306","vmdlayout":"{\"components\":[{\"cid\":\"viewport\",\"id\":\"MainViewport\",\"layoutConfig\":{},\"userConfig\":{\"layout\":\"absolute\"},\"cn\":[{\"cid\":\"label\",\"id\":\"hwLabel\",\"layoutConfig\":{},\"userConfig\":{\"x\":190,\"y\":30,\"text\":\"选择要导出的项目镜像\",\"style\":\"font-size: 14px;\"}},{\"cid\":\"label\",\"id\":\"hwLabel1\",\"layoutConfig\":{},\"userConfig\":{\"x\":20,\"y\":70,\"text\":\"项目镜像列表：\",\"style\":\"font-size: 14px;\"}},{\"cid\":\"grid\",\"id\":\"MyGrid\",\"layoutConfig\":{},\"userConfig\":{\"x\":20,\"y\":90,\"width\":470,\"height\":190,\"header\":false,\"border\":true,\"style\":\"font-size: 14px;    border: 1px solid #c5c5c5\",\"enableHdMenu\":false,\"disableHeaderClick\":false,\"hideHeaders\":false,\"afterrender\":\"MyGrid_afterrender\",\"beforerender\":\"MyGrid_beforerender\",\"checked\":\"MyGrid_checked\",\"cellclick\":\"MyGrid_cellclick\"},\"cn\":[{\"cid\":\"checkcolumn\",\"layoutConfig\":{},\"userConfig\":{\"align\":\"center\",\"header\":\"选择\",\"width\":50,\"dataIndex\":\"sel\",\"fixed\":false},\"name\":\"sel\"},{\"cid\":\"gridcolumn\",\"layoutConfig\":{},\"userConfig\":{\"header\":\"镜像版本\",\"dataIndex\":\"ver\",\"width\":100,\"align\":\"center\"},\"name\":\"ver\"},{\"cid\":\"gridcolumn\",\"layoutConfig\":{},\"userConfig\":{\"header\":\"vmd镜像版本\",\"dataIndex\":\"vmdver\",\"width\":100,\"align\":\"center\"},\"name\":\"vmdver\"},{\"cid\":\"gridcolumn\",\"layoutConfig\":{},\"userConfig\":{\"header\":\"创建人\",\"dataIndex\":\"user\",\"width\":100},\"name\":\"user\"},{\"cid\":\"gridcolumn\",\"layoutConfig\":{},\"userConfig\":{\"dataIndex\":\"createtime\",\"header\":\"创建时间\"},\"name\":\"createtime\"}]},{\"cid\":\"label\",\"id\":\"hwLabel3\",\"layoutConfig\":{},\"userConfig\":{\"x\":20,\"y\":290,\"text\":\"项目说明：\",\"style\":\"font-size: 14px;\"}},{\"cid\":\"textarea\",\"id\":\"hwTextArea\",\"layoutConfig\":{},\"userConfig\":{\"x\":20,\"y\":310,\"width\":470,\"height\":80,\"readOnly\":true}},{\"cid\":\"vmdButton\",\"id\":\"button\",\"layoutConfig\":{},\"userConfig\":{\"x\":370,\"y\":410,\"text\":\"导出\",\"type\":\"primary\",\"click\":\"button_click\"}},{\"cid\":\"vmdButton\",\"id\":\"button1\",\"layoutConfig\":{},\"userConfig\":{\"x\":440,\"y\":410,\"text\":\"关闭\",\"click\":\"button1_click\"}}]},{\"cid\":\"vmddataset\",\"id\":\"数据\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdvariable\",\"id\":\"变量\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdsubviewport\",\"id\":\"SubView_Window\",\"layoutConfig\":{},\"userConfig\":{},\"cn\":[{\"cid\":\"vmdSubView\",\"id\":\"subView\",\"layoutConfig\":{},\"userConfig\":{\"cid\":\"vmdSubView\",\"width\":350,\"height\":303,\"layout\":\"fit\"},\"cn\":[{\"cid\":\"container\",\"id\":\"hwDiv\",\"layoutConfig\":{},\"userConfig\":{\"x\":70,\"y\":70}}]}]}]}","vmdevents":"var comData = [{\n    sel: false,\n    ver: \"20200226\",\n    vmdver: \"vmd2.0.6.200119\",\n    info: \"20200226_vmd2.0.6.200119_20200201\",\n    user: \"\",\n    createtime: \"\"\n}, {\n    sel: false,\n    ver: \"20200225\",\n    vmdver: \"vmd2.0.6.200119\",\n    info: \"20200226_vmd2.0.6.200119_20200201\",\n    user: \"\",\n    createtime: \"\"\n}, {\n    sel: false,\n    ver: \"20200224\",\n    vmdver: \"vmd2.0.6.200119\",\n    info: \"20200226_vmd2.0.6.200119_20200201\",\n    user: \"\",\n    createtime: \"\"\n}, {\n    sel: false,\n    ver: \"20200223\",\n    vmdver: \"vmd2.0.6.200119\",\n    info: \"20200226_vmd2.0.6.200119_20200201\",\n    user: \"\",\n    createtime: \"\"\n}]\nvar verstore = new vmd.data.Store({\n    data: comData,\n    fields: ['sel', 'ver', 'vmdver', 'prover', 'info', 'user', 'createtime']\n})\nvar imageServer = \"\"\nvar imageFileService = \"\"\nvar proVerInfo = [];\nvar proUpdateInfo = \"\"\nvar proCodeInfo = [];\nvar proCode = \"\";\n\nfunction MyGrid_afterrender(sender) {\n    //先获取镜像服务地址\n    var hwFao1 = new HwFao(vmdSettings.vmdFileServiceIp || vmdSettings.dataServiceIp, \"vmd\");\n    hwFao1.read(\"imageService.txt\", function(result) {\n        var imageConfig = JSON.parse(result.data)\n        imageServer = imageConfig.imageServiceIp || result.data\n        //imageServer = result.data\n        if (!imageServer)\n            Ext.Msg.alert(\"提示\", \"请先配置镜像服务地址后再操作！\", function() {})\n        //通过镜像服务获取文件服务地址\n        hwDas.ajax({\n            url: \"http://\" + imageServer + \"/VMDCI/initService\",\n            type: 'get',\n            timeout: 20000,\n            success: function(data) {\n                if (!data.result) {\n                    Ext.Msg.alert(\"提示\", \"获取镜像服务所需的文件服务地址失败！\", function() {});\n                    return;\n                }\n                imageFileService = data.data\n                if (!imageFileService) {\n                    Ext.Msg.alert(\"提示\", \"获取镜像服务所需的文件服务地址失败！\", function() {});\n                    return;\n                }\n                //通过文件服务获取对应目录下的文件列表信息\n                var hwFao = new HwFao(imageFileService, \"vmdcicd\");\n                hwFao.read(\"data/project/\" + vmd.getUrlParam(\"projectId\") + \"/verInfo.txt\", function(result) {\n                    if (result.data)\n                        proVerInfo = JSON.parse(result.data) || [];\n                    var storeData = []\n                    for (var i = 0; i < proVerInfo.length; i++) {\n                        storeData.push({\n                            sel: false,\n                            ver: proVerInfo[i].ver,\n                            vmdver: proVerInfo[i].vmdver,\n                            createtime: proVerInfo[i].createDate,\n                            //info: proVerInfo[i].info,\n                            user: proVerInfo[i].userName || proVerInfo[i].userId\n                        })\n                    }\n                    //更新数据\n                    verstore.loadData(storeData);\n                }, function() {})\n                //获取简写信息\n                hwFao.read(\"data/project/proInfo.txt\", function(result) {\n                    if (result.data) {\n                        proCodeInfo = JSON.parse(result.data) || [];\n                        for (var i = 0; i < proCodeInfo.length; i++) {\n                            if (proCodeInfo[i].projectId = vmd.getUrlParam(\"projectId\"))\n                                proCode = proCodeInfo[i].code;\n                        }\n                    }\n                }, function() {\n\n                })\n            },\n            error: function(msg) {\n                Ext.Msg.alert(\"提示\", \"获取镜像服务所需的文件服务地址失败！\", function() {});\n            }\n        })\n    }, function(result) {\n        Ext.Msg.alert(\"提示\", \"请先配置镜像服务地址后再操作！\", function() {})\n    })\n}\n\nfunction MyGrid_beforerender(sender) {\n    MyGrid.store = verstore;\n}\n\nfunction button_click(sender, e) {\n    var selname = \"\"\n    for (var i = 0; i < verstore.getCount(); i++) {\n        var rreacord = verstore.getAt(i)\n        if (rreacord.get(\"sel\")) {\n            selname = rreacord.get(\"ver\")\n        }\n    }\n    if (!selname) {\n        Ext.Msg.alert(\"提示\", \"请选择项目镜像！\", function() {})\n        return;\n    }\n\n    downPath = \"data/project/\" + vmd.getUrlParam(\"projectId\") + \"/\" + selname + \".tar\";\n    var hwFao = new HwFao(imageFileService, \"vmdcicd\");\n    var saveImage = function() {\n        var myMask = new Ext.LoadMask(Ext.getBody(), {\n            msg: \"正在导出项目镜像,请稍后...\",\n            msgCls: 'z-index:10000;'\n        });\n        myMask.show();\n        //文件不存在，则先调用服务save镜像再下载\n        vmd.ajax({\n            url: \"http://\" + imageServer + \"/VMDCI/saveImage/\" + proCode + \":\" + selname, //\"http://\" + imageServer + \"/VMDCI/saveImage/vmdrun:vmd2.0.6.200119\" ,//\n            type: 'post',\n            timeout: 5 * 60 * 1000,\n            data: {\n                SaveType: \"vmd_project\",\n                SaveVersion: vmd.getUrlParam(\"projectId\"),\n                ImageTar: selname + \".tar\"\n            },\n            success: function(data) {\n                myMask.hide();\n                if (data.result)\n                    hwFao.down(downPath, vmd.getUrlParam(\"projectName\") + \"_\" + selname + \".tar\", function(result) {}, function() {})\n                else\n                    Ext.Msg.alert(\"提示\", \"保存镜像文件失败，请联系管理员！错误：\" + data.data, function() {})\n            },\n            error: function() {\n                myMask.hide();\n                Ext.Msg.alert(\"提示\", \"保存镜像文件失败，请联系管理员！\", function() {})\n            }\n        })\n    }\n    //先判断文件是否存在，存在直接下载\n    hwFao.exist(downPath, function(result) {\n        if (result.data)\n            hwFao.down(downPath, vmd.getUrlParam(\"projectName\") + \"_\" + selname + \".tar\", function(result) {}, function() {})\n        else {\n            saveImage()\n        }\n    }, function() {\n        saveImage()\n    })\n}\nvar selrowIndex;\n\nfunction MyGrid_checked(sender, field, val, record, rowIndex, columnIndex, e) {\n    if (!record)\n        return;\n    selrowIndex = rowIndex;\n    for (var i = 0; i < verstore.getCount(); i++) {\n        var rreacord = verstore.getAt(i)\n        if (i != selrowIndex && selrowIndex >= 0)\n            rreacord.set(\"sel\", false)\n    }\n    verstore.commitChanges()\n}\n\nfunction MyGrid_cellclick(sender, rowIndex, columnIndex, e) {\n    if (rowIndex >= 0) {\n        var record = verstore.getAt(rowIndex)\n        var hwFao = new HwFao(imageFileService, \"vmdcicd\");\n        hwFao.read(\"data/project/\" + vmd.getUrlParam(\"projectId\") + \"/\" + record.get('ver') + \".txt\", function(result) {\n            hwTextArea.setValue(result.data)\n        }, function() {})\n    }\n}\n\nfunction button1_click(sender, e) {\n    if (parent && parent.downimagesWin)\n        parent.downimagesWin.close();\n    //记录日志信息 \n    //vmd.webBase.syslog(loginfo,logtype,operationtype,function(res){}) \n}","vmdcss":"","vmdprops":"\"\"","type":"module","vmdcmpdeps":[],"vmdresource":"{\"components\":[{\"cid\":\"vmdrescsss\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdresjss\",\"layoutConfig\":{},\"userConfig\":{},\"cn\":[{\"cid\":\"resjs\",\"id\":\"project.config.js\",\"layoutConfig\":{},\"userConfig\":{}}]},{\"cid\":\"vmdresimgs\",\"layoutConfig\":{},\"userConfig\":{}}]}"}