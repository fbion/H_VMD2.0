{"vmdversion":"2.0.4.190627","vmdlayout":"{\"components\":[{\"cid\":\"viewport\",\"id\":\"MainViewport\",\"layoutConfig\":{},\"userConfig\":{\"layout\":\"border\",\"afterrender\":\"MainViewport_afterrender\"},\"cn\":[{\"cid\":\"container\",\"id\":\"div\",\"layoutConfig\":{},\"userConfig\":{\"x\":100,\"y\":110,\"region\":\"center\",\"layout\":\"border\"},\"cn\":[{\"cid\":\"container\",\"id\":\"div5\",\"layoutConfig\":{},\"userConfig\":{\"region\":\"center\",\"border\":false,\"layout\":\"border\"},\"cn\":[{\"cid\":\"container\",\"id\":\"div7\",\"layoutConfig\":{},\"userConfig\":{\"region\":\"center\",\"layout\":\"fit\",\"border\":false,\"margins\":\"0 20 0 20\",\"style\":\"overflow-x: hidden\"},\"cn\":[{\"cid\":\"grid\",\"id\":\"MyGrid\",\"layoutConfig\":{},\"userConfig\":{\"border\":true,\"header\":false,\"style\":\"font-size: 14px;\",\"beforerender\":\"MyGrid_beforerender\",\"enableHdMenu\":false,\"disableHeaderClick\":false,\"hideHeaders\":false},\"cn\":[{\"cid\":\"gridcolumn\",\"layoutConfig\":{},\"userConfig\":{\"header\":\"序号\",\"dataIndex\":\"xh\",\"width\":50,\"align\":\"center\"},\"name\":\"xh\"},{\"cid\":\"gridcolumn\",\"layoutConfig\":{},\"userConfig\":{\"header\":\"名称\",\"dataIndex\":\"name\",\"align\":\"center\",\"width\":150},\"name\":\"name\"},{\"cid\":\"gridcolumn\",\"layoutConfig\":{},\"userConfig\":{\"header\":\"规则说明\",\"width\":330,\"align\":\"center\",\"dataIndex\":\"remark\",\"fixed\":false},\"name\":\"remark\"},{\"cid\":\"gridcolumn\",\"layoutConfig\":{},\"userConfig\":{\"dataIndex\":\"code\",\"hidden\":true},\"name\":\"code\"},{\"cid\":\"gridcolumn\",\"layoutConfig\":{},\"userConfig\":{\"dataIndex\":\"xml\",\"hidden\":true},\"name\":\"xml\"}]}]},{\"cid\":\"container\",\"id\":\"div8\",\"layoutConfig\":{\"align\":\"middle\"},\"userConfig\":{\"region\":\"north\",\"height\":44,\"layout\":\"hbox\",\"border\":false,\"style\":\"font-size: 14px;\"},\"cn\":[{\"cid\":\"vmdButton\",\"id\":\"button\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"添加\",\"type\":\"text\",\"icon\":\"plus\",\"margins\":\"0 0 0 20\",\"style\":\"font-size: 14px;\",\"click\":\"button_click\"}},{\"cid\":\"vmdButton\",\"id\":\"button1\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"编辑\",\"type\":\"text\",\"icon\":\"edit\",\"margins\":\"0 0 0 20\",\"style\":\"font-size: 14px;\",\"click\":\"button1_click\"}},{\"cid\":\"vmdButton\",\"id\":\"button2\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"删除\",\"type\":\"text\",\"icon\":\"delete\",\"margins\":\"0 0 0 20\",\"style\":\"font-size: 14px;\",\"click\":\"button2_click\"}},{\"cid\":\"vmdButton\",\"id\":\"button3\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"上移\",\"type\":\"text\",\"icon\":\"icon-arrow-up\",\"margins\":\"0 0 0 20\",\"style\":\"font-size: 14px;\",\"click\":\"button3_click\"}},{\"cid\":\"vmdButton\",\"id\":\"button4\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"下移\",\"icon\":\"icon-arrow-down\",\"type\":\"text\",\"margins\":\"0 0 0 20\",\"style\":\"font-size: 14px;\",\"click\":\"button4_click\"}}]}]},{\"cid\":\"container\",\"id\":\"div6\",\"layoutConfig\":{\"align\":\"middle\"},\"userConfig\":{\"region\":\"north\",\"height\":39,\"layout\":\"hbox\",\"border\":false},\"cn\":[{\"cid\":\"label\",\"id\":\"label1\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"规则定义：\",\"margins\":\"0 0 0 20\",\"style\":\"font-size: 14px;    font-weight: bold;    color: #5e5e5e;\"}}]}]},{\"cid\":\"container\",\"id\":\"div1\",\"layoutConfig\":{},\"userConfig\":{\"x\":660,\"y\":140,\"region\":\"west\",\"width\":200,\"layout\":\"border\",\"border\":true},\"cn\":[{\"cid\":\"container\",\"id\":\"div2\",\"layoutConfig\":{},\"userConfig\":{\"width\":230,\"region\":\"center\",\"border\":false,\"layout\":\"fit\"},\"cn\":[{\"cid\":\"vmdTreeEx\",\"id\":\"tree\",\"layoutConfig\":{},\"userConfig\":{\"parentField\":\"pid\",\"valueField\":\"id\",\"textField\":\"name\",\"loadType\":\"全部加载\",\"rootValue\":\"0\",\"rootText\":\"数据集\",\"hideRoot\":true,\"afterrender\":\"tree_afterrender\",\"beforerender\":\"tree_beforerender\",\"afterBindData\":\"tree_afterBindData\",\"nodeclick\":\"tree_nodeclick\",\"folderImg\":\"/system/modules/eQ9ULgcVb1/img/store.png\",\"leafImg\":\"/system/modules/eQ9ULgcVb1/img/column.png\"}}]},{\"cid\":\"container\",\"id\":\"div3\",\"layoutConfig\":{\"align\":\"middle\",\"pack\":\"start\"},\"userConfig\":{\"region\":\"north\",\"height\":39,\"layout\":\"hbox\",\"border\":false},\"cn\":[{\"cid\":\"label\",\"id\":\"label\",\"layoutConfig\":{},\"userConfig\":{\"text\":\" 字段列表：\",\"margins\":\"0 0 0 20\",\"style\":\"font-size: 14px;    font-weight: bold;    color: #5e5e5e;\"}}]}]},{\"cid\":\"container\",\"id\":\"div4\",\"layoutConfig\":{\"align\":\"middle\",\"pack\":\"end\"},\"userConfig\":{\"region\":\"south\",\"border\":true,\"layout\":\"hbox\"},\"cn\":[{\"cid\":\"vmdButton\",\"id\":\"button5\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"确定\",\"size\":\"small\",\"type\":\"primary\",\"icon\":\"icon-file-text\",\"margins\":\"0 50 0 0\",\"style\":\"font-size:14px;\",\"click\":\"button5_click\"}}]}]},{\"cid\":\"vmddataset\",\"id\":\"数据集\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdvariable\",\"id\":\"变量\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdsubviewport\",\"id\":\"SubView_Window\",\"layoutConfig\":{},\"userConfig\":{}}]}","vmdevents":"  var selNodeId = \"\"\r\n  var storename = getUrlParam(\"storename\")\r\n  var fieldname = getUrlParam(\"fieldname\")\r\n  var storeConfigStr = parent.rules_storeFileInfo;\r\n  var storeConfig = JSON.parse(storeConfigStr);\r\n  var fileDic = storeConfig.fields;\r\n\r\n\r\n  //构建树数据集\r\n  var comData = []\r\n  comData.push({\r\n      pid: \"0\",\r\n      id: storename,\r\n      name: storename + \"(\" + storeConfig.name + \")\"\r\n  })\r\n  for (var i = 0; i < fileDic.length; i++) {\r\n      comData.push({\r\n          pid: storename,\r\n          id: fileDic[i].name,\r\n          name: fileDic[i].name + \"(\" + fileDic[i].cname + \")\"\r\n      })\r\n  }\r\n  var treestore = new vmd.data.Store({\r\n      data: comData,\r\n      fields: ['pid', 'id', 'name']\r\n  })\r\n  //构建规则数据集\r\n  var ruleStore = new vmd.data.Store({\r\n      data: [],\r\n      fields: ['xh', 'name', 'remark', 'code', 'xml']\r\n  })\r\n\r\n  function MainViewport_afterrender(sender) {\r\n      if (fieldname) {\r\n          var node = tree.getNodeById(fieldname)\r\n          node.select()\r\n          tree_nodeclick(tree, node)\r\n          selNodeId = fieldname;\r\n      } else {\r\n          var node = tree.getNodeById(storename)\r\n          node.select()\r\n          tree_nodeclick(tree, node)\r\n          selNodeId = storename;\r\n      }\r\n  }\r\n\r\n  function tree_afterrender(sender) {\r\n      tree.expandAll()\r\n  }\r\n\r\n  function tree_beforerender(sender) {\r\n      tree.store = treestore;\r\n  }\r\n\r\n  function tree_afterBindData(sender) {}\r\n\r\n  function addRules(code, xml, name, remark) {\r\n      var xh = ruleStore.getCount() + 1;\r\n      var records = vmd.data.Record.create({\r\n          \"xh\": xh,\r\n          \"name\": name,\r\n          \"remark\": remark,\r\n          \"code\": code,\r\n          \"xml\": xml\r\n      });\r\n      ruleStore.add(records)\r\n      if (storename == selNodeId) {\r\n          if (!storeConfig.rules) storeConfig.rules = []\r\n          storeConfig.rules.push({\r\n              \"name\": name,\r\n              \"remark\": remark,\r\n              \"code\": code,\r\n              \"xml\": xml,\r\n          })\r\n      } else {\r\n          for (var i = 0; i < storeConfig.fields.length; i++) {\r\n              if (selNodeId == storeConfig.fields[i].name) {\r\n                  if (!storeConfig.fields[i].rules) storeConfig.fields[i].rules = []\r\n                  storeConfig.fields[i].rules.push({\r\n                      \"name\": name,\r\n                      \"remark\": remark,\r\n                      \"code\": code,\r\n                      \"xml\": xml\r\n                  });\r\n              }\r\n          }\r\n      }\r\n  }\r\n\r\n  function parserule() {\r\n\r\n      if (storename == selNodeId) {\r\n          storeConfig.rules = [];\r\n          for (var j = 0; j < ruleStore.getCount(); j++) {\r\n              storeConfig.rules.push({\r\n                  \"name\": ruleStore.getAt(j).get(\"name\"),\r\n                  \"remark\": ruleStore.getAt(j).get(\"remark\"),\r\n                  \"code\": ruleStore.getAt(j).get(\"code\"),\r\n                  \"xml\": ruleStore.getAt(j).get(\"xml\")\r\n              })\r\n          }\r\n      } else {\r\n          for (var i = 0; i < storeConfig.fields.length; i++) {\r\n              if (selNodeId == storeConfig.fields[i].name) {\r\n                  storeConfig.fields[i].rules = []\r\n                  for (var j = 0; j < ruleStore.getCount(); j++) {\r\n                      storeConfig.fields[i].rules.push({\r\n                          \"name\": ruleStore.getAt(j).get(\"name\"),\r\n                          \"remark\": ruleStore.getAt(j).get(\"remark\"),\r\n                          \"code\": ruleStore.getAt(j).get(\"code\"),\r\n                          \"xml\": ruleStore.getAt(j).get(\"xml\")\r\n                      })\r\n                  }\r\n              }\r\n          }\r\n      }\r\n  }\r\n\r\n  function edifRules(code, xml, name, remark) {\r\n      var selrecords = MyGrid.getSelectionModel().selections;\r\n      var selrecord = selrecords.items[0];\r\n      var editrecord = ruleStore.getById(selrecord.id)\r\n      editrecord.set(\"name\", name);\r\n      editrecord.set(\"xml\", xml);\r\n      editrecord.set(\"code\", code);\r\n      editrecord.set(\"remark\", remark);\r\n      if (storename == selNodeId) {\r\n          ;\r\n          storeConfig.rules = [];\r\n          for (var j = 0; j < ruleStore.getCount(); j++) {\r\n              storeConfig.rules.push({\r\n                  \"name\": ruleStore.getAt(j).get(\"name\"),\r\n                  \"remark\": ruleStore.getAt(j).get(\"remark\"),\r\n                  \"code\": ruleStore.getAt(j).get(\"code\"),\r\n                  \"xml\": ruleStore.getAt(j).get(\"xml\")\r\n              })\r\n          }\r\n      } else {\r\n          for (var i = 0; i < storeConfig.fields.length; i++) {\r\n              if (selNodeId == storeConfig.fields[i].name) {\r\n                  storeConfig.fields[i].rules = []\r\n                  for (var j = 0; j < ruleStore.getCount(); j++) {\r\n                      storeConfig.fields[i].rules.push({\r\n                          \"name\": ruleStore.getAt(j).get(\"name\"),\r\n                          \"remark\": ruleStore.getAt(j).get(\"remark\"),\r\n                          \"code\": ruleStore.getAt(j).get(\"code\"),\r\n                          \"xml\": ruleStore.getAt(j).get(\"xml\")\r\n                      })\r\n                  }\r\n              }\r\n          }\r\n      }\r\n  }\r\n\r\n  function button1_click(sender, e) {\r\n      if (parent && parent.rules_editWin) {\r\n          var selrecords = MyGrid.getSelectionModel().selections;\r\n          if (selrecords.items.length <= 0) return\r\n          var selrecord = selrecords.items[0];\r\n          parent.rules_editWin(tree.getSelNodeId(), {\r\n              name: selrecord.data.name,\r\n              remark: selrecord.data.remark,\r\n              code: selrecord.data.code,\r\n              xml: selrecord.data.xml\r\n          }, edifRules)\r\n      }\r\n  }\r\n\r\n  function button_click(sender, e) {\r\n      if (parent && parent.rules_editWin) {\r\n          parent.rules_editWin(tree.getSelNodeId(), \"\", addRules)\r\n      }\r\n  }\r\n\r\n  function ruleStoreorder(ruleStore) {\r\n      for (var i = 0; i < ruleStore.getCount(); i++) {\r\n          ruleStore.getAt(i).set(\"xh\", i + 1)\r\n      }\r\n  }\r\n\r\n  function button2_click(sender, e) {\r\n      var selrecords = MyGrid.getSelectionModel().selections;\r\n      if (selrecords.items.length <= 0) return\r\n      var selrecord = selrecords.items[0];\r\n      ruleStore.remove(ruleStore.getById(selrecord.id));\r\n      ruleStoreorder(ruleStore);\r\n      parserule()\r\n  }\r\n\r\n  function tree_nodeclick(sender, node, e) {\r\n      selNodeId = node.id;\r\n      ruleStore.removeAll();\r\n      var rules = [];\r\n      if (storename == selNodeId) {\r\n          rules = storeConfig.rules || [];\r\n          label1.setText(\"数据集 \" + node.text + \" 的规则定义\")\r\n      } else {\r\n          for (var i = 0; i < storeConfig.fields.length; i++) {\r\n              if (selNodeId == storeConfig.fields[i].name) {\r\n                  {\r\n                      rules = storeConfig.fields[i].rules || [];\r\n                      label1.setText(\"数据集 \" + node.text + \" 的规则定义\")\r\n                  }\r\n              }\r\n          }\r\n      }\r\n      var ruleData = [];\r\n      for (var i = 0; i < rules.length; i++) {\r\n          var record = vmd.data.Record.create({\r\n              xh: i + 1,\r\n              name: rules[i].name,\r\n              remark: rules[i].remark,\r\n              code: rules[i].code,\r\n              xml: rules[i].xml\r\n          });\r\n          ruleStore.add(record)\r\n      }\r\n  }\r\n\r\n  function MyGrid_beforerender(sender) {\r\n      MyGrid.store = ruleStore\r\n  }\r\n\r\n  function button5_click(sender, e) {\r\n      if (parent && parent.rules_changeFileInfo) {\r\n          parent.rules_changeFileInfo(JSON.stringify(storeConfig))\r\n      }\r\n  }\r\n\r\n  function button3_click(sender, e) {\r\n      var selrecords = MyGrid.getSelectionModel().selections;\r\n      if (selrecords.items.length <= 0) return\r\n      var selrecord = selrecords.items[0];\r\n      var insertindex = ruleStore.indexOf(selrecord) - 1;\r\n      if (insertindex < 0) return\r\n      ruleStore.remove(ruleStore.getById(selrecord.id));\r\n      ruleStore.insert(insertindex, selrecord)\r\n      ruleStoreorder(ruleStore);\r\n      parserule()\r\n  }\r\n\r\n  function button4_click(sender, e) {\r\n      var selrecords = MyGrid.getSelectionModel().selections;\r\n      if (selrecords.items.length <= 0) return\r\n      var selrecord = selrecords.items[0];\r\n      var insertindex = ruleStore.indexOf(selrecord) + 1;\r\n      if (insertindex >= ruleStore.getCount())\r\n          return\r\n      ruleStore.remove(ruleStore.getById(selrecord.id));\r\n      if (insertindex)\r\n          ruleStore.insert(insertindex, selrecord)\r\n      ruleStoreorder(ruleStore);\r\n      parserule()\r\n  }","vmdcss":"\n.x-grid3-hd-row td {\n    font: normal 14px arial, tahoma, helvetica, sans-serif;\n}\n.x-grid3-row td, .x-grid3-summary-row td {\n    font: normal 14px arial, tahoma, helvetica, sans-serif;\n}","vmdprops":"\"\"","type":"module","vmdresource":"{\"components\":[{\"cid\":\"vmdrescsss\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdresjss\",\"layoutConfig\":{},\"userConfig\":{},\"cn\":[{\"cid\":\"resjs\",\"id\":\"project.config.js\",\"layoutConfig\":{},\"userConfig\":{}}]},{\"cid\":\"vmdresimgs\",\"layoutConfig\":{},\"userConfig\":{}}]}"}