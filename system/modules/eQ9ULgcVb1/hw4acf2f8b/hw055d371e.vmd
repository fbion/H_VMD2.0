{"vmdversion":"2.0.3.20190219","vmdlayout":"{\"components\":[{\"cid\":\"viewport\",\"id\":\"MainViewport\",\"layoutConfig\":{},\"userConfig\":{\"layout\":\"border\",\"afterrender\":\"MainViewport_afterrender\"},\"cn\":[{\"cid\":\"container\",\"id\":\"div\",\"layoutConfig\":{},\"userConfig\":{\"x\":300,\"y\":100,\"region\":\"center\",\"height\":409,\"layout\":\"border\",\"border\":false},\"cn\":[{\"cid\":\"container\",\"id\":\"div2\",\"layoutConfig\":{},\"userConfig\":{\"region\":\"center\",\"layout\":\"border\",\"border\":false},\"cn\":[{\"cid\":\"container\",\"id\":\"div4\",\"layoutConfig\":{},\"userConfig\":{\"region\":\"center\",\"layout\":\"fit\",\"margins\":\"5 10 0 10\",\"border\":true},\"cn\":[{\"cid\":\"grid\",\"id\":\"MyGrid\",\"layoutConfig\":{},\"userConfig\":{\"enableHdMenu\":true,\"disableHeaderClick\":true,\"hideHeaders\":false,\"header\":false,\"border\":false,\"beforerender\":\"MyGrid_beforerender\"},\"cn\":[{\"cid\":\"numbercolumn\",\"layoutConfig\":{},\"userConfig\":{\"dataIndex\":\"xh\",\"header\":\"序号\",\"align\":\"center\",\"format\":\"0\",\"menuDisabled\":true,\"width\":50},\"name\":\"xh\"},{\"cid\":\"gridcolumn\",\"layoutConfig\":{},\"userConfig\":{\"header\":\"模块名称\",\"dataIndex\":\"moduleName\",\"menuDisabled\":true,\"width\":150},\"name\":\"moduleName\"},{\"cid\":\"gridcolumn\",\"layoutConfig\":{},\"userConfig\":{\"header\":\"模块ID\",\"dataIndex\":\"moduleId\",\"menuDisabled\":true,\"width\":150},\"name\":\"moduleId\"},{\"cid\":\"gridcolumn\",\"layoutConfig\":{},\"userConfig\":{\"header\":\"模块路径\",\"dataIndex\":\"modulePath\",\"menuDisabled\":true,\"width\":250},\"name\":\"modulePath\"},{\"cid\":\"templatecolumn\",\"layoutConfig\":{},\"userConfig\":{\"tpl\":\"<button class=\\\"vmd-button vmd-button--success vmd-button--small\\\" style=\\\"height:10px\\\">模块编辑</button>\",\"menuDisabled\":true,\"header\":\"操作\",\"align\":\"center\"},\"name\":\"MyColumn4\"}]}]},{\"cid\":\"container\",\"id\":\"div5\",\"layoutConfig\":{},\"userConfig\":{\"region\":\"north\",\"height\":37,\"border\":false,\"hidden\":true}}]},{\"cid\":\"container\",\"id\":\"div3\",\"layoutConfig\":{},\"userConfig\":{\"region\":\"north\",\"border\":false,\"style\":\"border-bottom: 1px #f2f2f2 solid\",\"layout\":\"border\",\"height\":35},\"cn\":[{\"cid\":\"container\",\"id\":\"div9\",\"layoutConfig\":{},\"userConfig\":{\"region\":\"west\",\"layout\":\"absolute\",\"border\":false},\"cn\":[{\"cid\":\"label\",\"id\":\"label\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"模块列表\",\"style\":\"font-size: 14px\",\"x\":5,\"y\":10}}]},{\"cid\":\"container\",\"id\":\"div10\",\"layoutConfig\":{\"align\":\"middle\",\"pack\":\"end\"},\"userConfig\":{\"region\":\"center\",\"layout\":\"hbox\",\"border\":false},\"cn\":[{\"cid\":\"vmdButton\",\"id\":\"button\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"添加模块\",\"icon\":\"icon-plus\",\"type\":\"text\",\"style\":\"margin-left: 20px;    margin-top: 5px\",\"click\":\"button_click\",\"margins\":\"0 20 0 0 \"}},{\"cid\":\"vmdButton\",\"id\":\"button1\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"删除模块\",\"icon\":\"icon-minus\",\"type\":\"text\",\"style\":\"margin-left: 20px;    margin-top: 5px\",\"click\":\"button1_click\",\"margins\":\"0 50 0 0\"}}]}]}]},{\"cid\":\"container\",\"id\":\"div1\",\"layoutConfig\":{},\"userConfig\":{\"x\":280,\"y\":250,\"region\":\"south\",\"height\":200,\"layout\":\"border\",\"border\":false},\"cn\":[{\"cid\":\"container\",\"id\":\"div6\",\"layoutConfig\":{},\"userConfig\":{\"region\":\"center\",\"border\":false,\"layout\":\"fit\",\"margins\":\"5 10 5 10\"},\"cn\":[{\"cid\":\"textarea\",\"id\":\"hwTextArea\",\"layoutConfig\":{},\"userConfig\":{}}]},{\"cid\":\"container\",\"id\":\"div7\",\"layoutConfig\":{},\"userConfig\":{\"region\":\"north\",\"border\":false,\"style\":\"border-bottom: 1px #f2f2f2 solid\",\"layout\":\"absolute\",\"height\":35},\"cn\":[{\"cid\":\"label\",\"id\":\"label1\",\"layoutConfig\":{},\"userConfig\":{\"style\":\"font-size: 14px\",\"text\":\"调用规则\",\"x\":5,\"y\":10}}]},{\"cid\":\"container\",\"id\":\"div8\",\"layoutConfig\":{\"align\":\"middle\",\"pack\":\"end\"},\"userConfig\":{\"region\":\"south\",\"border\":false,\"layout\":\"hbox\",\"style\":\"background-color: #f2f2f2\",\"height\":40},\"cn\":[{\"cid\":\"vmdButton\",\"id\":\"button2\",\"layoutConfig\":{},\"userConfig\":{\"margins\":\"0 20 0 0\",\"text\":\"保存\",\"type\":\"primary\",\"click\":\"button2_click\"}},{\"cid\":\"vmdButton\",\"id\":\"button3\",\"layoutConfig\":{},\"userConfig\":{\"margins\":\"0 20 0 0\",\"text\":\"关闭\",\"type\":\"(none)\",\"click\":\"button3_click\"}}]}]}]},{\"cid\":\"vmddataset\",\"id\":\"数据集\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdvariable\",\"id\":\"变量\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdsubviewport\",\"id\":\"SubView_Window\",\"layoutConfig\":{},\"userConfig\":{}}]}","vmdevents":"var selmodules = {\r\n    modulesInfo: [{\r\n        xh: \"1\",\r\n        moduleName: \"模拟流程\",\r\n        moduleId: \"hw34e2f623\",\r\n        modulePath: \"/hw34e2f623.html\"\r\n    }],\r\n    rule: \"\"\r\n}\r\n\r\nvar keyString = false;\r\n\r\nselmodules.modulesInfo = []\r\nvar obj = {}\r\nif(getUrlParam(\"type\") == \"1\") {\r\n    if(parent && parent.workflowSelnodeInfo) {\r\n        var obj = parent.workflowSelnodeInfo\r\n    }\r\n} else {\r\n    var strNodeModuleInfo\r\n    if(parent && parent.workflowSelnodeInfo) {\r\n        strNodeModuleInfo = parent.workflowSelnodeInfo.variantNode.formkeydefinition\r\n    }\r\n    if(strNodeModuleInfo) {\r\n        try {\r\n            obj = Ext.decode(strNodeModuleInfo);\r\n        } catch (ex) {\r\n            obj = strNodeModuleInfo\r\n        }\r\n    }\r\n}\r\nif(parent && parent.workflowSelnodeInfo) {\r\n    var newmodulesinfo = []\r\n    if(typeof(obj) == \"string\") {\r\n        keyString = true\r\n        var oldmoduleinfo = {\r\n            moduleId: obj,\r\n            moduleName: \"\",\r\n            modulePath: \"\"\r\n        }\r\n        selmodules.modulesInfo.push(oldmoduleinfo)\r\n    } else { //先判断有没有绑定该模块\r\n        if(obj.modulesInfo) {\r\n            for(var k = 0; k < obj.modulesInfo.length; k++) {\r\n                var moduleinfo = {\r\n                    xh: k + 1,\r\n                    moduleId: obj.modulesInfo[k].moduleId,\r\n                    moduleName: obj.modulesInfo[k].moduleName,\r\n                    modulePath: obj.modulesInfo[k].modulePath\r\n                }\r\n                selmodules.modulesInfo.push(moduleinfo)\r\n            }\r\n        }\r\n        selmodules.rule = obj.rule;\r\n\r\n    }\r\n}\r\n\r\nvar comData = selmodules.modulesInfo;\r\nvar _store = new vmd.data.Store({\r\n    data: comData,\r\n    fields: ['xh', 'moduleName', 'moduleId', 'modulePath']\r\n})\r\n\r\nfunction MainViewport_afterrender(sender) {\r\n    hwTextArea.setValue(selmodules.rule)\r\n}\r\n\r\n//编辑模块\r\nfunction moduleEdit(index) {\r\n    var record = MyGrid.store.getAt(index);\r\n    var moduelId = record.get(\"moduleId\")\r\n    //从服务中找到moduleId对应的模块 并打开编辑页面\r\n    hwDas.get(\"CDEServcie/module/info\", {}, {\r\n            id: moduelId\r\n        }, function(result) {\r\n            if(result.data[0].datas.length > 0) { //打开vmd编辑\r\n                hwDas.get(\"CDEServcie/module/file\", {}, {\r\n                        module_id: moduelId\r\n                    }, function(result1) {\r\n                        if(result1.data[0].datas.length > 0) { //打开vmd编辑\r\n                            var selWorkspaceid = vmd.workspace.workspaceid\r\n                            var params = {\r\n                                id: moduelId,\r\n                                name: result.data[0].datas[0].name,\r\n                                path: \"modules\" + result1.data[0].datas[0].filepath + '.vmd',\r\n                                workspaceid: selWorkspaceid\r\n                            }\r\n                            var url = vmd.virtualPath + '/design/default.html?' + Ext.urlEncode(params);\r\n                            if(vmd.isIE9) {\r\n                                var name = params.name\r\n                            } else {\r\n                                var name = params.name + \" 模块设计&workspaceid=\" + selWorkspaceid\r\n                            }\r\n                            window.open(url, name)\r\n                        } else {\r\n                            vmd.alert(\"提示\", \"vmd中找不到该定制页面，无法编辑！\")\r\n                        }\r\n                    },\r\n                    function() {}\r\n                )\r\n            } else {\r\n                vmd.alert(\"提示\", \"vmd中找不到该定制页面，无法编辑！\")\r\n            }\r\n        },\r\n        function() {}\r\n    )\r\n}\r\nwindow.moduleEdit = moduleEdit\r\n\r\nfunction MyGrid_beforerender(sender) {\r\n    this.store = _store\r\n    this.colModel.config[4].renderer = function(value, cellmeta, record) { //可以根据行字段的某个类型进行转换设置显示值\r\n        return '<button class=\"vmd-button vmd-button--text vmd-button--small \" style=\"height:10px;\"' +\r\n            'onclick=moduleEdit(' + record.store.indexOf(record) + ')>编辑模块</button>'\r\n    }\r\n}\r\n  var savemodulesInfo = function() {\r\n        selmodules.modulesInfo = []\r\n        for(var i = 0; i < MyGrid.store.getCount(); i++) {\r\n            var rec = MyGrid.store.getAt(i)\r\n            selmodules.modulesInfo.push({\r\n                moduleId: rec.data.moduleId,\r\n                moduleName: rec.data.moduleName,\r\n                modulePath: rec.data.modulePath\r\n            })\r\n        }\r\n        selmodules.rule = hwTextArea.getValue();\r\n\r\n        if(getUrlParam(\"type\") == \"1\") {\r\n            if(parent && parent.setWorkflowNodeModelInfo) {\r\n                parent.setWorkflowNodeModelInfo(Ext.encode(selmodules))\r\n                vmd.tip('设置成功', \"success\");\r\n            }\r\n        } else {\r\n            var selNodeId = \"\"\r\n            if(parent && parent.workflowSelnodeInfo) {\r\n                selNodeId = parent.workflowSelnodeInfo.variantNode.taskNodeid\r\n            } else\r\n                return\r\n            if(parent && parent.bindNodesForm) {\r\n                parent.bindNodesForm([{\r\n                    nodeId: selNodeId,\r\n                    modulesInfo: Ext.encode(selmodules)\r\n                }], function() {\r\n                    // 顶部浮动提示 \r\n                    vmd.tip('保存成功', \"success\");\r\n                })\r\n            }\r\n        }\r\n    }\r\n//确定操作 组织模块信息并存储到流程中\r\nfunction button2_click(sender, e) {\r\n    if(typeof(obj) == \"string\")\r\n        Ext.Msg.confirm(\"提示\", \"模块信息记录的为模块ID，确定后将修改为模块对象，待办获取模块部分需要进行相应的调整。确定要修改么？\", function(type) {\r\n            if(type == \"yes\") {\r\n                savemodulesInfo();\r\n            } else\r\n                return;\r\n        })\r\n    else\r\n        savemodulesInfo()\r\n  \r\n\r\n} //删除操作，删除后重新排列序号\r\nfunction button1_click(sender, e) {\r\n    var selmodel = MyGrid.getSelectionModel();\r\n    if(selmodel.getCount() > 0) {\r\n        MyGrid.store.remove(selmodel.getSelections()[0])\r\n    }\r\n    //重新设置序号\r\n    for(var i = 0; i < MyGrid.store.getCount(); i++) {\r\n        var rec = MyGrid.store.getAt(i);\r\n        MyGrid.store.getAt(i).set(\"xh\", i + 1)\r\n    }\r\n}\r\n\r\n//打开模版选择界面\r\nfunction button_click(sender, e) {\r\n    var moduleSelWin = new vmd.window({\r\n        title: \"模块选择\",\r\n        url: vmd.core.getVirtualPath() + \"/modules/eQ9ULgcVb1/hw4acf2f8b/hwac4371c9.html\",\r\n        auto: false,\r\n        height: 500,\r\n        width: 450,\r\n        maximizable: false,\r\n        enableLoading: true,\r\n        resizable: true,\r\n        params: {\r\n            projectid: vmd.getUrlParam(\"project_id\") || vmd.workspace.projectid,\r\n            r: new Date().getTime()\r\n        }\r\n    })\r\n    moduleSelWin.show();\r\n    window.moduleSelWin = moduleSelWin;\r\n}\r\n//添加模版选择界面选择的模版到数据集中\r\nfunction addSelModule(modules) {\r\n    var count = MyGrid.store.getCount();\r\n    for(var i = 0; i < modules.length; i++) {\r\n        var s_records = MyGrid.store.query(\"moduleId\", modules[i].moduleId)\r\n        if(s_records.items.length > 0) {\r\n            s_records.items[0].set(\"moduleName\", modules[i].moduleName)\r\n            s_records.items[0].set(\"modulePath\", modules[i].modulePath)\r\n        } else {\r\n            var count = MyGrid.store.getCount();\r\n            var record = vmd.data.Record.create({\r\n                xh: count + 1,\r\n                moduleId: modules[i].moduleId,\r\n                moduleName: modules[i].moduleName,\r\n                modulePath: modules[i].modulePath\r\n            })\r\n            MyGrid.store.add(record)\r\n        }\r\n    }\r\n}\r\nwindow.addSelModule = addSelModule;\r\n\r\n//关闭突出编辑界面\r\nfunction button3_click(sender, e) {\r\n    if(parent && parent.openSelModuleListWin)\r\n        parent.openSelModuleListWin.close()\r\n}","vmdcss":"","vmdprops":"\"\"","type":"module","vmdresource":"{\"components\":[{\"cid\":\"vmdrescsss\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdresjss\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdresimgs\",\"layoutConfig\":{},\"userConfig\":{}}]}"}