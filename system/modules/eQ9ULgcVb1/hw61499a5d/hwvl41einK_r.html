<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>复合组件管理</title>
	<!--基本样式-->
    <link href="{vmdvirtualPath}/css/common.css?ver=vmd2.0.6.200119" rel="stylesheet" />
    <!--加载dhx组件-->
    <link href="{vmdvirtualPath}/lib/ext-3.4/resources/css/ext-all.css?ver=vmd2.0.6.200119" rel="stylesheet" />
   
    <link href="{vmdvirtualPath}/design/css/icons.css?ver=vmd2.0.6.200119" rel="stylesheet" />

	<link href="{vmdvirtualPath}/lib/dhtmlx/skins/material/dhtmlx.css?ver=vmd2.0.6.200119" rel="stylesheet" />
	  <!--样式快捷索引表-->
    <link href="{vmdvirtualPath}/css/shortcut.css?ver=vmd2.0.6.200119" rel="stylesheet" />
    
	{vmdprojectcssfiles}
    
    <script src="{vmdvirtualPath}/lib/labjs/LAB.min.js?ver=vmd2.0.6.200119"></script>
    <script src="{vmdvirtualPath}/config.js?ver=vmd2.0.6.200119"></script>
    <script src="{vmdvirtualPath}/lib/ext-3.4/adapter/ext/ext-base-debug.js?ver=vmd2.0.6.200119"></script>
    <script src="{vmdvirtualPath}/lib/ext-3.4/adapter/ext/ext-base-lang.js?ver=vmd2.0.6.200119"></script>
    <script src="{vmdvirtualPath}/lib/ext-3.4/adapter/ext/ext-base-class.js?ver=vmd2.0.6.200119"></script>
    <script src="{vmdvirtualPath}/lib/ext-3.4/ext-all-debug.js?ver=vmd2.0.6.200119"></script>
    <script src="{vmdvirtualPath}/lib/ext-3.4/src/locale/ext-lang-zh_CN.js?ver=vmd2.0.6.200119"></script>
    <script src="{vmdvirtualPath}/js/util.js?ver=vmd2.0.6.200119"></script>
    <script src="{vmdvirtualPath}/lib/dhtmlx/codebase/dhtmlx.js?ver=vmd2.0.6.200119"></script>
	<script src="{vmdvirtualPath}/report/dhtmlx/dhtmlxCommon/codebase/dhtmlxcommon.js?ver=vmd2.0.6.200119"></script>
	<script src="{vmdvirtualPath}/report/dhtmlx/dhtmlxCommon/codebase/dhtmlxcore.js?ver=vmd2.0.6.200119"></script>
    <script src="{vmdvirtualPath}/report/dhtmlx/dhtmlxCommon/codebase/dhtmlxcontainer.js?ver=vmd2.0.6.200119"></script>
	<script src="{vmdvirtualPath}/report/FillReport2.0/js/dhtmlx/dhtmlXFileUploader.js?ver=vmd2.0.6.200119"></script>
    <script src="{vmdvirtualPath}/js/hwdas.js?ver=vmd2.0.6.200119"></script>
    <script src="{vmdvirtualPath}/js/vmdcore.js?ver=vmd2.0.6.200119"></script>
    <script src="{vmdvirtualPath}/js/vmdcomps.js?ver=vmd2.0.6.200119"></script>
    <script src="{vmdvirtualPath}/js/publicMethods.js?ver=vmd2.0.6.200119"></script>
    <script src="{vmdvirtualPath}/js/vmdreport.js?ver=vmd2.0.6.200119"></script>
    
    {vmdworkspacePath}
	{vmdprojectconfigjs}
	
	{vmdprojectjsfiles}
    
    <style>

    </style>
    <style type="text/css" id="vmdcss">
        .x-combo-list-item{
    margin: 5px 0
}
    </style>
    <script>
	    
        vmd.virtualPath = '{vmdvirtualPath}';
        
        Ext.define("vmd.module.MyViewport" ,{
	extend:"vmd.comp.viewport",
	requires:vmd.getCmpDeps(["vmd.ux.Uploader$1.0$Uploader","vmd.ux.UserControlInfo$1.0$UserControlInfo"]),
	xtype:"vmd.module.MyViewport",
	layout:"border",
	afterrender:"MyViewport_afterrender",
	initComponent: function(){
		//上次点击的节点
var bselNodeId = "";
//获取传递的设计模式
var allowedDesigner = false;
// 检索组件
var selectData = [],
    cateData = [];
var store = new Ext.data.JsonStore({
    proxy: new Ext.data.MemoryProxy(),
    fields: ['id', 'text']
});
//进度提示
var myMask = new Ext.LoadMask(Ext.getBody(), {
    msg: "数据加载中,请稍后...",
    msgCls: 'z-index:10000;'
});
// 数据服务地址
//初始化数据
function hwTree_afterrender(sender) {
    treeInit(sender)
    hwTree.attachEvent("onDrag", function(sId, tId, id, sObject, tObject) {
        console.log("sid:" + sId + ",tId:" + tId)
        var dragNode = hwTree.itemObj[sId];
        if (tId) {
            var trgNode = hwTree.itemObj[tId];
            if (dragNode.isFord && trgNode.isModel) {
                return false;
            } else if (dragNode.isModel && trgNode.isModel) {
                return false;
            } else {
                var mymessage = confirm("确定要移动到该节点下么?");
                return mymessage
                //return true;
            }
        } else
            return false
    });
    // hwTree.attachEvent("onDragIn", function(sId, tId, sObject, tObject) {

    // });
    hwTree.attachEvent("onDrop", function(sId, tId, id, sObject, tObject) {
        //通过服务修改数据
        hwTree.clearSelection();
        console.log("sid:" + sId + ",tId:" + tId + ",id:" + id)
        var dragNode = hwTree.itemObj[sId];
        if (dragNode.isModel) {
            if (sId === null || sId === "" || tId === "" || tId === null)
                Tips.tips("节点移动失败！", "error");
            else
                hwDas.edit("CDEServcie/resource/cmptreecmpdrag", {}, {
                    id: sId,
                    category_id: tId
                }, {}, function() {}, function() {})
        } else if (dragNode.isFord) {
            if (sId === null || sId === "" || tId === "" || tId === null)
                Tips.tips("节点移动失败！", "error");
            else
                hwDas.edit("CDEServcie/resource/cmptreecatedrag", {}, {
                    id: sId,
                    parent_id: tId
                }, {}, function() {}, function() {})
        } else
            return;
    });
}

function treeInit(sender) {
    myMask = new Ext.LoadMask(Ext.getCmp("hwTree").el, {
        msg: "数据加载中,请稍后...",
        msgCls: 'z-index:10000;'
    });
    myMask.show();
    var mytree = hwTree;
    var firstNode = "";
    mytree.deleteChildItems(0);
    mytree.loadJSONObject({
        id: 0,
        text: "我的复合组件",
        item: []
    });
    mytree.itemObj = {};
    mytree.newnode = false;
    mytree.enableDragAndDrop(true);
    hwDas.ajax({
        das: {
            idedas: true
        },
        url: "CDEServcie/resource/category",
        type: 'get',
        timeout: 50000,
        params: {
            parent_id: "0",
            type: "4"
        },
        success: function(result) {
            var datajson = result.data[0].datas;
            var treeDataJson = [];
            for (var i = 0; i < datajson.length; i++) {
                mytree.insertNewChild("0", datajson[i].id, datajson[i].name);
                mytree.setItemImage2(datajson[i].id, "tree/folderClosed.gif", "tree/folderOpen.gif", "tree/folderClosed.gif")
                mytree.insertNewChild(datajson[i].id, datajson[i].id + "-0", "");
                mytree.closeItem(datajson[i].id);
                var treenode = mytree.item(datajson[i].id);
                if (treenode) {
                    treenode.isFord = true;
                    treenode.loadChild = false;
                    treenode.path = "/0/" + datajson[i].id;
                }
                mytree.itemObj[datajson[i].id] = treenode;
            }
            myMask.hide();
            mytree.makeAllDraggable();
        },
        error: function(msg) {
            myMask.hide();
            Ext.Msg.alert("提示", "获取模块信息失败", function() {})
        }
    })
    //绑定右键菜单
    var menu = new dhtmlXMenuObject();
    menu.renderAsContextMenu();
    menu.attachEvent("onClick", onMenuClick);
    menu.addNewChild(menu.topId, 1, "newFord", "新建分类", false);
    menu.addNewChild(menu.topId, 2, "newMode", "新建复合组件", false);
    menu.addNewChild(menu.topId, 3, "copy", "复制", false);
    menu.addNewChild(menu.topId, 5, "paste", "粘帖", false);
    menu.addNewChild(menu.topId, 6, "delete", "删除", false);
    menu.addNewChild(menu.topId, 7, "exp", "导出", false);
    menu.addNewChild(menu.topId, 8, "imp", "导入", false);
    //mytree.enableDragAndDrop("temporary_disabled");
    mytree.enableContextMenu(menu);
    mytree.attachEvent("onBeforeContextMenu", function(itemId) {
        var mytree = hwTree;
        var selId = mytree.getSelectedItemId();
        var selnode = mytree.itemObj[selId];
        if (selnode.isProject) {
            menu.showItem('newFord');
            menu.hideItem('newMode');
            menu.hideItem('copy');
            menu.hideItem('paste');
            menu.hideItem('delete');
        } else if (selnode.isFord) {
            menu.showItem('newFord');
            menu.showItem('newMode');
            menu.hideItem('copy');
            menu.showItem('paste');
            menu.showItem('delete');
        } else if (selnode.isModel) {
            menu.hideItem('newFord');
            menu.hideItem('newMode');
            menu.showItem('copy');
            menu.hideItem('paste');
            menu.showItem('delete');
        }
        return true
    })
    //绑定右键事件 设置右键选中节点
    mytree.attachEvent('onRightClick', function(id) {
        mytree.selectItem(id);
    })
    var menu1 = new dhtmlXMenuObject();
    menu1.renderAsContextMenu();
    menu1.attachEvent("onClick", onMenuClick);
    menu1.addNewChild(menu1.topId, 1, "newFord", "新建分类", false);
    menu1.addNewChild(menu.topId, 7, "exp", "导出", false);
    menu1.addNewChild(menu.topId, 8, "imp", "导入", false);
    menu1.addContextZone(mytree.allTree);
    menu1.attachEvent("onShow", function(id) {
        mytree.clearSelection();
    });
}
window.treeInit = treeInit;

function hwTree_onOpenEnd(sender, id) {
    myMask.show();
    var proId = id;
    var mytree = hwTree;
    mytree.newnode = false;
    var hasChild = mytree.hasChildren(proId);
    var selnode = mytree.itemObj[proId];
    var selnodepath = selnode.path;
    var projectId = "";
    var childParentId = "0";
    childParentId = proId
    if (!selnode.loadChild && !selnode.isModel) {
        //绑定项目下的资源目录
        hwDas.ajax({
            das: {
                idedas: true
            },
            url: "CDEServcie/resource/category",
            type: 'get',
            timeout: 50000,
            params: {
                //project_id: projectId,
                parent_id: childParentId,
                type: "4"
            },
            success: function(result) {
                var datajson = result.data[0].datas;
                var treeDataJson = [];
                for (var i = 0; i < datajson.length; i++) {
                    mytree.insertNewChild(proId, datajson[i].id, datajson[i].name);
                    mytree.setItemImage2(datajson[i].id, "tree/folderClosed.gif", "tree/folderOpen.gif", "tree/folderClosed.gif")
                    mytree.insertNewChild(datajson[i].id, datajson[i].id + "-0", "");
                    mytree.closeItem(datajson[i].id);
                    var treenode = mytree.item(datajson[i].id);
                    treenode.path = selnodepath + "/" + datajson[i].id;
                    //treenode.projectId = projectId;
                    if (treenode) {
                        treenode.isFord = true;
                        treenode.loadChild = false;
                    }
                    mytree.itemObj[datajson[i].id] = treenode;
                }
                myMask.hide();
            },
            error: function(msg) {
                myMask.hide();
                Ext.Msg.alert("提示", "获取模块信息失败", function() {})
            }
        })
        if (!selnode.loadChild) {
            mytree.deleteItem(id + "-0", false);
        }
        selnode.loadChild = true;
        //获取项目下的资源
        hwDas.ajax({
            das: {
                idedas: true
            },
            url: "CDEServcie/resource/zygl",
            type: 'get',
            timeout: 50000,
            params: {
                category_id: childParentId,
                //project_id: projectId,
                type: "4"
            },
            success: function(result) {
                var datajson = result.data[0].datas;
                var treeDataJson = [];
                for (var i = 0; i < datajson.length; i++) {
                    mytree.insertNewChild(proId, datajson[i].id, datajson[i].name);
                    mytree.setItemImage2(datajson[i].id, "tree/model.png", "tree/model.png", "tree/model.png")
                    var treenode = mytree.item(datajson[i].id);
                    treenode.path = selnodepath + "/" + datajson[i].id;
                    //treenode.projectId = projectId;
                    if (treenode) {
                        treenode.isModel = true;
                        treenode.createuser = datajson[i].row_created_by;
                        treenode.createtime = datajson[i].row_created_date;
                        treenode.changetime = datajson[i].row_changed_date;
                        treenode.changeuser = datajson[i].row_changed_by;
                        treenode.uxname = datajson[i].uxname;
                        treenode.code = datajson[i].code;
                        treenode.version = datajson[i].version;
                        treenode.type = datajson[i].type;
                        treenode.shared = datajson[i].shared;
                        treenode.remark = datajson[i].remark;
                    }
                    mytree.itemObj[datajson[i].id] = treenode;
                }
                //数据操作  
                myMask.hide();
            },
            error: function(msg) {
                myMask.hide();
                Ext.Msg.alert("提示", "获取复合组件信息失败")
            }
        })
    } else {
        myMask.hide();
    }
}
//////////////////////////////////////////点击树节点操作
function hwTree_nodeClick(sender, id) {
    myMask.show();
    var proId = id;
    var mytree = hwTree;
    mytree.newnode = false;
    var hasChild = mytree.hasChildren(proId);
    var selnode = mytree.itemObj[proId];
    var selnodepath = selnode.path;
    var projectId = "";
    var childParentId = "0";
    if (bselNodeId != id) {
        if (selnode.isModel) {
            div.hide();
            UserControlInfo.show()
            UserControlInfo.refresh(hwTree);
            //document.getElementById("iframe_page").src = vmdSettings.systemPath+'/hw61499a5d/hw6000f88a.html';
        } else {
            div.show();
            UserControlInfo.hide()
            // document.getElementById("iframe_page").src = vmdSettings.systemPath+'/eQ9ULgcVb5/hw03cb4931.html';
        }
    }
    bselNodeId = id;
    myMask.hide();
}
//创建分类按钮操作
function creatFord() {
    var addford = function(fordname) {
        var mytree = hwTree;
        var selId = mytree.getSelectedItemId() || 0;
        var selnode = mytree.itemObj[selId];
        var selnodepath = selnode ? selnode.path || "" : "";
        var nodename = fordname;
        var newnodeid = newGuid(10);
        var newcode = newGuid(10);
        var xh = 10;
        hwDas.ajax({
            das: {
                idedas: true
            },
            url: "CDEServcie/resource/category",
            type: 'post',
            timeout: 50000,
            data: [{
                parent_id: selId,
                name: nodename,
                code: newcode,
                //project_id: projectId,
                id: newnodeid,
                xh: xh,
                type: "4"
            }],
            success: function(result) {
                mytree.insertNewChild(selId, newnodeid, nodename);
                mytree.setItemImage2(newnodeid, "tree/folderClosed.gif", "tree/folderOpen.gif", "tree/folderClosed.gif")
                var treenode = mytree.item(newnodeid);
                treenode.path = selnodepath + "/" + newnodeid;
                //treenode.projectId = projectId;
                if (treenode) {
                    treenode.isFord = true;
                }
                mytree.itemObj[newnodeid] = treenode;
            },
            error: function(msg) {
                Ext.Msg.alert("提示", "新建分类失败")
            }
        })
    }
    var fordname = new Ext.MyFordWin(addford);
    fordname.show();
}
//删除目录 模块信息
function button1_click(sender) {
    var mytree = hwTree;
    var selId = mytree.getSelectedItemId();
    var selnode = mytree.itemObj[selId];
    var haschild = mytree.hasChildren(selId);
    deleteNode();
}

function deleteNode() {
    var mytree = hwTree;
    var selId = mytree.getSelectedItemId();
    var selnode = mytree.itemObj[selId];
    var haschild = mytree.hasChildren(selId);
    //删除文件夹
    if (selnode.isFord) {
        if (haschild > 0) {
            Ext.Msg.alert("提示", "存在子分类或资源，请删除子分类或资源后再删除该目录")
            return
        }
        Ext.Msg.confirm("提示", "确认要删除分类吗！", function(type) {
            if (type == "yes") {
                hwDas.ajax({
                    das: {
                        idedas: true
                    },
                    url: "CDEServcie/resource/category",
                    type: 'delete',
                    timeout: 50000,
                    params: {
                        id: selId
                    },
                    success: function(result) {
                        mytree.deleteItem(selId, true);
                        getZJData();
                    },
                    error: function(msg) {
                        Ext.Msg.alert("提示", "删除分类失败")
                    }
                })
            }
        })
        return;
    }
    //删除模块
    if (selnode.isModel) {
        Ext.Msg.confirm("提示", "组件删除后将不可恢复,确认要删除该复合组件?", function(type) {
            if (type == "yes") {
                //先删除模块信息
                var runtype = [];
                myMask.show();
                hwDas.ajax({
                    das: {
                        idedas: true
                    },
                    url: "CDEServcie/resource/info",
                    type: 'delete',
                    timeout: 50000,
                    params: {
                        id: selId
                    },
                    success: function(result) {
                        mytree.deleteItem(selId); //, true);   
                        runtype.push(true)
                        if (runtype.length >= 3)
                            myMask.hide()
                        vmd.core.removeCmpFromList(selnode.text);
                        getZJData();
                    },
                    error: function(msg) {
                        runtype.push(false)
                        if (runtype.length >= 3)
                            myMask.hide()
                        Ext.Msg.alert("提示", "删除复合组件失败")
                        return
                    }
                })
                //删除模块文件对应关系
                hwDas.ajax({
                    das: {
                        idedas: true
                    },
                    url: "CDEServcie/resource/file",
                    type: 'delete',
                    timeout: 50000,
                    params: {
                        resource_id: selId
                    },
                    success: function(result) {
                        runtype.push(true)
                        if (runtype.length >= 3)
                            myMask.hide()
                    },
                    error: function(msg) {
                        runtype.push(false)
                        if (runtype.length >= 3)
                            myMask.hide()
                        Ext.Msg.alert("提示", "删除模块文件信息失败")
                    }
                })
                //删除复合组件文件  删除js vmd
                var hwFao_c = new HwFao(vmdSettings.vmdFileServiceIp, "vmd");
                hwFao_c.remove(
                    'components/ide/' + selnode.text + '.js,components/ux/' + selnode.text + ',components/vmd/' + selnode.text + '.vmd',
                    function(result) {
                        runtype.push(true)
                        if (runtype.length >= 3)
                            myMask.hide()
                    },
                    function(msg) {
                        runtype.push(false)
                        if (runtype.length >= 3)
                            myMask.hide()
                        Ext.Msg.alert("提示", "删除复合组件模块文件失败")
                    })
                /*
                hwDas.ajax({
                    host:vmdSettings.vmdFileServiceIp||vmdSettings.dataServiceIp,
                    das: {
                        idedas: false
                    },
                    url: 'FileService',
                    type: 'delete',
                    timeout: 50000,
                    params: {
                        FileName: 'components/ide/' + selnode.text + '.js,components/ux/' + selnode.text + ',components/vmd/' + selnode.text + '.vmd'
                    },
                    success: function(result) {
                        runtype.push(true)
                        if (runtype.length >= 3)
                            myMask.hide()
                    },
                    error: function(msg) {
                        runtype.push(false)
                        if (runtype.length >= 3)
                            myMask.hide()
                        Ext.Msg.alert("提示", "删除复合组件模块文件失败")
                    }
                })*/
            }
        })
        return;
    }
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//自定义自定义方法
function newGuid(len) {
    var length = 32;
    if (len)
        length = len - 2
    var guid = "";
    arr = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
    for (var i = 0; i < length; i++) {
        pos = Math.round(Math.random() * (arr.length - 1));
        guid += arr[pos];
    }
    return "hw" + guid;
}
//文件夹名称录入框
Ext.MyFordWin = Ext.extend(Ext.Window, {
    xtype: "window",
    title: "分类对话框",
    width: 300,
    height: 130,
    layout: "form",
    bodyStyle: 'padding:15px',
    labelAlign: "left",
    labelWidth: 40,
    constructor: function(callback) {
        this.callback = callback;
        this.callParent();
    },
    initComponent: function() {
        var me = this;
        this.fbar = [{
            text: "确定",
            handler: function() {
                me.callback(Ext.getCmp('filename').getValue())
                me.close()
            }
        }, {
            text: "取消",
            handler: function() {
                me.close()
            }
        }];
        this.items = [{
            id: 'filename',
            xtype: "textfield",
            fieldLabel: "名称",
            anchor: "100%"
        }]
        Ext.MyFordWin.superclass.initComponent.call(this);
    }
})
//右键菜单事件
function onMenuClick(menuitemId) {
    if (menuitemId == "newFord") {
        creatFord();
    } else if (menuitemId == "newMode") {
        hwTree.newnode = true;
        div.hide();
        UserControlInfo.show()
        UserControlInfo.refresh(hwTree);
        //document.getElementById("iframe_page").src = vmdSettings.systemPath+'/hw61499a5d/hw6000f88a.html';
    } else if (menuitemId == "delete") {
        button1_click();
    } else if (menuitemId == "copy") {
        nodeCopy();
    } else if (menuitemId == "cut") {
        // nodeCut();
    } else if (menuitemId == "paste") {
        nodePaste();
    } else if (menuitemId == "exp") {
        expUx();
    } else if (menuitemId == "imp") {
        impUx();
    }
}
///记录赋值或剪切的节点id
var copyNodeId = "";
///复制节点
function nodeCopy() {
    var mytree = hwTree;
    var selId = mytree.getSelectedItemId();
    copyNodeId = selId;
}
//粘帖节点
function nodePaste() {
    if (copyNodeId == "") {
        return;
    }
    //创建一个form，填写name，备注
    var copyNode = hwTree.itemObj[copyNodeId];
    var form = new Ext.form.FormPanel({
        labelAlign: "top",
        bodyStyle: "padding: 10px",
        border: false,
        items: [{
            xtype: "textfield",
            allowBlank: false,
            anchor: "100%",
            name: 'name',
            height: 30,
            regex: /^[A-Z][a-zA-Z0-9_]*$/,
            regexText: "名称须以大写字母开头，且只能包含数字、字母、下划线",
            fieldLabel: '将<span style="color:red;font-weight:bold">' + copyNode.text + '</span>复制为',
            emptyText: "请输入复合组件名称"
        }, {
            xtype: "textarea",
            allowBlank: true,
            name: 'remark',
            anchor: "100%",
            fieldLabel: "备注",
            emptyText: "请输入组件说明"
        }]
    })
    var win = new Ext.Window({
        width: 440,
        height: 260,
        title: '复合组件粘贴',
        hidden: false,
        layout: "fit",
        border: false,
        modal: true,
        items: form,
        fbar: [{
            text: '确定',
            handler: function() {
                if (form.getForm().isValid()) {
                    var values = form.form.getValues()
                    /*保存前校验*/
                    if (values.name == "" || values.remark == "") {
                        Ext.Msg.alert("提示", "组件名和备注不能为空")
                        return false;
                    }
                    saveModelInfo(copyNode.text, values.name, values.remark, function(result) {
                        var arr = ['img', 'css', 'file', 'js'];
                        // 复制组件下资源文件
                        var hwFao = new HwFao(vmdSettings.vmdFileServiceIp || vmdSettings.dataServiceIp, "vmd"); //地址:端口和存储标识(服务管理员分配)
                        arr.forEach(function(item, index) {
                            var filepath = 'components/ux/' + copyNode.text + '/' + copyNode.version + '/' + item;
                            var destPath = 'components/ux/' + result.text + '/' + result.version + '/' + item;
                            hwFao.copy(filepath, destPath, function(res) {
                                if (res.isSucceed) {
                                    var str = JSON.stringify(res.data);
                                    // alert(str);
                                } else {
                                    //Ext.Msg.alert("提示", res.errMsg);
                                }
                            }, function(res) {
                               // Ext.Msg.alert("提示", res);
                            });
                        })
                        copyNodeId = "";
                        win.close()
                    })
                }
            }
        }, {
            text: '取消',
            handler: function() {
                win.close()
            }
        }]
    });
    win.show()
    form.form.setValues({
        name: copyNode.text + '1'
    })
}

function expUx() {
    var nodepath;
    if (hwTree.getSelectedItemId() && hwTree.itemObj[hwTree.getSelectedItemId()])
        nodepath = hwTree.itemObj[hwTree.getSelectedItemId()].path;
    var expUxsWin = new vmd.window({
        title: "模块导出",
        url: vmd.core.getVirtualPath() + "/modules/eQ9ULgcVb1/hw61499a5d/hwOzCoaxTN.html",
        auto: false,
        height: 520,
        width: 500,
        maximizable: false,
        enableLoading: true,
        resizable: false,
        params: {
            nodepath: nodepath,
            r: new Date().getTime()
        }
    })
    expUxsWin.show();
    window.expUxsWin = expUxsWin;
}
var myMask;

function impUx() {
    var uploader = Uploader.getUploader();
    var uploaderwin = new vmd.window({
        items: Uploader,
        auto: false,
        height: 500,
        width: 655,
        maximizable: false,
        resizable: false,
        closeAction: 'hide',
        title: "文件上传"
    })
    Uploader.show()
    uploaderwin.show();
    uploaderwin.hide(); //上传接口
    uploader.upload(vmdSettings.vmdFileServiceIp || vmdSettings.dataServiceIp, "expandimp/expandimp/impuxs", uploaderwin, function(fileList) {
        //上传成功回调
        var state = true;
        var proName = "";
        var proId = "";
        var impPath = "";
        var impUser = "";
        var impDate = "";
        //组织导入项目信息
        if (fileList.length > 0) {
            if (fileList[0].state == 'SUCCESS') {
                state = true
                if (fileList[0].title.split(".").length == 2 && fileList[0].title.split(".")[1] == 'zip') {
                    var zipInfos = fileList[0].title.split("-");
                    impPath = "expandimp/impuxs/" + fileList[0].title;
                } else {
                    Ext.Msg.alert("提示", '导入标准的zip复合组件导出文件')
                    return;
                }
            } else
                return;
        }
        var importSer = function() {
            myMask = new Ext.LoadMask(document.body, {
                msg: "正在检测比对,请稍后...",
                msgCls: 'z-index:10000;'
            });
            myMask.show();
            //调用服务，解压文件，并在服务器端比对数据并返回。
            vmd.ajax({
                url: "/expandimp/api/uxcheck",
                type: 'post',
                timeout: 50000,
                //dataType:"jsonp",
                //dataType:"text",
                //contentType: 'application/json;charset=UTF-8',
                data: {
                    impUser: impUser,
                    impDate: impDate,
                    impPath: impPath
                },
                success: function(result) {
                    myMask.hide();
                    if (result.type == "success") {
                        //返回模块信息比对信息
                        window.UxsCheckInfos = {
                            checkInfo: result.checkInfo,
                            path: impPath,
                            impUser: impUser,
                            impDate: impUser
                        }
                        var UxsCheckWin = new vmd.window({
                            title: "导入复合组件对比",
                            url: vmd.core.getVirtualPath() + "/modules/eQ9ULgcVb1/hw61499a5d/hwdhrlDbxS.html",
                            auto: false,
                            height: 600,
                            width: 520,
                            maximizable: false,
                            enableLoading: true,
                            resizable: true,
                            params: {
                                categoryId: hwTree.getSelectedItemId(),
                                r: new Date().getTime()
                            }
                        })
                        uploaderwin.hide();
                        UxsCheckWin.show();
                        window.UxsCheckWin = UxsCheckWin;
                    } else
                        Ext.Msg.alert("提示", result.msg)
                },
                error: function(msg) {
                    myMask.hide();
                }
            })
        }
        importSer()
    }, "vmd")
}
//页面加载完后事件
function MyViewport_afterrender(sender) {
    div.show();
    UserControlInfo.hide();
    div.update("<iframe  id='iframe_page' src='" + vmd.core.getVirtualPath() + "/modules/eQ9ULgcVb1/eQ9ULgcVb5/hw03cb4931.html' width=100% height=100% frameborder=0  ></iframe>");
    MyPanel.hide();
    MyP_ModelTree.onBodyResize();
    getZJData();
}

function saveModelInfo(oldname, name, remark, callback) {
    var mytree = parent.hwTree;
    var newnode = mytree.newnode;
    var selId = mytree.getSelectedItemId();
    var selnode = mytree.itemObj[selId];
    var id = newGuid(10);
    var category_id = selId;
    //var Project_id = selnode.projectId;
    var codeid = newGuid(32);
    var name = name;
    var remark = remark;
    var type = "0";
    var copyNode = hwTree.itemObj[copyNodeId];
    //编辑
    checkName(name, function() {
        //保存模块基础信息
        var version = "1.0";
        hwDas.ajax({
            das: {
                idedas: true
            },
            url: "CDEServcie/resource/zygl",
            type: 'post',
            timeout: 50000,
            params: {},
            headers: {
                Ecylogin: Ext.util.Cookies.get('EcyLogin') || Ext.util.Cookies.get('ecyLogin')
            },
            data: [{
                editid: newGuid(10),
                id: id,
                code: codeid,
                type: '4',
                name: name,
                uxname: copyNode.uxname || "",
                edit_reason: remark,
                category_id: category_id,
                //project_id: Project_id,
                shared: "1",
                version: version,
                readdate: Ext.Date.dateFormat(new Date(), 'Y-m-d H:i:s'),
                filepath: '/components/vmd/' + name + '.vmd',
                row_created_by: Ext.util.Cookies.get('userName'),
                row_created_date: Ext.Date.dateFormat(new Date(), 'Y-m-d H:i:s'),
                remark: remark
            }],
            success: function(result) {
                mytree.insertNewChild(selId, id, name);
                mytree.setItemImage2(id, "tree/model.png", "tree/model.png", "tree/model.png")
                var treenode = mytree.item(id);
                //treenode.projectId = Project_id;
                if (treenode) {
                    treenode.isModel = true;
                    treenode.text = name;
                    treenode.uxname = copyNode.uxname || "";
                    treenode.createuser = Ext.util.Cookies.get('userName');
                    treenode.createtime = Ext.Date.dateFormat(new Date(), 'Y-m-d H:i:s');
                    treenode.changetime = Ext.Date.dateFormat(new Date(), 'Y-m-d H:i:s');
                    treenode.changeuser = Ext.util.Cookies.get('userName');
                    treenode.remark = remark;
                    treenode.version = version;
                    treenode.code = codeid;
                    treenode.type = '4';
                    treenode.shared = "1";
                    treenode.newnode = false;
                }
                mytree.itemObj[id] = treenode;
                mytree.selectItem(id, false, false);
                mytree.newnode = false;
                vmd.core.saveAsCmp(oldname, version, name, function() {
                    callback(treenode);
                })
                getZJData();
            },
            error: function(msg) {
                Ext.Msg.alert("提示", "复制复合组件信息失败")
                return;
            }
        })
    })
}

function checkName(name, callback) {
    hwDas.ajax({
        das: {
            idedas: true
        },
        url: "CDEServcie/resource/info",
        type: 'get',
        timeout: 50000,
        params: {
            name: name
        },
        success: function(result) {
            if (result.data[0].datas.length <= 0) {
                if (callback)
                    callback()
            } else {
                Ext.Msg.alert("提示", "该组件已存在，请重新命名组件！")
                return;
            }
        },
        error: function(msg) {
            Ext.Msg.alert("提示", "保存模块版本信息失败")
            return;
        }
    })
}
// 获取组建信息
function getZJData() {
    hwDas.ajax({
        das: {
            idedas: true
        },
        url: "CDEServcie/resource/zygl",
        type: 'get',
        timeout: 50000,
        params: {
            type: "4"
        },
        success: function(result) {
            var datajson = result.data[0].datas;
            for (var i = 0; i < datajson.length; i++) {
                if (datajson[i].uxname && datajson[i].uxname != '') {
                    datajson[i].text = datajson[i].name + '(' + datajson[i].uxname + ')'
                } else {
                    datajson[i].text = datajson[i].name
                }
            }
            selectData = datajson
            store.loadData(selectData);
            queryCom.bindStore(store)
            queryCom.setValue('');
        },
        error: function(msg) {
            myMask.hide();
            Ext.Msg.alert("提示", "获取复合组件信息失败")
        }
    })
    hwDas.ajax({
        das: {
            idedas: true
        },
        url: "CDEServcie/resource/category",
        type: 'get',
        timeout: 50000,
        params: {
            type: "4"
        },
        success: function(result) {
            var datajson = result.data[0].datas;
            cateData = datajson
            console.log(cateData)
        },
        error: function(msg) {
            myMask.hide();
            Ext.Msg.alert("提示", "获取复合组件信息失败")
        }
    })
}
// 组建检索
function queryCom_afterrender(sender) {
    store.loadData(selectData);
    queryCom.displayField = 'text';
    queryCom.valueField = 'id';
}

function queryCom_selectChanged(sender, combo, record, index) {
    var id = record.data.id;
    if (id == '' || id == null) {
        return
    }
    hwTree.closeAllItems()
    var cataId, pidArr = [],
        k = 0;
    for (var i = 0; i < selectData.length; i++) {
        if (selectData[i].id == id) {
            cataId = selectData[i].category_id;
            break
        }
    }
    if (cataId == '0') {
        hwTree.selectItem(id, true, false);
        return
    }
    pidArr.push(cataId);
    queryParen(pidArr, cataId)
    diGuiopen(pidArr, k, id)
}
// 查找被检索界面的所有父级分类，并按顺序放到数组中
function queryParen(arr, cId) {
    var pid;
    for (var i = 0; i < cateData.length; i++) {
        if (cateData[i].id == cId) {
            pid = cateData[i].parent_id;
        }
    }
    if (pid != '0') {
        arr.unshift(pid);
        queryParen(arr, pid)
    }
}
// 递归函数从祖父级开始逐层展开节点
function diGuiopen(arr, m, seleId) {
    if (m >= arr.length) {
        return
    }
    if (m == arr.length - 1) {
        // var isLoad = hwTree.itemObj[arr[m]].loadChild;
        if (hwTree.itemObj[arr[m]] && hwTree.itemObj[arr[m]].loadChild == true) {
            hwTree.openItem(arr[m])
            hwTree.selectItem(seleId, true, false);
        } else {
            OpenNOde(arr[m], function() {
                hwTree.selectItem(seleId, true, false);
            })
        }
    } else {
        // var isLoad = hwTree.itemObj[arr[m]].loadChild;
        if (hwTree.itemObj[arr[m]] && hwTree.itemObj[arr[m]].loadChild == true) {
            hwTree.openItem(arr[m])
            m++;
            diGuiopen(arr, m, seleId)
        } else {
            OpenNOde(arr[m], function() {
                m++;
                diGuiopen(arr, m, seleId)
            })
        }
    }
}

function OpenNOde(id, callback) {
    var proId = id;
    var mytree = hwTree;
    mytree.newnode = false;
    var hasChild = mytree.hasChildren(proId);
    var selnode = mytree.itemObj[proId];
    var selnodepath = selnode.path;
    var projectId = "";
    var childParentId = "0";
    childParentId = proId
    if (!selnode.loadChild && !selnode.isModel) {
        //绑定项目下的资源目录
        hwDas.ajax({
            das: {
                idedas: true
            },
            url: "CDEServcie/resource/category",
            type: 'get',
            timeout: 50000,
            params: {
                //project_id: projectId,
                parent_id: childParentId,
                type: "4"
            },
            success: function(result) {
                var datajson = result.data[0].datas;
                var treeDataJson = [];
                for (var i = 0; i < datajson.length; i++) {
                    mytree.insertNewChild(proId, datajson[i].id, datajson[i].name);
                    mytree.setItemImage2(datajson[i].id, "tree/folderClosed.gif", "tree/folderOpen.gif", "tree/folderClosed.gif")
                    mytree.insertNewChild(datajson[i].id, datajson[i].id + "-0", "");
                    mytree.closeItem(datajson[i].id);
                    var treenode = mytree.item(datajson[i].id);
                    treenode.path = selnodepath + "/" + datajson[i].id;
                    //treenode.projectId = projectId;
                    if (treenode) {
                        treenode.isFord = true;
                        treenode.loadChild = false;
                    }
                    mytree.itemObj[datajson[i].id] = treenode;
                }
                if (callback) {
                    callback();
                }
            },
            error: function(msg) {
                Ext.Msg.alert("提示", "获取模块信息失败", function() {})
            }
        })
        if (!selnode.loadChild) {
            mytree.deleteItem(id + "-0", false);
        }
        selnode.loadChild = true;
        //获取项目下的资源
        hwDas.ajax({
            das: {
                idedas: true
            },
            url: "CDEServcie/resource/zygl",
            type: 'get',
            timeout: 50000,
            params: {
                category_id: childParentId,
                //project_id: projectId,
                type: "4"
            },
            success: function(result) {
                var datajson = result.data[0].datas;
                var treeDataJson = [];
                for (var i = 0; i < datajson.length; i++) {
                    mytree.insertNewChild(proId, datajson[i].id, datajson[i].name);
                    mytree.setItemImage2(datajson[i].id, "tree/model.png", "tree/model.png", "tree/model.png")
                    var treenode = mytree.item(datajson[i].id);
                    treenode.path = selnodepath + "/" + datajson[i].id;
                    //treenode.projectId = projectId;
                    if (treenode) {
                        treenode.isModel = true;
                        treenode.createuser = datajson[i].row_created_by;
                        treenode.createtime = datajson[i].row_created_date;
                        treenode.changetime = datajson[i].row_changed_date;
                        treenode.changeuser = datajson[i].row_changed_by;
                        treenode.uxname = datajson[i].uxname;
                        treenode.code = datajson[i].code;
                        treenode.version = datajson[i].version;
                        treenode.type = datajson[i].type;
                        treenode.shared = datajson[i].shared;
                        treenode.remark = datajson[i].remark;
                    }
                    mytree.itemObj[datajson[i].id] = treenode;
                }
                if (callback) {
                    callback();
                }
            },
            error: function(msg) {
                Ext.Msg.alert("提示", "获取复合组件信息失败")
            }
        })
    } else {}
}
			this.MyViewport_afterrender=MyViewport_afterrender;



		this.items=[
			{
				xtype:"panel",
				id:"MyPanel_head",
				title:"Panel",
				header:false,
				border:true,
				height:60,
				x:0,
				y:0,
				layout:"border",
				bodyStyle:"background-color:skyblue;",
				region:"north",
				items:[
					{
						xtype:"panel",
						id:"MyPanel_logo",
						title:"Panel",
						header:false,
						border:false,
						height:100,
						region:"west",
						layout:"border",
						width:500,
						maskDisabled:true,
						bodyStyle:"background-color: #409EFF;",
						items:[
							{
								xtype:"vmd.div",
								id:"MyC_Logoimg",
								autoEl:"div",
								border:false,
								backgroundRepeat:"no-repeat",
								backgroundPosition:"top left",
								width:58,
								height:30,
								style:"margin-left: 20px;    margin-top: 5px;",
								x:0,
								y:0,
								region:"west",
								backgroundImage:"/system/modules/eQ9ULgcVb1/img/复合组件1.png"
							},
							{
								xtype:"label",
								id:"MyLb_name",
								text:"复合组件管理",
								x:70,
								y:10,
								style:"font-size: 26px;    color: #ffffff;    margin-left: 20px;    margin-top: 4px;",
								region:"center",
								split:false,
								cls:"lineHeight200"
							}
						]
					},
					{
						xtype:"panel",
						id:"MyPanel7",
						title:"Panel",
						header:false,
						border:false,
						height:100,
						region:"center",
						style:"background-color: #1e7fff;",
						bodyStyle:"background-color: #409EFF"
					}
				]
			},
			{
				xtype:"panel",
				id:"MyP_info",
				title:"Panel",
				header:false,
				border:true,
				height:640,
				x:0,
				y:60,
				layout:"border",
				region:"center",
				items:[
					{
						xtype:"panel",
						id:"MyP_ModelTree",
						title:"Panel",
						header:false,
						border:true,
						height:639,
						width:220,
						layout:"border",
						x:0,
						y:0,
						region:"west",
						style:"background-color: white;    padding-top: 5px;",
						bodyStyle:" background-color: white;",
						split:true,
						floatable:false,
						collapseMode:"mini",
						collapsible:true,
						items:[
							{
								xtype:"panel",
								id:"MyPanel",
								title:"Panel",
								header:false,
								border:false,
								height:22,
								x:60,
								y:110,
								layout:"border",
								width:220,
								region:"north",
								style:"margin-left: 5px;    margin-top: 5px;    padding-right: 10px;",
								hidden:true,
								items:[
									{
										xtype:"textfield",
										id:"MyF_searchtext",
										allowBlank:true,
										enableKeyEvents:true,
										x:0,
										y:0,
										width:200,
										region:"center"
									},
									{
										xtype:"vmd.button",
										id:"btn_search",
										type:"(none)",
										size:"mini",
										x:190,
										y:0,
										icon:"search",
										width:23,
										region:"east",
										style:"border-radius: 0px;",
										margins:""
									}
								]
							},
							{
								xtype:"panel",
								id:"panel",
								title:"Panel",
								header:false,
								border:false,
								height:30,
								region:"north",
								layout:"fit",
								items:[
									{
										xtype:"vmd.comlist",
										id:"queryCom",
										width:350,
										height:270,
										afterrender:"queryCom_afterrender",
										selectChanged:"queryCom_selectChanged",
										style:"font-size: 13px;",
										listeners:{
											vmdafterrender:queryCom_afterrender,
											selectChanged:queryCom_selectChanged
										}
									}
								]
							},
							{
								xtype:"panel",
								id:"MyPanel1",
								title:"Panel",
								header:false,
								border:false,
								height:300,
								x:70,
								y:125,
								region:"center",
								layout:"fit",
								style:"margin-left: 5px;    margin-top: 3px;    padding-right: 5px;    padding-bottom: 10px;",
								items:[
									{
										xtype:"vmd.tree",
										id:"hwTree",
										skin:"material",
										width:220,
										height:580,
										isdesign:false,
										x:0,
										y:0,
										afterrender:"hwTree_afterrender",
										onOpenEnd:"hwTree_onOpenEnd",
										nodeClick:"hwTree_nodeClick",
										region:"center",
										onOpenStart:"hwTree_onOpenStart",
										onDblClick:"hwTree_onDblClick",
										listeners:{
											vmdafterrender:hwTree_afterrender,
											onOpenEnd:hwTree_onOpenEnd,
											nodeClick:hwTree_nodeClick
										}
									}
								]
							}
						]
					},
					{
						xtype:"panel",
						id:"MyP_jcxx",
						title:"Panel",
						header:false,
						border:true,
						height:640,
						width:900,
						x:220,
						y:0,
						layout:"anchor",
						region:"center",
						autoScroll:true,
						items:[
							{
								xtype:"vmd.ux.UserControlInfo",
								id:"UserControlInfo",
								layout:"auto",
								x:0,
								y:20,
								hidden:false,
								width:618,
								height:630
							},
							{
								xtype:"vmd.div",
								id:"div",
								autoEl:"div",
								border:false,
								backgroundRepeat:"no-repeat",
								backgroundPosition:"top left",
								width:400,
								height:50,
								anchor:"100% 99%",
								hidden:true,
								layout:"fit"
							}
						]
					}
				]
			},
			{
				xtype:"vmd.div",
				id:"hwDiv",
				autoEl:"div",
				border:true,
				backgroundRepeat:"no-repeat",
				backgroundPosition:"top left",
				width:400,
				height:0,
				region:"south",
				hidden:true,
				disabled:true,
				items:[
					{
						xtype:"vmd.ux.Uploader",
						id:"Uploader",
						layout:"fit",
						region:"west",
						hidden:true,
						disabled:false
					}
				]
			}
		]
		this.callParent();
		var me = this;vmd.core.moduleInit(this.items, this);
			me.on('afterrender',function(){ MyViewport_afterrender.call(me,me)})
}
})
        Ext.onReady(function () {
            Ext.create('vmd.module.MyViewport', {
                renderTo: document.body
            })


        })

      </script>
</head>
<body>
</body>
</html>
