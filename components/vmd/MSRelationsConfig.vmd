{"vmdversion":"vmd2.0.4.190810","vmdlayout":"{\"components\":[{\"cid\":\"uxpanel\",\"id\":\"MSRelationsConfig\",\"layoutConfig\":{},\"userConfig\":{\"layout\":\"border\",\"header\":false,\"width\":281,\"height\":186,\"border\":true,\"beforerender\":\"MSRelationsConfig_beforerender\",\"afterrender\":\"MSRelationsConfig_afterrender\"},\"cn\":[{\"cid\":\"container\",\"id\":\"hwDiv1\",\"layoutConfig\":{},\"userConfig\":{\"region\":\"north\",\"layout\":\"border\",\"border\":false,\"height\":30,\"style\":\"margin-top: 5px\"},\"cn\":[{\"cid\":\"container\",\"id\":\"hwDiv3\",\"layoutConfig\":{\"align\":\"middle\",\"padding\":\"0 0 0 15\"},\"userConfig\":{\"region\":\"center\",\"width\":200,\"border\":false,\"layout\":\"hbox\"},\"cn\":[{\"cid\":\"vmdButton\",\"id\":\"button3\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"\",\"type\":\"text\",\"width\":20,\"height\":25,\"click\":\"button3_click\",\"afterrender\":\"button3_afterrender\"}},{\"cid\":\"label\",\"id\":\"lb_storename\",\"layoutConfig\":{},\"userConfig\":{\"x\":20,\"y\":10,\"text\":\"从表1：storename\",\"id\":\"lb_storename\"}}]},{\"cid\":\"container\",\"id\":\"hwDiv4\",\"layoutConfig\":{\"align\":\"middle\"},\"userConfig\":{\"region\":\"east\",\"width\":80,\"border\":false,\"layout\":\"hbox\"},\"cn\":[{\"cid\":\"container\",\"id\":\"hwDiv7\",\"layoutConfig\":{},\"userConfig\":{\"height\":25,\"width\":39,\"border\":false},\"cn\":[{\"cid\":\"vmdButton\",\"id\":\"button1\",\"layoutConfig\":{},\"userConfig\":{\"x\":220,\"y\":5,\"text\":\"\",\"icon\":\"icon-plus\",\"type\":\"text\",\"click\":\"button1_click\",\"hidden\":true}},{\"cid\":\"vmdButton\",\"id\":\"button2\",\"layoutConfig\":{},\"userConfig\":{\"x\":250,\"y\":5,\"icon\":\"icon-minus\",\"type\":\"text\",\"text\":\"\",\"click\":\"button2_click\",\"hidden\":true}}]},{\"cid\":\"vmdButton\",\"id\":\"button\",\"layoutConfig\":{},\"userConfig\":{\"x\":180,\"y\":2,\"text\":\"\",\"icon\":\"icon-trash\",\"type\":\"text\",\"style\":\"color: red;    font-size:16px;\",\"click\":\"button_click\",\"margins\":\"0 0 0 10\"}}]}]},{\"cid\":\"container\",\"id\":\"hwDiv5\",\"layoutConfig\":{},\"userConfig\":{\"region\":\"center\",\"layout\":\"border\",\"border\":false},\"cn\":[{\"cid\":\"container\",\"id\":\"hwDiv2\",\"layoutConfig\":{},\"userConfig\":{\"region\":\"center\",\"border\":false,\"layout\":\"fit\",\"style\":\"padding: 10px 15px 10px 15px\"},\"cn\":[{\"cid\":\"container\",\"id\":\"hwDiv\",\"layoutConfig\":{},\"userConfig\":{\"x\":10,\"y\":30,\"width\":260,\"height\":150,\"afterrender\":\"hwDiv_afterrender\"}}]},{\"cid\":\"container\",\"id\":\"hwDiv6\",\"layoutConfig\":{\"align\":\"middle\",\"padding\":\"0 0 0 25\"},\"userConfig\":{\"region\":\"north\",\"border\":false,\"height\":33,\"layout\":\"hbox\",\"disabled\":false,\"hidden\":true},\"cn\":[{\"cid\":\"label\",\"id\":\"hwLabel\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"级联删除：\"}},{\"cid\":\"checkbox\",\"id\":\"hwCheckbox\",\"layoutConfig\":{},\"userConfig\":{\"boxLabel\":\"\",\"check\":\"hwCheckbox_check\"}}]}]}]}]}","vmdevents":"var mstore;\nvar sstore;\nvar msrelations;\nvar msrelationstore;\nvar dhgrid;\nvar page = this;\n\nvar myDataStore = new dhtmlXDataStore();\n\nfunction hwDiv_afterrender(sender) {\n\n}\n//初始化从表的字段对应关系\nfunction msRelationInit(_mstore, _sstore) {\n\n\n\n\n\n    mstore = _mstore;\n    sstore = _sstore;\n    //初始化网格数据\n    dhgrid = new dhtmlXGridObject(hwDiv.el.dom);\n    dhgrid.setImagePath(\"/lib/dhtmlx/codebase/imgs/\");\n    dhgrid.setImagePath(\"/lib/dhtmlx/codebase/imgs/\");\n    var header = \"从表字段,主表字段\";\n    var colType = \"combo,ro\"; //\"combo,combo\";\n    var strType = \"str,str\";\n    var colId = \"sField,mField\";\n    dhgrid.setHeader(header, null, [\"text-align:center;\", \"text-align:center;\"]);\n    dhgrid.setColAlign(\"center,center\");\n    dhgrid.setColumnIds(colId);\n    dhgrid.setColTypes(colType);\n    if (!sstore)\n        return;\n    //获取字段对应关系\n    msrelations = sstore.getConfigValue('relation') || [];\n    //设置从表名称\n    lb_storename.setText(sstore.id);\n    var sstrstoreconfig = sstore.getConfigValue('storeConfig') || {}\n    var sstoreconfig = JSON.parse(sstrstoreconfig);\n    var mstrstoreconfig = mstore.getConfigValue('storeConfig') || {}\n    var mstoreconfig = JSON.parse(mstrstoreconfig);\n    //获取从表的外键信息，\n    var mtablename = mstoreconfig.tableName;\n    var foreigns = sstoreconfig.foreign || [];\n    var foreign = [];\n    for (var k = 0; k < foreigns.length; k++) {\n        if (foreigns[k].referenced_table_name == mtablename)\n        {\n           var forCol= foreigns[k].column_name.split(',');\n           var forPCol= foreigns[k].referenced_column_name.split(',');\n            for(var j=0;j<forCol.length;j++)\n            {foreign.push({\n                constraint_name:foreigns[k].constraint_name,\n                table_name:foreigns[k].table_name,\n                column_name:forCol[j]||\"\",\n                referenced_table_name:foreigns[k].referenced_table_name,\n                referenced_column_name:forPCol[j]||\"\"\n            })}\n        }\n    }\n    //获取从表字段信息\n    var sfields = sstoreconfig.fields;\n    var scomlist = [];\n    if (sfields) {\n        for (var i = 0; i < sfields.length; i++) {\n            scomlist.push({\n                value: sfields[i].name,\n                text: sfields[i].name\n            });\n        }\n    }\n    //获取主表字段信息\n    var mfields = mstoreconfig.fields;\n    if (mfields) {\n        if (!msrelations || msrelations.length == 0) {\n            if (foreign.length > 0) {\n                for (var j = 0; j < foreign.length; j++) {\n                    for (var i = 0; i < mfields.length; i++) {\n                        if (mfields[i].name.toLowerCase() == foreign[j].referenced_column_name.toLowerCase()) {\n                            msrelations.push({\n                                sField:  foreign[j].column_name.toLowerCase(),\n                                mField: mfields[i].name.toLowerCase(),\n                                pk: false\n                            });\n                        }\n                    }\n                }\n            } else {\n                for (var i = 0; i < mfields.length; i++) {\n                    if (mfields[i].primary == 'Y') {\n                        msrelations.push({\n                            sField: '',\n                            mField: mfields[i].name,\n                            pk: false\n                        });\n                    }\n                }\n            }\n        }\n    }\n    dhgrid.init();\n    myDataStore.parse(msrelations);\n    dhgrid.sync(myDataStore);\n    //添加网格的值修改事件\n    dhgrid.attachEvent(\"onCellChanged\", doOnValueChange);\n    var sCombo = dhgrid.getColumnCombo(0);\n    sCombo.clearAll();\n    sCombo.addOption(scomlist);\n    //设置级联删除\n    if (sstore.cascadeDel)\n        hwCheckbox.setValue(true);\n}\n\nfunction doOnCheck(rowId, cellInd, state) {\n    if (cellInd == \"2\")\n        myDataStore.item(rowId).pk = state ? true : false;\n    return true;\n}\n\nfunction doOnValueChange(rId, cInd, nValue) {\n    //设置修改，转换为true false\n    if (cInd == \"2\")\n        myDataStore.item(rId).pk = nValue ? true : false;\n    page.fireEvent('relationChange', rId, cInd, nValue);\n    return true;\n}\n//获取主从表的字段对应关系\nfunction getMSRelationInfo() {\n    msrelations = []\n    var dataRowsID = myDataStore.data.order;\n    var dataRows = myDataStore.data.pull;\n    for (var i = 0; i < dataRowsID.length; i++) {\n        var dr = dataRows[dataRowsID[i]];\n        msrelations.push({\n            sField: dr.sField,\n            mField: dr.mField,\n            pk: dr.pk\n        })\n    }\n    return msrelations;\n}\n//获取当前从表的数据是否根据主表级联删除\nfunction getCascadeDel() {\n    return hwCheckbox.getValue();\n}\n\n//添加对应关系\nfunction button1_click(sender, e) {\n    myDataStore.add({\n        sField: '',\n        mField: '',\n        pk: false\n    })\n    page.fireEvent('relationChange', e)\n}\n//移除对应关系\nfunction button2_click(sender, e) {\n    var rowid = dhgrid.getSelectedRowId();\n    myDataStore.remove(rowid);\n\n    page.fireEvent('relationChange', e)\n}\n//移除从表\nfunction button_click(sender, e) {\n    //判断是够需要移除，并添加事件监听\n    Ext.Msg.confirm(\"提示!\", \"确定要移除\" + mstore.id + \"的从表\" + sstore.id + \"?\", function(btn) {\n        if (btn == \"yes\") {\n            page.fireEvent('removeRelation', e)\n        }\n    })\n}\n\nfunction hwCheckbox_check(sender, checked) {\n    sstore.setConfig('cascadeDel', checked);\n}\n\nvar state = true;\n\nfunction getstate() {\n    return state;\n}\n\nfunction button3_click(sender, e) {\n    if (state) {\n        page.setHeight(40)\n        page.doLayout();\n        button3.addClass('icon-caret-right')\n        button3.removeClass('icon-caret-down')\n        //button2.setVisible(false)\n        //button1.setVisible(false)\n        page.fireEvent('sizechange', e)\n        state = false;\n    } else {\n        page.setHeight(190)\n        page.doLayout();\n        button3.addClass('icon-caret-down')\n        button3.removeClass('icon-caret-right')\n        //button2.setVisible(true)\n        //button1.setVisible(true)\n        page.fireEvent('sizechange', e)\n        state = true;\n    }\n\n}\n\nfunction setTableTitle(title) { //设置从表名称\n    if (sstore)\n        lb_storename.setText(title + sstore.id);\n\n}\n\nfunction MSRelationsConfig_beforerender(sender) {\n\n}\n\nfunction button3_afterrender(sender) {\n    button3.addClass('icon-caret-down')\n}\n\nfunction MSRelationsConfig_afterrender(sender) {\n\n}","vmdcss":"","vmdprops":"\"\"","type":"ux","vmdevents_controller":"","vmdinterface":"{\"components\":[{\"cid\":\"vmduxprops\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmduxmethods\",\"id\":\"方法\",\"layoutConfig\":{},\"userConfig\":{},\"cn\":[{\"cid\":\"uxmethod\",\"id\":\"initRelation\",\"layoutConfig\":{},\"userConfig\":{\"id\":\"initRelation\",\"zhname\":\"\",\"bindCmp\":\"\",\"bindValue\":\"\",\"isPublic\":\"on\",\"desc\":\"主表对象、从表对象\",\"uxcid\":\"\",\"params\":\"mstore,sstore\",\"code\":\"//直接填写方法内容\\nmsRelationInit(mstore,sstore)\\n\",\"returnType\":\"\"}},{\"cid\":\"uxmethod\",\"id\":\"getMSRelationInfo\",\"layoutConfig\":{},\"userConfig\":{\"id\":\"getMSRelationInfo\",\"zhname\":\"\",\"bindCmp\":\"\",\"bindValue\":\"\",\"isPublic\":\"on\",\"desc\":\"\",\"uxcid\":\"\",\"params\":\"\",\"code\":\"//直接填写方法内容\\nreturn getMSRelationInfo();\",\"returnType\":\"\"}},{\"cid\":\"uxmethod\",\"id\":\"getSstore\",\"layoutConfig\":{},\"userConfig\":{\"id\":\"getSstore\",\"zhname\":\"\",\"bindCmp\":\"\",\"bindValue\":\"\",\"isPublic\":\"on\",\"desc\":\"\",\"uxcid\":\"\",\"params\":\"\",\"code\":\"//直接填写方法内容\\nreturn sstore;\",\"returnType\":\"\"}},{\"cid\":\"uxmethod\",\"id\":\"openstate\",\"layoutConfig\":{},\"userConfig\":{\"id\":\"openstate\",\"zhname\":\"\",\"bindCmp\":\"\",\"bindValue\":\"\",\"isPublic\":\"on\",\"desc\":\"\",\"uxcid\":\"\",\"params\":\"\",\"code\":\"//直接填写方法内容\\nreturn getstate()\",\"returnType\":\"\"}},{\"cid\":\"uxmethod\",\"id\":\"setTitle\",\"layoutConfig\":{},\"userConfig\":{\"id\":\"setTitle\",\"params\":\"title\",\"desc\":\"\",\"isPublic\":\"on\",\"code\":\"//直接填写方法内容\\nsetTableTitle(title)\",\"returnType\":\"\"}}]},{\"cid\":\"vmduxevents\",\"id\":\"事件\",\"layoutConfig\":{},\"userConfig\":{},\"cn\":[{\"cid\":\"uxevent\",\"id\":\"removeRelation\",\"layoutConfig\":{},\"userConfig\":{\"id\":\"removeRelation\",\"zhname\":\"\",\"bindCmp\":\"\",\"bindValue\":\"\",\"isPublic\":\"\",\"desc\":\"\",\"uxcid\":\"\",\"params\":\"\",\"code\":\"\"}},{\"cid\":\"uxevent\",\"id\":\"sizechange\",\"layoutConfig\":{},\"userConfig\":{\"id\":\"sizechange\",\"params\":\"\",\"desc\":\"\"}}]}]}","vmdresource":"{\"components\":[{\"cid\":\"vmdrescsss\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdresjss\",\"layoutConfig\":{},\"userConfig\":{},\"cn\":[{\"cid\":\"resjs\",\"id\":\"controller.js\",\"layoutConfig\":{},\"userConfig\":{}}]},{\"cid\":\"vmdresimgs\",\"layoutConfig\":{},\"userConfig\":{}}]}"}