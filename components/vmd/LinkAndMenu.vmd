{"vmdversion":"vmd2.0.5.191221","vmdlayout":"{\"components\":[{\"cid\":\"uxpanel\",\"id\":\"LinkAndMenu\",\"layoutConfig\":{},\"userConfig\":{\"layout\":\"absolute\",\"header\":false,\"width\":276,\"height\":485,\"autoScroll\":true,\"afterrender\":\"LinkAndMenu_afterrender\"},\"cn\":[{\"cid\":\"label\",\"id\":\"label\",\"layoutConfig\":{},\"userConfig\":{\"x\":10,\"y\":10,\"text\":\"超链接\"}},{\"cid\":\"label\",\"id\":\"label1\",\"layoutConfig\":{},\"userConfig\":{\"x\":25,\"y\":35,\"height\":20,\"text\":\"参数：\"}},{\"cid\":\"textfield\",\"id\":\"linkParam\",\"layoutConfig\":{},\"userConfig\":{\"x\":70,\"y\":30,\"width\":145,\"id\":\"linkParam\"}},{\"cid\":\"vmdButton\",\"id\":\"LinkParamExpEdit\",\"layoutConfig\":{},\"userConfig\":{\"x\":225,\"y\":30,\"width\":30,\"text\":\"...\",\"height\":\"\",\"id\":\"LinkParamExpEdit\",\"click\":\"LinkParamExpEdit_click\",\"hidden\":true}},{\"cid\":\"label\",\"id\":\"label2\",\"layoutConfig\":{},\"userConfig\":{\"x\":25,\"y\":60,\"text\":\"事件：\"}},{\"cid\":\"textfield\",\"id\":\"linkEvent\",\"layoutConfig\":{},\"userConfig\":{\"x\":70,\"y\":60,\"width\":145,\"id\":\"linkEvent\",\"readOnly\":true,\"afterrender\":\"linkEvent_afterrender\"}},{\"cid\":\"label\",\"id\":\"label3\",\"layoutConfig\":{},\"userConfig\":{\"x\":10,\"y\":90,\"text\":\"菜单\"}},{\"cid\":\"panel\",\"id\":\"panel\",\"layoutConfig\":{},\"userConfig\":{\"x\":9,\"y\":110,\"height\":370,\"border\":false,\"header\":false,\"layout\":\"absolute\",\"width\":260},\"cn\":[{\"cid\":\"label\",\"id\":\"label5\",\"layoutConfig\":{},\"userConfig\":{\"x\":16,\"y\":10,\"text\":\"参数：\"}},{\"cid\":\"textfield\",\"id\":\"menuParam\",\"layoutConfig\":{},\"userConfig\":{\"x\":60,\"y\":-1,\"width\":140,\"id\":\"menuParam\",\"readOnly\":false,\"keyup\":\"menuParam_keyup\"}},{\"cid\":\"vmdButton\",\"id\":\"menuParamExpEdit\",\"layoutConfig\":{},\"userConfig\":{\"x\":216,\"y\":0,\"width\":30,\"text\":\"...\",\"id\":\"menuParamExpEdit\",\"click\":\"menuParamExpEdit_click\",\"hidden\":true}},{\"cid\":\"label\",\"id\":\"label6\",\"layoutConfig\":{},\"userConfig\":{\"x\":-1,\"y\":100,\"text\":\"数据来源：\",\"hidden\":false}},{\"cid\":\"label\",\"id\":\"label8\",\"layoutConfig\":{},\"userConfig\":{\"x\":16,\"y\":40,\"text\":\"事件：\"}},{\"cid\":\"textfield\",\"id\":\"menuEvent\",\"layoutConfig\":{},\"userConfig\":{\"x\":60,\"y\":30,\"width\":140,\"id\":\"menuEvent\",\"readOnly\":true,\"afterrender\":\"menuEvent_afterrender\"}},{\"cid\":\"vmdButton\",\"id\":\"button2\",\"layoutConfig\":{},\"userConfig\":{\"x\":216,\"y\":30,\"width\":30,\"text\":\"\",\"icon\":\"delete\",\"click\":\"button2_click\"}},{\"cid\":\"radiogroup\",\"id\":\"menuSource\",\"layoutConfig\":{},\"userConfig\":{\"x\":70,\"y\":90,\"height\":30,\"id\":\"menuSource\",\"checkedField\":\"1\",\"change\":\"menuSource_change\",\"hidden\":false},\"cn\":[{\"cid\":\"radio\",\"id\":\"menuDataSource\",\"layoutConfig\":{},\"userConfig\":{\"fieldLabel\":\"\",\"id\":\"menuDataSource\",\"boxLabel\":\"服务\",\"checked\":true,\"inputValue\":\"1\"}},{\"cid\":\"radio\",\"id\":\"menuCustom\",\"layoutConfig\":{},\"userConfig\":{\"fieldLabel\":\"\",\"id\":\"menuCustom\",\"boxLabel\":\"自定义\",\"disabled\":false,\"inputValue\":\"0\"}}]},{\"cid\":\"panel\",\"id\":\"panel1\",\"layoutConfig\":{},\"userConfig\":{\"x\":-10,\"y\":120,\"height\":260,\"border\":false,\"header\":false,\"layout\":\"auto\"},\"cn\":[{\"cid\":\"panel\",\"id\":\"serverPanel\",\"layoutConfig\":{},\"userConfig\":{\"x\":10,\"y\":0,\"border\":false,\"header\":false,\"height\":236,\"layout\":\"absolute\",\"id\":\"serverPanel\",\"width\":297},\"cn\":[{\"cid\":\"label\",\"id\":\"label4\",\"layoutConfig\":{},\"userConfig\":{\"x\":20,\"y\":10,\"text\":\"数据集：\"}},{\"cid\":\"vmdComlist\",\"id\":\"menuDataset\",\"layoutConfig\":{},\"userConfig\":{\"x\":70,\"y\":5,\"width\":180,\"id\":\"menuDataset\",\"selectChanged\":\"menuDataset_selectChanged\",\"beforerender\":\"menuDataset_beforerender\",\"afterrender\":\"menuDataset_afterrender\"}},{\"cid\":\"label\",\"id\":\"hwLabel\",\"layoutConfig\":{},\"userConfig\":{\"x\":10,\"y\":45,\"text\":\"节点字段：\"}},{\"cid\":\"label\",\"id\":\"hwLabel1\",\"layoutConfig\":{},\"userConfig\":{\"x\":10,\"y\":80,\"text\":\"节点文本：\"}},{\"cid\":\"label\",\"id\":\"hwLabel2\",\"layoutConfig\":{},\"userConfig\":{\"x\":10,\"y\":115,\"text\":\"父列字段：\",\"height\":20}},{\"cid\":\"vmdComlist\",\"id\":\"menuID\",\"layoutConfig\":{},\"userConfig\":{\"x\":70,\"y\":40,\"width\":180,\"id\":\"menuID\",\"beforerender\":\"menuID_beforerender\",\"selectChanged\":\"menuID_selectChanged\"}},{\"cid\":\"vmdComlist\",\"id\":\"menuText\",\"layoutConfig\":{},\"userConfig\":{\"x\":70,\"y\":75,\"width\":180,\"id\":\"menuText\",\"beforerender\":\"nodeName_beforerender\",\"selectChanged\":\"nodeName_selectChanged\"}},{\"cid\":\"vmdComlist\",\"id\":\"menuPID\",\"layoutConfig\":{},\"userConfig\":{\"x\":70,\"y\":110,\"width\":180,\"id\":\"menuPID\",\"beforerender\":\"menuPID_beforerender\",\"selectChanged\":\"menuPID_selectChanged\"}}]},{\"cid\":\"panel\",\"id\":\"customPanel\",\"layoutConfig\":{},\"userConfig\":{\"border\":false,\"header\":false,\"layout\":\"border\",\"autoHeight\":false,\"autoWidth\":false,\"id\":\"customPanel\",\"hidden\":true,\"height\":240},\"cn\":[{\"cid\":\"panel\",\"id\":\"panel2\",\"layoutConfig\":{},\"userConfig\":{\"region\":\"north\",\"border\":false,\"header\":false,\"autoWidth\":false,\"height\":30,\"layout\":\"absolute\"},\"cn\":[{\"cid\":\"checkbox\",\"id\":\"chkSavePt\",\"layoutConfig\":{},\"userConfig\":{\"boxLabel\":\"保存到平台\",\"id\":\"chkSavePt\",\"x\":20,\"y\":0,\"check\":\"chkSavePt_check\",\"disabled\":true}},{\"cid\":\"vmdButton\",\"id\":\"btnSave\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"保存\",\"id\":\"btnSave\",\"x\":130,\"y\":0,\"height\":24,\"hidden\":true}}]},{\"cid\":\"panel\",\"id\":\"panel3\",\"layoutConfig\":{},\"userConfig\":{\"region\":\"center\",\"border\":false,\"header\":false,\"layout\":\"fit\"},\"cn\":[{\"cid\":\"vmdTreeEx\",\"id\":\"tree\",\"layoutConfig\":{},\"userConfig\":{\"width\":260,\"height\":400,\"region\":\"center\",\"nodeclick\":\"tree_nodeclick\",\"hideRoot\":false}}]}]}]},{\"cid\":\"label\",\"id\":\"label7\",\"layoutConfig\":{},\"userConfig\":{\"x\":14,\"y\":68,\"text\":\"名称：\"}},{\"cid\":\"textfield\",\"id\":\"menuName\",\"layoutConfig\":{},\"userConfig\":{\"x\":60,\"y\":60,\"width\":186,\"id\":\"menuName\",\"keyup\":\"menuName_keyup\"}}]},{\"cid\":\"vmdButton\",\"id\":\"button1\",\"layoutConfig\":{},\"userConfig\":{\"x\":225,\"y\":60,\"width\":30,\"text\":\"\",\"icon\":\"delete\",\"click\":\"button1_click\"}},{\"cid\":\"vmdMenu\",\"id\":\"hwMenuTree\",\"layoutConfig\":{},\"userConfig\":{\"id\":\"hwMenuTree\"},\"cn\":[{\"cid\":\"vmdMenuItem\",\"id\":\"hwMenuItemNode\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"添加节点\",\"hidden\":false,\"id\":\"hwMenuItemNode\",\"click\":\"hwMenuItemNode_click\"}},{\"cid\":\"vmdMenuItem\",\"id\":\"hwMenuItemCNode\",\"layoutConfig\":{},\"userConfig\":{\"id\":\"hwMenuItemCNode\",\"text\":\"添加子节点\",\"click\":\"hwMenuItemCNode_click\"}},{\"cid\":\"vmdMenuItem\",\"id\":\"hwMenuItemRename\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"重命名\",\"hidden\":false,\"id\":\"hwMenuItemRename\",\"click\":\"hwMenuItemRename_click\"}},{\"cid\":\"vmdMenuItem\",\"id\":\"hwMenuItemdelete\",\"layoutConfig\":{},\"userConfig\":{\"text\":\"删除\",\"hidden\":false,\"id\":\"hwMenuItemdelete\",\"click\":\"hwMenuItemdelete_click\"}}]}]}]}","vmdevents":"var page = this;\r\nvar selectNode;\r\nvar menuid;\r\nvar isset = false;\r\n\r\n//数据集数据\r\nvar store = new Ext.data.JsonStore({\r\n    proxy: new Ext.data.MemoryProxy(),\r\n    fields: ['name', 'value']\r\n});\r\n\r\n//数据集字段数据\r\nvar store1 = new Ext.data.JsonStore({\r\n    proxy: new Ext.data.MemoryProxy(),\r\n    fields: ['name', 'value']\r\n});\r\n\r\nvar ori = parent.xds.vmd.events;\r\n\r\n// 设置属性信息\r\nfunction setInfo(info) {\r\n    \r\n    clearMenuPanel();\r\n    if (info && info.cellAttributeInfo && info.cellAttributeInfo.menu && info.cellAttributeInfo.leftLink) {\r\n        var menu = info.cellAttributeInfo.menu;\r\n        var link = info.cellAttributeInfo.leftLink;\r\n        isset = true;\r\n\r\n        linkParam.setValue(link.linkParam.value);\r\n        linkEvent.setValue(link.linkEvent.value);\r\n        menuParam.setValue(menu.menuParam.value);\r\n        menuEvent.setValue(menu.menuEvent.value);\r\n        menuText.setValue(menu.menuText.value);\r\n        menuDataset.setValue(menu.menuDataset.value);\r\n        menuID.setValue(menu.menuID.value)\r\n        menuPID.setValue(menu.menuPID.value)\r\n\r\n        menuSource.setValue(parseInt(menu.menuSource.value));\r\n        if (menu.menuSource.value == \"0\") {\r\n            \r\n            if (menuDataset.getValue()) {\r\n                data = Ext.decode(menuDataset.getValue());\r\n            } else {\r\n                data = Ext.decode(menu.menuDataset.value);\r\n            }\r\n            serverPanel.hide();\r\n            customPanel.show();\r\n\r\n            var rootNode = tree.getRootNode();\r\n\r\n            rootNode.removeAll()\r\n            rootNode.ownerTree.nodeIdList = [];\r\n            rootNode.setText(\"右键菜单\");\r\n            if (isset && data) {\r\n                if (data && data.length > 0) {\r\n                    addNodeToTreeParse(rootNode.childNodes, rootNode.id, data);\r\n                    parent.sheetHot.handleMenus('sets', Ext.encode(data))\r\n                }\r\n            } else {\r\n                if (rootNode && rootNode.childNodes.length > 0) {\r\n                    var num = rootNode.childNodes.length;\r\n                    for (var i = 0; i < num; i++) {\r\n                        tree.removeNodeById(rootNode.childNodes[0].id)\r\n                        parent.sheetHot.handleMenus('sets', \"\")\r\n                    }\r\n                }\r\n            }\r\n            panel3.el.on('contextmenu', function(e) {\r\n                e.stopEvent();\r\n                hwMenuTree.showAt(e.getXY());\r\n            })\r\n            tree.expandAll();\r\n        } else {\r\n            serverPanel.show();\r\n            customPanel.hide();\r\n        }\r\n        // parent.sheetHot.handleMenus('source', menuSource.getValue())\r\n        // parent.sheetHot.handleMenus('params', menuParam.getValue());\r\n        // parent.sheetHot.handleMenus('text', menuText.getValue());\r\n        // parent.sheetHot.handleMenus('event', menuEvent.getValue())\r\n    }\r\n}\r\n\r\nfunction addNodeToTreeParse(rootnode, pid, node) {\r\n    for (var i = 0; i < node.length; i++) {\r\n        if (!checkSameName(rootnode, node[i].text)) {\r\n            tree.addNode(pid, node[i].id, node[i].text, true);\r\n            if (node[i].items && node[i].items.length > 0) {\r\n                addNodeToTreeParse(tree.getNodeById(node[i].id).childNodes, node[i].id, node[i].items);\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n//事件编辑器\r\nfunction menuEvent_afterrender(sender) {\r\n    sender.el.on('dblclick', function() {\r\n        var canWrite = false;\r\n        var cell = sheetHot.dealInvert()[0];\r\n        var mArr = sheetHot.getPlugin('MergeCells').mergedCellsCollection.mergedCells;\r\n        var sel = sheetHot.dealInvert()[0];\r\n        var count = 0;\r\n        if (mArr.length > 0) {\r\n            for (var x = 0; x < mArr.length; x++) {\r\n                for (var i = sel.sr; i < sel.er + 1; i++) {\r\n                    for (var n = sel.sc; n < sel.ec + 1; n++) {\r\n                        if (mArr[x].row == i && mArr[x].col == n) {\r\n                            count++;\r\n                            if (count == 1) no = x;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            if (count == 1) {\r\n                if (mArr[no].row + mArr[no].rowspan - 1 == sel.er && mArr[no].col + mArr[no].colspan - 1 == sel.ec) {\r\n                    canWrite = true;\r\n                }\r\n            }\r\n        }\r\n        if (canWrite || (cell.sr == cell.er && cell.sc == cell.ec)) {\r\n            var editor = new vmd.comp.Ace({\r\n                id: \"ace_code\"\r\n            });\r\n            parent.init_def_platformControlData();\r\n            var aceWin = new vmd.window({\r\n                title: \"事件编辑\",\r\n                id: \"aceWin\",\r\n                url: vmd.virtualPath + vmd.vmdCodePath + \"?\" + Date.parse(new Date()),\r\n                offset: [100, 100],\r\n                modal: true,\r\n                maximizable: true,\r\n                maskStyle: 'opacity:0.7',\r\n                layout: 'border',\r\n                draggable: false,\r\n                listeners: {\r\n                    move: function(me, x, y) {\r\n                        this.moveZone(me, x, y);\r\n                    }\r\n                }\r\n            });\r\n            aceWin.closeFn = function() {\r\n                //修复ace tooltip还存在的问题\r\n                Ext.select('.Ace-Tern-tooltip').remove();\r\n                var val = aceWin.val;\r\n                if (aceWin.script == val) {\r\n                    return;\r\n                }\r\n                Ext.Msg.confirm(\"提示\", \"脚本已改变是否保存?\", function(btn) {\r\n                    if (btn == 'no') return;\r\n                    var click_label = sender;\r\n                    if (val.trim()) {\r\n                        parent.xds.vmd.events = val;\r\n                        var name = ('' + sheetHot.rootScope.viewerNode.id + '_' + sheetHot.numToEng(cell.sc) + (cell.sr + 1) + '_itemClick').toLowerCase();\r\n                        sender.setValue(name)\r\n                        debugger\r\n                        sheetHot.changeAttributeInfo(cell.sr, cell.sc, 'menuEvent', name)\r\n                        if (ori.indexOf(name) == -1) {\r\n                            parent.xds.vmd.addEventForDesignerCmp(parent.xds.active.component, name, name)\r\n                        }\r\n                    } else {\r\n                        click_label = undefined;\r\n                        delete parent.xds.vmd.events\r\n                    }\r\n                })\r\n            }\r\n            //mafei 在ide-automachjs中\r\n            parent.init_def_platformControlData();\r\n            aceWin.on('close', aceWin.closeFn, this)\r\n            //当前拖拽组件\r\n            window.setTimeout(function() {\r\n                window.setTimeout(function() {\r\n                    //代码编辑器初始化\r\n                    if (typeof rowIndex == \"number\") {\r\n                        aceWin.aceline = rowIndex;\r\n                    }\r\n                }, 150)\r\n                var code = parent.xds.vmd.events;\r\n                var eventName = ('' + sheetHot.rootScope.viewerNode.id + '_' + sheetHot.numToEng(cell.sc) + (cell.sr + 1) + '_itemClick').toLowerCase();\r\n                // var me = \r\n                var getdefaulteventname = function() {\r\n                    return \"function(sender,grid,cell,rId,cInd,item,params\" + \"){\\n\" + \"\\n} \\n\";\r\n                }\r\n                var m = getdefaulteventname(),\r\n                    code = code ? code : \"\",\r\n                    replaceStr = \"function {0}{1}\",\r\n                    regex = new RegExp(\"function\\\\s+\" + eventName + \"\\\\s*?\\\\(\");\r\n                if (eventName && code.search(regex) == -1) {\r\n                    var e = m.trim().replace(\"function\", \"\"),\r\n                        i = String.format(replaceStr, eventName, e);\r\n                    code += (code ? \"\\n\\n\" : \"\") + i\r\n                }\r\n                aceWin.script = code;\r\n                aceWin.val = code;\r\n                aceWin.show();\r\n                //进度提示\r\n                var myMask = new Ext.LoadMask(aceWin.el, {\r\n                    msg: \"数据加载中,请稍后...\",\r\n                    msgCls: 'z-index:10000;'\r\n                });\r\n                myMask.show();\r\n                aceWin.loading = myMask;\r\n                var scriptArr = code.split(\"\\n\"),\r\n                    rowIndex = null;\r\n                Ext.each(scriptArr,\r\n                    function(o, p) {\r\n                        if (o.search(regex) != -1) {\r\n                            rowIndex = p + 2;\r\n                            return false\r\n                        }\r\n                    });\r\n            }, 50)\r\n        } else {\r\n            alert('请选择单个单元格设置事件')\r\n        }\r\n    })\r\n}\r\n\r\nfunction linkEvent_afterrender(sender) { \r\n    sender.el.on('dblclick', function() {\r\n        var canWrite = false;\r\n        var cell = sheetHot.dealInvert()[0];\r\n        var mArr = sheetHot.getPlugin('MergeCells').mergedCellsCollection.mergedCells;\r\n        var sel = sheetHot.dealInvert()[0];\r\n        var count = 0;\r\n        if (mArr.length > 0) {\r\n            for (var x = 0; x < mArr.length; x++) {\r\n                for (var i = sel.sr; i < sel.er + 1; i++) {\r\n                    for (var n = sel.sc; n < sel.ec + 1; n++) {\r\n                        if (mArr[x].row == i && mArr[x].col == n) {\r\n                            count++;\r\n                            if (count == 1) no = x;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            if (count == 1) {\r\n                if (mArr[no].row + mArr[no].rowspan - 1 == sel.er && mArr[no].col + mArr[no].colspan - 1 == sel.ec) {\r\n                    canWrite = true;\r\n                }\r\n            }\r\n        }\r\n        if (canWrite || (cell.sr == cell.er && cell.sc == cell.ec)) {\r\n            var editor = new vmd.comp.Ace({\r\n                id: \"ace_code\"\r\n            });\r\n            parent.init_def_platformControlData();\r\n            var aceWin = new vmd.window({\r\n                title: \"事件编辑\",\r\n                id: \"aceWin\",\r\n                url: vmd.virtualPath + vmd.vmdCodePath + \"?\" + Date.parse(new Date()),\r\n                offset: [100, 100],\r\n                modal: true,\r\n                maximizable: true,\r\n                maskStyle: 'opacity:0.7',\r\n                layout: 'border',\r\n                draggable: false,\r\n                listeners: {\r\n                    move: function(me, x, y) {\r\n                        this.moveZone(me, x, y);\r\n                    }\r\n                }\r\n            });\r\n            aceWin.closeFn = function() {\r\n                //修复ace tooltip还存在的问题\r\n                Ext.select('.Ace-Tern-tooltip').remove();\r\n                var val = aceWin.val;\r\n                if (aceWin.script == val) {\r\n                    return;\r\n                }\r\n                Ext.Msg.confirm(\"提示\", \"脚本已改变是否保存?\", function(btn) {\r\n                    if (btn == 'no') return;\r\n                    var click_label = sender;\r\n                    if (val.trim()) {\r\n                        parent.xds.vmd.events = val;\r\n                        var name = ('' + sheetHot.rootScope.viewerNode.id + '_' + sheetHot.numToEng(cell.sc) + (cell.sr + 1) + '_click').toLowerCase();\r\n                        sender.setValue(name)\r\n                        sheetHot.changeAttributeInfo(cell.sr, cell.sc, 'linkEvent', name)\r\n                        if (ori.indexOf(name) == -1) {\r\n                            parent.xds.vmd.addEventForDesignerCmp(parent.xds.active.component, name, name)\r\n                        }\r\n                    } else {\r\n                        click_label = undefined;\r\n                        delete parent.xds.vmd.events\r\n                    }\r\n                })\r\n            }\r\n            //mafei 在ide-automachjs中\r\n            parent.init_def_platformControlData();\r\n            aceWin.on('close', aceWin.closeFn, this)\r\n            //当前拖拽组件\r\n            window.setTimeout(function() {\r\n                window.setTimeout(function() {\r\n                    //代码编辑器初始化\r\n                    if (typeof rowIndex == \"number\") {\r\n                        aceWin.aceline = rowIndex;\r\n                    }\r\n                }, 150)\r\n                var code = parent.xds.vmd.events;\r\n                var eventName = ('' + sheetHot.rootScope.viewerNode.id + '_' + sheetHot.numToEng(cell.sc) + (cell.sr + 1) + '_click').toLowerCase();\r\n                // var me = \r\n                var getdefaulteventname = function() {\r\n                    return \"function(sender,grid,cell,params\" + \"){\\n\" + \"\\n} \\n\";\r\n                }\r\n                var m = getdefaulteventname(),\r\n                    code = code ? code : \"\",\r\n                    replaceStr = \"function {0}{1}\",\r\n                    regex = new RegExp(\"function\\\\s+\" + eventName + \"\\\\s*?\\\\(\");\r\n                if (eventName && code.search(regex) == -1) {\r\n                    var e = m.trim().replace(\"function\", \"\"),\r\n                        i = String.format(replaceStr, eventName, e);\r\n                    code += (code ? \"\\n\\n\" : \"\") + i\r\n                }\r\n                aceWin.script = code;\r\n                aceWin.val = code;\r\n                aceWin.show();\r\n                //进度提示\r\n                var myMask = new Ext.LoadMask(aceWin.el, {\r\n                    msg: \"数据加载中,请稍后...\",\r\n                    msgCls: 'z-index:10000;'\r\n                });\r\n                myMask.show();\r\n                aceWin.loading = myMask;\r\n                //  aceWin.update(\"<iframe  id='iframe_page' src='\" + vmd.virtualPath + vmd.vmdCodePath + \"?\" + Date.parse(new Date()) + \"' width=600 height=900 frameborder=0  ></iframe>\")\r\n                var scriptArr = code.split(\"\\n\"),\r\n                    rowIndex = null;\r\n                Ext.each(scriptArr,\r\n                    function(o, p) {\r\n                        if (o.search(regex) != -1) {\r\n                            rowIndex = p + 2;\r\n                            return false\r\n                        }\r\n                    });\r\n            }, 50)\r\n        } else {\r\n            alert('请选择单个单元格设置事件')\r\n        }\r\n    })\r\n}\r\n\r\n//打开？？？编辑器\r\nfunction menuIDExpEdit_click(sender, e) {\r\n    parent.openVisualEditor('menuID', menuID.getValue());\r\n}\r\n\r\nfunction LinkParamExpEdit_click(sender, e) {\r\n    parent.openVisualEditor('linkParam', linkParam.getValue());\r\n}\r\n\r\nfunction menuParamExpEdit_click(sender, e) {\r\n    parent.openVisualEditor('menuParam', menuParam.getValue());\r\n}\r\n\r\n//清空面板\r\nfunction clearMenuPanel() {\r\n    menuID.setValue('');\r\n    menuParam.setValue('');\r\n    menuEvent.setValue('');\r\n    menuDataset.setValue('');\r\n}\r\n\r\n//数据集选择改变\r\nfunction menuDataset_selectChanged(sender, combo, record, index) {\r\n    sender.setValue(record.data.name)\r\n    var temp = [];\r\n    var dataSets = sheetHot.getDatasets();\r\n    for (var i = 0; i < dataSets.length; i++) {\r\n        if (dataSets[i].name == record.data.name) {\r\n            for (var n = 0; n < dataSets[i].fields.length; n++) {\r\n                temp.push({\r\n                    name: dataSets[i].fields[n],\r\n                    value: dataSets[i].fields[n]\r\n                })\r\n            }\r\n        }\r\n    }\r\n    store1.loadData(temp)\r\n    \r\n    menuPID.setValue(\"\");\r\n    menuText.setValue(\"\");\r\n    menuID.setValue(\"\")\r\n    sheetHot.handleMenus('sets', record.data.name);\r\n    sheetHot.handleMenus('text', '');\r\n    sheetHot.handleMenus('id', '');\r\n    sheetHot.handleMenus('pid', '');\r\n}\r\n\r\n// 服务或者自定义选择\r\nfunction menuSource_change(sender, checked) {\r\n    var sheetHot = parent.sheetHot;\r\n    if (checked.boxLabel == \"自定义\") {\r\n        serverPanel.hide();\r\n        customPanel.show();\r\n        tree.expandAll();\r\n        var rootNode = tree.getRootNode();\r\n        rootNode.setText(\"右键菜单\");\r\n        if (isset) {\r\n            if (typeof data != 'undefined') {\r\n                if (data && data.length > 0) {\r\n                    addNodeToTreeParse(rootNode.childNodes, rootNode.id, data);\r\n                    sheetHot.handleMenus('sets', Ext.encode(data))\r\n                }\r\n            }\r\n        } else {\r\n            if (rootNode && rootNode.childNodes.length > 0) {\r\n                var num = rootNode.childNodes.length;\r\n                for (var i = 0; i < num; i++) {\r\n                    tree.removeNodeById(rootNode.childNodes[0].id)\r\n                }\r\n                sheetHot.handleMenus('sets', \"\")\r\n            }\r\n        }\r\n        panel3.el.on('contextmenu', function(e) {\r\n            e.stopEvent();\r\n            hwMenuTree.showAt(e.getXY());\r\n        })\r\n    } else {\r\n        serverPanel.show();\r\n        customPanel.hide();\r\n    }\r\n    sheetHot.handleMenus('source', menuSource.getValue())\r\n    isset = false;\r\n}\r\n\r\nfunction menuDataset_beforerender(sender) {\r\n    menuDataset.store = store;\r\n    menuDataset.displayField = 'name';\r\n    menuDataset.valueField = 'value'\r\n}\r\n\r\n/*\r\nfunction comlist_beforerender(sender) {\r\n    sender.store = store1;\r\n    sender.valueField = 'value'\r\n    sender.displayField = 'name'\r\n}\r\n*/\r\n\r\nfunction menuPID_selectChanged(sender, combo, record, index) {\r\n    sheetHot.handleMenus('pid', record.data.name);\r\n}\r\n\r\n//点击组件刷新下拉选项内容\r\nfunction refreshStore(sender) {\r\n    sender.el.dom.parentNode.onclick = function() {\r\n        var temp = [];\r\n        var dataSets = sheetHot.getDatasets();\r\n        for (var i = 0; i < dataSets.length; i++) {\r\n            if (dataSets[i].name == menuDataset.getValue()) {\r\n                for (var n = 0; n < dataSets[i].fields.length; n++) {\r\n                    temp.push({\r\n                        name: dataSets[i].fields[n],\r\n                        value: dataSets[i].fields[n]\r\n                    })\r\n                }\r\n            }\r\n        }\r\n        store1.loadData(temp)\r\n    }\r\n}\r\n\r\nfunction menuPID_afterrender(sender) {\r\n    // refreshStore(sender)\r\n}\r\n\r\n// 保存到平台\r\nfunction chkSavePt_check(sender, checked) {\r\n    if (checked) {\r\n        btnSave.show();\r\n    } else {\r\n        btnSave.hide();\r\n    }\r\n}\r\n\r\nfunction tree_nodeclick(sender, node, e) {\r\n    selectNode = node;\r\n}\r\n\r\nfunction newGuid(len) {\r\n    var length = 32;\r\n    if (len)\r\n        length = len\r\n    var guid = \"\";\r\n    arr = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];\r\n    for (var i = 0; i < length; i++) {\r\n        pos = Math.round(Math.random() * (arr.length - 1));\r\n        guid += arr[pos];\r\n    }\r\n    return guid;\r\n}\r\n\r\n// 添加节点\r\nfunction hwMenuItemNode_click(sender, e) {\r\n    var ppid = tree.getSelNode();\r\n    var pid = tree.getSelNodeId();\r\n    var cid;\r\n    var c;\r\n\r\n    if (pid.indexOf(\"root\") == -1) {\r\n        pid = ppid.parentNode.id;\r\n        cid = newGuid(6);\r\n        c = ppid.parentNode.childNodes;\r\n    } else {\r\n        c = ppid.childNodes;\r\n    }\r\n    var win = new vmd.window({\r\n        url: '/system//modules/eQ9ULgcVb1/eQ9ULgcVb5/hwihB4MLqR/hwcd09f39c.html',\r\n        auto: false,\r\n        width: 270,\r\n        height: 140,\r\n        maximizable: false,\r\n        title: '节点名称设置'\r\n    })\r\n    window.closeMenuNodeNameWindow = function() {\r\n        win.hide();\r\n    }\r\n    window.okMenuNodeNameWindow = function(text) {\r\n        \r\n        if (checkSameName(c, text)) {\r\n            vmd.alert(\"提示\", \"该节点名称已存在，请重新设置！\");\r\n        } else {\r\n            var cnameisleaf = text;\r\n            var changeStore = true;\r\n            cid = newGuid(6);\r\n            tree.addNode(pid, cid, cnameisleaf, changeStore);\r\n            win.hide();\r\n            var menuobj = treeNodesToString(tree);\r\n            if (menuobj && menuobj.length > 0) {\r\n                data = menuobj;\r\n                sheetHot.handleMenus('sets', Ext.encode(menuobj))\r\n            }\r\n        }\r\n    }\r\n    win.show()\r\n}\r\n// 树形结构获取\r\nfunction treeNodesToString(treenode) {\r\n    var menuObj;\r\n    if (treenode.nodeHash) {\r\n        var rootnode = treenode.nodeHash.root;\r\n        menuObj = treeChildNodes(rootnode);\r\n    }\r\n    return menuObj;\r\n}\r\n// 递归获取树形数据\r\nfunction treeChildNodes(node) {\r\n    var items = [];\r\n    if (node.childNodes && node.childNodes.length > 0) {\r\n        for (var i = 0; i < node.childNodes.length; i++) {\r\n            var cnode = node.childNodes[i];\r\n            var item = {};\r\n            item.id = cnode.id;\r\n            item.text = cnode.text;\r\n            if (treeChildNodes(cnode) && treeChildNodes(cnode).length > 0) {\r\n                item.items = treeChildNodes(cnode);\r\n            }\r\n            items.push(item);\r\n        }\r\n    }\r\n    return items;\r\n}\r\n// 检查名称是否存在重复\r\nfunction checkSameName(node, name) {\r\n    if (node.length > 0) {\r\n        for (var i = 0; i < node.length; i++) {\r\n            if (node[i].text == name) {\r\n                return true;\r\n            }\r\n        }\r\n    }\r\n    return false;\r\n}\r\n//重命名\r\nfunction hwMenuItemRename_click(sender, e) {\r\n    var pid = tree.getSelNode();\r\n    if (pid.id.indexOf(\"root\") == -1) {\r\n        var win = new vmd.window({\r\n            url: '/system//modules/eQ9ULgcVb1/eQ9ULgcVb5/hwihB4MLqR/hwcd09f39c.html?nodename=' + pid.text,\r\n            auto: false,\r\n            width: 270,\r\n            height: 140,\r\n            maximizable: false,\r\n            title: '节点名称设置'\r\n        })\r\n        window.closeMenuNodeNameWindow = function() {\r\n            win.hide();\r\n        }\r\n        window.okMenuNodeNameWindow = function(text) {\r\n            var c;\r\n            if (pid.id.indexOf(\"root\") == -1) {\r\n                c = pid.parentNode.childNodes;\r\n            } else {\r\n                c = pid.childNodes;\r\n            }\r\n            if (checkSameName(c, text)) {\r\n                vmd.alert(\"提示\", \"该节点名称已存在，请重新设置！\");\r\n            } else {\r\n                pid.setText(text);\r\n                win.hide();\r\n                var menuobj = treeNodesToString(tree);\r\n                if (menuobj && menuobj.length > 0) {\r\n                    // menuDataset.setValue(Ext.encode(menuobj));\r\n                    data = menuobj;\r\n                    sheetHot.handleMenus('sets', Ext.encode(menuobj));\r\n                }\r\n            }\r\n        }\r\n        win.show()\r\n    }\r\n}\r\n//删除节点\r\nfunction hwMenuItemdelete_click(sender, e) {\r\n    var nodeId = tree.getSelNodeId();\r\n    if (nodeId.indexOf(\"root\") != -1) {\r\n        vmd.alert(\"提示\", \"请选择需要删除的节点!\")\r\n        return;\r\n    }\r\n    tree.removeNodeById(nodeId)\r\n    var menuobj = treeNodesToString(tree);\r\n    if (menuobj && menuobj.length > 0) {\r\n        // menuDataset.setValue(Ext.encode(menuobj));\r\n        data = menuobj;\r\n        sheetHot.handleMenus('sets', Ext.encode(menuobj));\r\n    }\r\n}\r\n// 添加子节点\r\nfunction hwMenuItemCNode_click(sender, e) {\r\n    var ppid = tree.getSelNode();\r\n    var pid = tree.getSelNodeId();\r\n    var cid = newGuid(6);\r\n    var win = new vmd.window({\r\n        url: '/system//modules/eQ9ULgcVb1/eQ9ULgcVb5/hwihB4MLqR/hwcd09f39c.html',\r\n        auto: false,\r\n        width: 270,\r\n        height: 140,\r\n        maximizable: false,\r\n        title: '节点名称设置'\r\n    })\r\n    window.closeMenuNodeNameWindow = function() {\r\n        win.hide();\r\n    }\r\n    window.okMenuNodeNameWindow = function(text) {\r\n        \r\n        var c;\r\n        if (pid.indexOf(\"root\") == -1) {\r\n            c = ppid.childNodes;\r\n        } else {\r\n            c = ppid.childNodes;\r\n        }\r\n        if (checkSameName(c, text)) {\r\n            vmd.alert(\"提示\", \"该节点名称已存在，请重新设置！\");\r\n        } else {\r\n            var cnameisleaf = text;\r\n            var changeStore = true;\r\n            tree.addNode(pid, cid, cnameisleaf, changeStore);\r\n            win.hide();\r\n            var menuobj = treeNodesToString(tree);\r\n            if (menuobj && menuobj.length > 0) {\r\n                // menuID.setValue(Ext.encode(menuobj));\r\n                data = menuobj;\r\n                sheetHot.handleMenus('sets', Ext.encode(menuobj));\r\n            }\r\n        }\r\n    }\r\n    win.show()\r\n}\r\n\r\n//数据集点击刷新值\r\nfunction menuDataset_afterrender(sender) {\r\n    sender.el.dom.parentElement.onclick = function() {\r\n        var names = sheetHot.getDatasets();\r\n        if (names && names.length > 0) {\r\n            var nameSet = [];\r\n            for (var i = 0; i < names.length; i++) {\r\n                nameSet.push({\r\n                    name: names[i].name,\r\n                    value: names[i].name\r\n                })\r\n            }\r\n        }\r\n        if (nameSet) {\r\n            store.loadData(nameSet);\r\n        }\r\n    }\r\n}\r\n\r\nfunction menuID_beforerender(sender) {\r\n    sender.store = store1;\r\n    sender.displayField = 'name'\r\n    sender.valueField = 'value'\r\n}\r\n\r\nfunction nodeName_beforerender(sender) {\r\n    sender.store = store1;\r\n    sender.displayField = 'name'\r\n    sender.valueField = 'value'\r\n}\r\n\r\nfunction menuPID_beforerender(sender) {\r\n    sender.store = store1;\r\n    sender.displayField = 'name'\r\n    sender.valueField = 'value'\r\n}\r\n\r\nfunction menuID_selectChanged(sender, combo, record, index) {\r\n    sheetHot.handleMenus('id', record.data.name)\r\n}\r\n\r\nfunction nodeName_selectChanged(sender, combo, record, index) {\r\n    sheetHot.handleMenus('text', record.data.name)\r\n}\r\n\r\nfunction button1_click(sender, e) {\r\n    var sheetHot = parent.sheetHot;\r\n    var cell = sheetHot.dealInvert()[0];\r\n    if (cell.sr == cell.er && cell.sc == cell.ec) {\r\n        linkEvent.setValue(\"\")\r\n        sheetHot.changeAttributeInfo(cell.sr, cell.sc, 'linkEvent', '')\r\n    } else {\r\n        alert('请选择单一单元格设置')\r\n    }\r\n}\r\n\r\nfunction button2_click(sender, e) {\r\n    var sheetHot = parent.sheetHot;\r\n    var cell = sheetHot.dealInvert()[0];\r\n    if (cell.sr == cell.er && cell.sc == cell.ec) {\r\n        menuEvent.setValue(\"\")\r\n        sheetHot.changeAttributeInfo(cell.sr, cell.sc, 'menuEvent', '')\r\n    } else {\r\n        alert('请选择单一单元格设置')\r\n    }\r\n}\r\n\r\nfunction menuName_keyup(sender, e) {\r\n    sheetHot.handleMenus('name', sender.getValue());\r\n}\r\n\r\nfunction menuParam_keyup(sender,e){\r\nsheetHot.handleMenus('params',sender.getValue())\r\n}\r\n\r\nfunction LinkAndMenu_afterrender(sender){\r\n\r\n}","vmdcss":"","vmdprops":"\"\"","type":"ux","vmdevents_controller":"Ext.define('vmd.ux.linkAndMenu.Controller', {\n    xtype: 'vmd.ux.linkAndMenu.Controller',\n    constructor: function(options) {\n        \n    }\n})","vmdinterface":"{\"components\":[{\"cid\":\"vmduxprops\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmduxmethods\",\"id\":\"方法\",\"layoutConfig\":{},\"userConfig\":{},\"cn\":[{\"cid\":\"uxmethod\",\"id\":\"setInfo\",\"layoutConfig\":{},\"userConfig\":{\"id\":\"setInfo\",\"zhname\":\"\",\"bindCmp\":\"\",\"bindValue\":\"\",\"isPublic\":\"on\",\"desc\":\"\",\"uxcid\":\"\",\"params\":\"info\",\"code\":\"//直接填写方法内容\\nsetInfo(info);\",\"returnType\":\"\"}}]},{\"cid\":\"vmduxevents\",\"id\":\"事件\",\"layoutConfig\":{},\"userConfig\":{}}]}","vmdresource":"{\"components\":[{\"cid\":\"vmdrescsss\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdresjss\",\"layoutConfig\":{},\"userConfig\":{},\"cn\":[{\"cid\":\"resjs\",\"id\":\"controller.js\",\"layoutConfig\":{},\"userConfig\":{}}]},{\"cid\":\"vmdresimgs\",\"layoutConfig\":{},\"userConfig\":{}}]}"}