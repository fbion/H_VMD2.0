{"vmdversion":"vmd2.0.5.200306","vmdlayout":"{\"components\":[{\"cid\":\"uxpanel\",\"id\":\"ModuleInfo\",\"layoutConfig\":{},\"userConfig\":{\"layout\":\"absolute\",\"header\":false,\"width\":605,\"height\":590,\"autoScroll\":true},\"cn\":[{\"cid\":\"label\",\"id\":\"label\",\"layoutConfig\":{},\"userConfig\":{\"x\":60,\"y\":30,\"text\":\"模块基础信息\",\"style\":\"color: blue;    font-size: 20px;\"}},{\"cid\":\"label\",\"id\":\"label1\",\"layoutConfig\":{},\"userConfig\":{\"x\":60,\"y\":90,\"text\":\"模块编码：\"}},{\"cid\":\"label\",\"id\":\"label2\",\"layoutConfig\":{},\"userConfig\":{\"x\":60,\"y\":130,\"text\":\"模块名称：\"}},{\"cid\":\"label\",\"id\":\"label3\",\"layoutConfig\":{},\"userConfig\":{\"x\":60,\"y\":170,\"text\":\"创建人：\"}},{\"cid\":\"label\",\"id\":\"label4\",\"layoutConfig\":{},\"userConfig\":{\"x\":60,\"y\":210,\"text\":\"创建时间：\"}},{\"cid\":\"label\",\"id\":\"label5\",\"layoutConfig\":{},\"userConfig\":{\"x\":60,\"y\":250,\"text\":\"修改人：\"}},{\"cid\":\"label\",\"id\":\"label6\",\"layoutConfig\":{},\"userConfig\":{\"x\":60,\"y\":290,\"text\":\"修改时间：\"}},{\"cid\":\"label\",\"id\":\"label7\",\"layoutConfig\":{},\"userConfig\":{\"x\":60,\"y\":330,\"text\":\"路径：\"}},{\"cid\":\"label\",\"id\":\"label8\",\"layoutConfig\":{},\"userConfig\":{\"x\":60,\"y\":370,\"text\":\"说明：\"}},{\"cid\":\"textfield\",\"id\":\"hwText\",\"layoutConfig\":{},\"userConfig\":{\"x\":120,\"y\":90,\"width\":450,\"disabled\":true}},{\"cid\":\"textfield\",\"id\":\"hwText1\",\"layoutConfig\":{},\"userConfig\":{\"x\":120,\"y\":130,\"width\":450}},{\"cid\":\"textfield\",\"id\":\"hwText2\",\"layoutConfig\":{},\"userConfig\":{\"x\":120,\"y\":170,\"width\":450,\"disabled\":true}},{\"cid\":\"textfield\",\"id\":\"hwText3\",\"layoutConfig\":{},\"userConfig\":{\"x\":120,\"y\":210,\"width\":450,\"readOnly\":false,\"disabled\":true}},{\"cid\":\"textfield\",\"id\":\"hwText4\",\"layoutConfig\":{},\"userConfig\":{\"x\":120,\"y\":250,\"width\":450,\"disabled\":true}},{\"cid\":\"textfield\",\"id\":\"hwText5\",\"layoutConfig\":{},\"userConfig\":{\"x\":120,\"y\":290,\"width\":450,\"disabled\":true}},{\"cid\":\"textfield\",\"id\":\"hwText6\",\"layoutConfig\":{},\"userConfig\":{\"x\":120,\"y\":330,\"width\":450,\"disabled\":true}},{\"cid\":\"textarea\",\"id\":\"hwText7\",\"layoutConfig\":{},\"userConfig\":{\"x\":120,\"y\":370,\"width\":450,\"height\":80,\"id\":\"hwText7\"}},{\"cid\":\"vmdButton\",\"id\":\"button\",\"layoutConfig\":{},\"userConfig\":{\"x\":120,\"y\":470,\"text\":\"保存\",\"size\":\"large\",\"type\":\"info\",\"click\":\"button_click\"}},{\"cid\":\"vmdButton\",\"id\":\"button1\",\"layoutConfig\":{},\"userConfig\":{\"x\":240,\"y\":470,\"text\":\"设计\",\"size\":\"large\",\"type\":\"info\",\"click\":\"button1_click\"}},{\"cid\":\"vmdButton\",\"id\":\"button2\",\"layoutConfig\":{},\"userConfig\":{\"x\":360,\"y\":470,\"text\":\"预览\",\"size\":\"large\",\"type\":\"info\",\"click\":\"button2_click\"}},{\"cid\":\"vmdButton\",\"id\":\"button3\",\"layoutConfig\":{},\"userConfig\":{\"x\":480,\"y\":470,\"text\":\"注册\",\"size\":\"large\",\"type\":\"info\",\"click\":\"button3_click\"}},{\"cid\":\"vmdButton\",\"id\":\"button4\",\"layoutConfig\":{},\"userConfig\":{\"x\":480,\"y\":530,\"width\":80,\"text\":\"测试注册\",\"hidden\":true}}]}]}","vmdevents":"var hwTree;\n//创建遮罩层\nvar myMask;\nvar Selprojectid;\nvar selWorkspaceid;\n\nfunction refresh(tree, projectid, workspaceid) {\n    Selprojectid = projectid;\n    selWorkspaceid = workspaceid;\n    if (!tree) return;\n    hwTree = tree;\n    var tree = hwTree;\n    var newnode = tree.newnode;\n    if (newnode) {\n        hwText.setValue(newGuid(32));\n        hwText1.setValue(\"\");\n        hwText2.setValue(Ext.util.Cookies.get('userName'));\n        hwText3.setValue(Ext.Date.dateFormat(new Date(), 'Y-m-d H:i:s'));\n        hwText4.setValue(\"\");\n        hwText5.setValue(\"\");\n        hwText6.setValue(\"\");\n        hwText7.setValue(\"\");\n    } else {\n        var selId = tree.getSelectedItemId();\n        var selnode = tree.itemObj[selId];\n        hwText.setValue(selnode.code);\n        hwText1.setValue(selnode.text);\n        hwText2.setValue(selnode.createuser);\n        hwText3.setValue(selnode.createtime);\n        hwText4.setValue(selnode.changeuser);\n        hwText5.setValue(selnode.changetime);\n        hwText6.setValue(\"/modules\" + selnode.path + \".vmd\");\n        hwText7.setValue(selnode.remark);\n    }\n}\n\nfunction button_click(sender, e) {\n    if (!saveCheck()) {\n        return;\n    }\n    myMask = new Ext.LoadMask(Ext.getBody(), {\n        msg: \"加载中,请稍后...\"\n    });\n    myMask.show();\n    saveModelInfo(function() {\n        myMask.hide();\n        Ext.Msg.alert(\"提示\", \"保存成功！\")\n    })\n}\n/*保存前校验\nreturn:boolean  \n*/\nfunction saveCheck() {\n    if (hwText1.getValue() == \"\") {\n        Ext.Msg.alert(\"提示\", \"模块名称不能为空！\")\n        return false;\n    }\n    return true;\n}\n//模块保存按钮操作\nfunction saveModelInfo(callback) {\n    var mytree = hwTree;\n    var newnode = mytree.newnode;\n    var selId = mytree.getSelectedItemId();\n    var selnode = mytree.itemObj[selId];\n    var Project_id = Selprojectid;\n    var selnodepath = \"\";\n    var id = newGuid(10);\n    var category_id = selId;\n    if (!selnode) {\n        category_id = \"0\";\n        selId = \"0\";\n    } else if (selnode.isProject) {\n        category_id = \"0\";\n        Project_id = selId;\n        selnodepath = selnode.path\n    } else {\n        Project_id = selnode.projectId;\n        selnodepath = selnode.path\n    }\n    var codeid = hwText.getValue();\n    var name = hwText1.getValue();\n    var remark = hwText7.getValue();\n    var type = \"0\";\n    //var vmdpath = mytree.getp\n    //编辑\n    if (!newnode) {\n        category_id = mytree.getParentId(selId)\n    }\n    // 判断同一节点下是否存在相同名称的模块\n    checkReName(Project_id, category_id, selId, name, function() {\n        if (!newnode) {\n            hwText4.setValue(Ext.util.Cookies.get('userName'));\n            hwText5.setValue(Ext.Date.dateFormat(new Date(), 'Y-m-d H:i:s'))\n            //更新模块基础信息\n            hwDas.ajax({\n                das: {\n                    idedas: true\n                },\n                url: \"CDEServcie/module/info\",\n                type: 'put',\n                timeout: 5000,\n                params: {},\n                data: [{\n                    id: selId,\n                    code: selnode.code,\n                    type: type,\n                    name: name,\n                    remark: remark,\n                    project_id: Project_id,\n                    row_changed_by: hwText4.getValue(),\n                    row_changed_date: hwText5.getValue()\n                }],\n                success: function(result) {\n                    selnode.text = name;\n                    selnode.changetime = hwText5.getValue();\n                    selnode.changeuser = hwText4.getValue();\n                    selnode.remark = hwText7.getValue();\n                    mytree.setItemText(selId, name)\n                    hwDas.save(\"CDEServcie/module/file\", {}, {}, [{\n                            filepath: selnode.path,\n                            version: 1,\n                            module_id: selId\n                        }],\n                        function(result) {\n                            var s = new vmd.proxy.Log();\n                            s.save(\"模块基础信息\", selId, Ext.util.Cookies.get('userName') + \"在\" + Ext.Date.dateFormat(new Date(), 'Y-m-d H:i:s') + \"修改了模块\" + hwText1.getValue() + \"的基础信息\", \"模块\", function() {\n                                // alert(\"保存成功了！\")\n                            }, function() {\n                                console.log(\"日志报存失败了！\");\n                            })\n                            myMask.hide();\n                        },\n                        function(msg) {\n                            Ext.Msg.alert(\"提示\", \"保存模块版本信息失败\")\n                            myMask.hide();\n                            return;\n                        }\n                    )\n                    callback();\n                },\n                error: function(msg) {\n                    Ext.Msg.alert(\"提示\", \"保存模块基础信息失败\");\n                    myMask.hide();\n                    return;\n                }\n            })\n        } else {\n            //保存模块基础信息\n            hwDas.ajax({\n                das: {\n                    idedas: true\n                },\n                url: \"CDEServcie/module/info\",\n                type: 'post',\n                timeout: 5000,\n                params: {},\n                data: [{\n                    id: id,\n                    code: codeid,\n                    type: type,\n                    name: name,\n                    remark: remark,\n                    category_id: category_id,\n                    project_id: Project_id,\n                    row_created_by: hwText2.getValue(),\n                    row_created_date: hwText3.getValue(),\n                    row_changed_by: hwText4.getValue(),\n                    row_changed_date: hwText5.getValue()\n                }],\n                success: function(result) {\n                     var s = new vmd.proxy.Log();\n                    s.save(\"模块基础信息\", id, Ext.util.Cookies.get('userName') + \"在\" + Ext.Date.dateFormat(new Date(), 'Y-m-d H:i:s') + \"修改了模块\" + hwText1.getValue() + \"的基础信息\", \"模块\", function() {\n                        // alert(\"保存成功了！\")\n                    }, function() {\n                        console.log(\"日志报存失败了！\");\n                    })\n                    if (selId == '0') {\n                        mytree.insertNewChild(selId, id, name);\n                        mytree.setItemImage2(id, \"tree/model.png\", \"tree/model.png\", \"tree/model.png\")\n                    } else {\n                        if (mytree.itemObj[selId].loadChild == true) {\n                            mytree.insertNewChild(selId, id, name);\n                            mytree.setItemImage2(id, \"tree/model.png\", \"tree/model.png\", \"tree/model.png\")\n                        }\n                    }\n                    var treenode = mytree.item(id);\n                    if (!selnode) {\n                        treenode.path = \"/\" + Project_id + \"/\" + id;\n                    } else {\n                        treenode.path = selnodepath + \"/\" + id;\n                    }\n                    treenode.projectId = Project_id;\n                    if (treenode) {\n                        treenode.isModel = true;\n                        treenode.text = name;\n                        treenode.createuser = hwText2.getValue();\n                        treenode.createtime = hwText3.getValue();\n                        treenode.changetime = hwText5.getValue();\n                        treenode.changeuser = hwText4.getValue();\n                        treenode.remark = remark;\n                        treenode.code = codeid\n                        treenode.newnode = true;\n                    }\n                    mytree.itemObj[id] = treenode;\n                    mytree.selectItem(id, false, false);\n                    mytree.newnode = false;\n                    //保存模块路径版本信息\n                    hwDas.ajax({\n                        das: {\n                            idedas: true\n                        },\n                        url: \"CDEServcie/module/file\",\n                        type: 'post',\n                        timeout: 5000,\n                        params: {},\n                        data: [{\n                            filepath: selnodepath + \"/\" + id,\n                            version: 1,\n                            module_id: id\n                        }],\n                        success: function(result) {\n                            myMask.hide();\n                            // Ext.Msg.alert(\"提示\", \"保存成功！\")\n                        },\n                        error: function(msg) {\n                            Ext.Msg.alert(\"提示\", \"保存模块版本信息失败\")\n                            myMask.hide();\n                            return;\n                        }\n                    })\n                    callback();\n                },\n                error: function(msg) {\n                    Ext.Msg.alert(\"提示\", \"保存模块基础信息失败\")\n                    myMask.hide();\n                    return;\n                }\n            })\n        }\n    })\n}\n\nfunction getNodePath(selnode) {\n    if (selnode) {\n        var selModPath = 'modules' + selnode.path;\n        //如果是框架项目 则添加system\n        if (btnProjectName.projectId == \"eQ9ULgcVb1\") {\n            selModPath = 'system/' + selModPath\n        }\n        return selModPath;\n    } else\n        return \"\";\n}\n\nfunction button1_click(sender, e) {\n    var mytree = hwTree;\n    var selId = mytree.getSelectedItemId();\n    var selnode = mytree.itemObj[selId];\n    myMask = new Ext.LoadMask(Ext.getBody(), {\n        msg: \"加载中,请稍后...\"\n    });\n    var selModPath = getNodePath(selnode)\n    myMask.show();\n    if (selnode) {\n        if (selnode.newnode || mytree.newnode) {\n            if (!saveCheck()) {\n                myMask.hide();\n                return;\n            }\n            saveModelInfo(function() {\n                myMask.hide();\n                selId = mytree.getSelectedItemId();\n                selnode = mytree.itemObj[selId];\n                selModPath = getNodePath(selnode)\n                openSelMode(selnode.id, selnode.text, selModPath + '.vmd', selWorkspaceid);\n            })\n        } else {\n            if (!saveCheck()) {\n                myMask.hide();\n                return;\n            }\n            selId = mytree.getSelectedItemId();\n            selnode = mytree.itemObj[selId];\n            selModPath = getNodePath(selnode)\n            vmd.isCheckFileExist(selModPath + '.vmd', function(data) {\n                myMask.hide();\n                if (data) {\n                    var params = {\n                        id: selnode.id,\n                        name: selnode.text,\n                        path: selModPath + '.vmd',\n                        workspaceid: selWorkspaceid\n                    }\n                    var url = vmd.virtualPath + '/design/default.html?' + Ext.urlEncode(params);\n                    var name = selnode.text + \" 模块设计\"\n                    if (vmd.isIE9 || vmd.isIE8 || vmd.isIE7 || vmd.isIE6) {\n                        window.open(url)\n                    } else {\n                        window.open(url, name)\n                    }\n                } else {\n                    openSelMode(selnode.id, selnode.text, selModPath + '.vmd', selWorkspaceid);\n                }\n            }, true);\n        }\n    } else {\n        if (!saveCheck()) {\n            myMask.hide();\n            return;\n        }\n        saveModelInfo(function() {\n            myMask.hide();\n            selId = mytree.getSelectedItemId();\n            selnode = mytree.itemObj[selId];\n            selModPath = getNodePath(selnode)\n            openSelMode(selnode.id, selnode.text, selModPath + '.vmd', selWorkspaceid);\n        })\n    }\n}\n\nfunction button2_click(sender, e) {\n    var mytree = hwTree;\n    var selId = mytree.getSelectedItemId();\n    var selnode = mytree.itemObj[selId];\n    if (!selnode.isModel)\n        return\n    var params = \"\";\n    if (vmd.EnvVars) {\n        for (var i in vmd.EnvVars) {\n            params += i + \"=\" + vmd.EnvVars[i] + \"&\"\n        }\n    }\n    var url = vmd.virtualPath + '/modules' + selnode.path + '.html?' + params + 'r=' + new Date().getTime();\n    //如果是框架项目 则添加system\n    if (btnProjectName.projectId == \"eQ9ULgcVb1\") {\n        url = vmd.virtualPath + '/system/modules' + selnode.path + '.html?' + params + 'r=' + new Date().getTime();\n    }\n    window.open(url, selnode.text);\n}\n//自定义自定义方法\nfunction newGuid(len) {\n    var length = 32;\n    if (len)\n        length = len - 2\n    var guid = \"\";\n    for (var i = 1; i <= length; i++) {\n        var n = Math.floor(Math.random() * 16.0).toString(16);\n        guid += n;\n    }\n    return \"hw\" + guid;\n}\n\nfunction button3_click(sender, e) {\n    var html = \"<iframe src='\" + vmd.virtualPath + \"/system/modules/eQ9ULgcVb1/eQ9ULgcVb5/hw0cb5518a.html?workspaceid=\" + selWorkspaceid + \"&r=\" + new Date().getTime() + \"' frameborder=0 scrolling=no style='height:100%;width:100%'></iframe>\";\n    var win = openWin({\n        title: \"模块注册发布\",\n        modal: true,\n        maximized: false,\n        height: 500,\n        width: 600,\n        maximizable: true,\n        resizable: true,\n        bodyStyle: \"background-color:#fff\",\n        closeAction: 'close'\n    }, html)\n}\n\nfunction checkReName(projectId, pId, id, name, callback) {\n    var isRep = false;\n    hwDas.ajax({\n        das: {\n            idedas: true\n        },\n        url: \"CDEServcie/module/info\",\n        type: 'get',\n        timeout: 5000,\n        params: {\n            category_id: pId,\n            project_id: projectId\n        },\n        success: function(result) {\n            var datajson = result.data[0].datas;\n            for (var i = 0; i < datajson.length; i++) {\n                if (datajson[i].name == name && datajson[i].id != id) {\n                    isRep = true;\n                    break\n                }\n            }\n            if (isRep) {\n                myMask.hide();\n                Ext.Msg.alert('提示', '此模版名称已存在');\n            } else {\n                callback()\n            }\n        },\n        error: function(msg) {\n            myMask.hide();\n            Ext.Msg.alert(\"提示\", \"获取模块信息失败\")\n        }\n    })\n}","vmdcss":"","vmdprops":"\"\"","type":"ux","vmdcmpdeps":[],"vmdevents_controller":"Ext.define('vmd.ux.moduleInfo.Controller', {\n    xtype: 'vmd.ux.moduleInfo.Controller',\n    constructor: function(options) {\n        \n    }\n})","vmdinterface":"{\"components\":[{\"cid\":\"vmduxprops\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmduxmethods\",\"id\":\"方法\",\"layoutConfig\":{},\"userConfig\":{},\"cn\":[{\"cid\":\"uxmethod\",\"id\":\"refresh\",\"layoutConfig\":{},\"userConfig\":{\"id\":\"refresh\",\"zhname\":\"\",\"bindCmp\":\"\",\"bindValue\":\"\",\"isPublic\":\"on\",\"desc\":\"\",\"uxcid\":\"\",\"params\":\"tree,projectid,workspaceid\",\"code\":\"//直接填写方法内容\\n\\nrefresh(tree,projectid,workspaceid)\",\"returnType\":\"\"}}]},{\"cid\":\"vmduxevents\",\"id\":\"事件\",\"layoutConfig\":{},\"userConfig\":{}}]}","vmdresource":"{\"components\":[{\"cid\":\"vmdrescsss\",\"layoutConfig\":{},\"userConfig\":{}},{\"cid\":\"vmdresjss\",\"layoutConfig\":{},\"userConfig\":{},\"cn\":[{\"cid\":\"resjs\",\"id\":\"controller.js\",\"layoutConfig\":{},\"userConfig\":{}}]},{\"cid\":\"vmdresimgs\",\"layoutConfig\":{},\"userConfig\":{}}]}"}